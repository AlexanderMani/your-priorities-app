<polymer-element name="ideas-page" extends="base-page">
  <template bind>
    <link rel="stylesheet" href="ideas-page.css">

    <core-ajax
      auto="false"
      id="ideasAjax"
      url=""
      response="{{ideasResponse}}"
      handleAs="json">
    </core-ajax>

    <core-ajax
            auto="false"
            id="categoryAjax"
            url="/api/groups/{{groupId}}/categories"
            response="{{categoriesResponse}}"
            handleAs="json">
    </core-ajax>

    <core-ajax
            auto="false"
            id="categoryDefaultAjax"
            url="/api/groups/default/categories"
            response="{{categoriesResponse}}"
            handleAs="json">
    </core-ajax>

    <base-layout id="layout" selected="ideas" filter="{{filter}}" groupName="{{groupName}}" groupId="{{groupId}}" showLogo="true" categoryId="{{idea.Category.id}}"
                 categories="{{categories}}" ideasFilter="true" name="{{groupName}}">
      <div class="card-container">
        <template repeat="{{ideas as idea}}">
          <paper-shadow class="card" z="1" center-center layout>
            <yrpri-idea idea="{{idea}}" showCategory="true" small="true"></yrpri-idea>
          </paper-shadow>
        </template>
        <a href="/add" on-click="{{navigate}}">
          <paper-fab icon="add" z="1" class="createIdea" title="{{'ideas.add_new' | t}}" on-tap="{{newIdea}}"></paper-fab>
        </a>
      </div>
    </base-layout>
  </template>

  <script>

    Polymer({

      ideas: [],
      categories: [],
      defaultCategories: false,

      newIdea: function () {
        window.globals.activity("Anonymous","open","newIdea");
        window.globals.openDialog("ideas.add_new");
      },

      domReady: function () {
        if (this.filter) {
          window.selectedFilter = this.filter;
        }
        this.$.layout.setSpinner(true);
        this.$.ideasAjax.url = "/api/groups/"+this.groupId+"/ideas/"+window.selectedFilter;
        if (this.categoryId) {
          this.$.ideasAjax.url += "/"+this.categoryId;
        }
        this.$.ideasAjax.go();
        this.$.categoryAjax.go();
      },

      ideasResponseChanged: function (e, detail, sender) {
        this.$.layout.setSpinner(false);
        this.ideas = detail;
      },

      categoriesResponseChanged: function (e, detail, sender) {
        if (detail && detail.length==0 && !this.defaultCategories) {
          this.defaultCategories = true;
          this.$.categoryDefaultAjax.go();
        } else if (detail!=null) {
          this.categories = detail;
          if (this.categoryId) {
            for (var i = 0; i < this.categories.length; i++) {
              if (this.categories[i].id == this.categoryId) {
                window.selectedCategoryName = this.categories[i].name;
                this.$.layout.updateFilter();
              }
            }
          } else {
            window.selectedCategoryName = "categories.all";
            this.$.layout.updateFilter();
          }
        }
      }
    });
  </script>
</polymer-element>
