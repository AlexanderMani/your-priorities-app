<dom-module id="yp-idea-header">

  <template>

    <div layout="" flex="" horizontal$="[[!small]]">
      <div layout="" style="vertical-align: top;width:100%;">
        <div layout="" horizontal="" around-justified="" flex="">
          <template is="dom-if" if="[[showCategory]]">
            <div>
              <iron-image class="category" src="[[computeSrc(idea)]]">

            </iron-image></div>
          </template>
          <div flex="" class="header" on-tap="goToIdea" layout="" vertical="">
            <div>
              <b>[[computeExpression1(idea, small)]]</b>
            </div>
            <template is="dom-if" if="[[showName]]">
              <div class="userScreenname">
                <span>[[idea.User.login]]</span>
              </div>
            </template>
            <template is="dom-if" if="[[computeIf(showCategory, small)]]">
              <div class="categoryName">
                <span>[[idea.Category.name]]</span>
              </div>
            </template>

          </div>
          <template is="dom-if" if="[[!small]]">
            <div flex="" style="">
              <idea-action-bar idea="[[idea]]" small="[[small]]" flex="" style="float:right; clear:right;"></idea-action-bar>
            </div>
            <paper-icon-button icon="report" on-tap="report" style="color:#eee;"></paper-icon-button>
            <paper-icon-button class="share" on-tap="notify" style="color:#b0b0b0;" icon="image:remove-red-eye"></paper-icon-button>
            <paper-icon-button class="share" on-tap="share" icon="social:share"></paper-icon-button>
            <template is="dom-if" if="[[computeIf2()]]">
              <paper-menu-button class="selected-items" layout="" horizontal="">
                <paper-icon-button icon="more-vert"></paper-icon-button>
                <iron-dropdown class="dropdown" horizontal-align="right">
                  <div class="separator">Admin</div>
                  <paper-item>Breyta</paper-item>
                  <paper-item>Staða</paper-item>
                  <paper-item>Eyða</paper-item>
                </iron-dropdown>
              </paper-menu-button>
            </template>
          </template>
        </div>

        <div layout="" class="description">
          <template is="dom-if" if="[[idea.IdeaRevision[0]]]">
            <span>[[computeExpression4(idea, small)]]</span>
          </template>
          <template is="dom-if" if="[[idea.description]]">
            <span>[[computeExpression5(idea, small)]]</span>
          </template>
          <template is="dom-if" if="[[!idea.description]]">
            <span>[[computeExpression6(idea, small)]]</span>
          </template>
        </div>
        <template is="dom-if" if="[[small]]">
          <idea-action-bar idea="[[idea]]" small="[[small]]" style=""></idea-action-bar>
        </template>
        <template is="dom-if" if="[[!small]]">
          <paper-spinner id="spinner" style="padding-top:4px;display:block;" active=""></paper-spinner>

        </template>
      </div>
    </div>

    <template is="dom-if" if="[[!small]]">
      <iron-ajax auto="true" id="endorsementAjax" url="[[computeUrl(idea)]]" last-response="[[response]]" handle-as="json">
      </iron-ajax>
    </template>
  </template>
  <script>
    Polymer({

      is: 'yp-idea-header',

      properties: {

        endorsements: {
          type: Array,

          value: function () {
            return [];
          }
        },

        idea: {
          notify: true
        },

        response: {
          observer: 'responseChanged'
        },

        showCategory: {
          notify: true
        },

        showName: {
          notify: true
        },

        userImagesLimit: {
          type: Number,
          value: 42,
          notify: true
        }
      },

      share: function () {
        window.globals.activity('Anonymous', 'open', 'ideaShare');
        window.globals.openDialog('ideas.share');
      },

      report: function () {
        window.globals.activity('Anonymous', 'open', 'ideaReport');
        window.globals.openDialog('ideas.report');
      },

      notify: function () {
        window.globals.activity('Anonymous', 'open', 'ideaNotify');
        window.globals.openDialog('ideas.notify');
      },

      allEndorsementsLength: function (idea) {
        return this.endorsements.length;
      },

      countUserImagesLeft: function (e) {
        return this.allEndorsementsLength(this.idea) - this.userImagesLimit;
      },

      responseChanged: function (detail, e, sender) {
        this.$.spinner.active = false;
        this.$.spinner.style.display = 'none';
        this.endorsements = detail;
        if (this.endorsements.length > this.userImagesLimit) {
          this.$$.moreImages.style.display = 'inline';
        }
      },

      moreUserImages: function () {
        this.$.moreImagesButton.style.display = 'none';
        this.$.numberOfMoreUserImages.style.display = 'none';
        this.$.restOfUserImages.style.display = 'inline';
      },

      goToIdea: function (e) {
        var ideaUrl = '/#/ideas/' + this.idea.id;
        window.globals.activity('Anonymous', 'open', 'idea', ideaUrl);
        window.location = ideaUrl;
      },

      computeIf: function (showCategory, small) {
        return showCategory && !small;
      },

      computeSrc: function (idea) {
        return 'https://s3.amazonaws.com/' + this.s3bucketName('') + '/categories/icons/000/000/' + this.padNumber(idea.Category.id) + '/icon_50/' + idea.Category.icon_file_name;
      },

      computeIf2: function () {
        return false;
      },

      computeUrl: function (idea) {
        return '/api/ideas/' + idea.id + '/endorsements';
      },

      computeExpression1: function (idea, small) {
        return this.truncate(this.trim(idea.name), small ? 60 : 200);
      },

      computeExpression4: function (idea, small) {
        return this.truncate(this.trim(idea.IdeaRevision[0].description), small ? 200 : 10000, '...');
      },

      computeExpression5: function (idea, small) {
        return this.truncate(this.trim(idea.description), small ? 200 : 10000, '...');
      },

      computeExpression6: function (idea, small) {
        return this.truncate(this.trim(idea.Points[0].content), small ? 200 : 10000, '...');
      },

      userImagesCount: function () {
        return this.countUserImagesLeft(0);
      }
    });
  </script>
</dom-module>
