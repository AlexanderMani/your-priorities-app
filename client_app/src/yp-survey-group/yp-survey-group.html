<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../yp-app-globals/yp-app-icons.html">
<link rel="import" href="../yp-behaviors/yp-language-behavior.html">
<link rel="import" href="../yp-behaviors/yp-detect-old-ios.html">

<link rel="import" href="../yp-ajax/yp-ajax.html">

<link rel="import" href="../yp-theme/yp-theme-behavior.html">
<link rel="import" href="../yp-behaviors/yp-number-format-behavior.html">

<dom-module id="yp-survey-group">
  <template>
    <style>
      [hidden] {
        display: none !important;
      }

      #submitButton {
        margin-top: 16px;
      }

      .submitSpinnerContainer {
        height: 90px;
      }
    </style>

    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>

    <iron-media-query query="(min-width: 1024px)" query-matches="{{wideWidth}}"></iron-media-query>
    <iron-media-query query="(max-width: 700px)" query-matches="{{phoneWidth}}"></iron-media-query>

    <app-route
      route="{{idRoute}}"
      pattern="/:id"
      data="{{idRouteData}}"
      tail="{{tabRoute}}">
    </app-route>

    <app-route
      route="{{tabRoute}}"
      pattern="/:tabName"
      data="{{tabRouteData}}"
      tail="{{listRoute}}">
    </app-route>

    <template is="dom-if" if="[[!surveyCompleted]]">
      <template is="dom-if" if="[[structuredQuestions]]">
        <template is="dom-repeat" items="[[structuredQuestions]]" as="question">
          <yp-structured-question-edit index="[[index]]"
                                       on-changed="_saveState"
                                       question="[[question]]"
                                       on-hide-to-question="_hideToQuestion">
          </yp-structured-question-edit>
        </template>

        <div class="layout horizontal center-center submitSpinnerContainer">
          <yp-ajax large-spinner id="submitAjax" method="POST" on-response="_surveySubmitResponse"></yp-ajax>
        </div>
        <div class="layout horizontal center-center">
          <paper-button id="submitButton" raised on-tap="_submit">[[t('submitSurvey')]]</paper-button>
        </div>
      </template>
    </template>

    <template is="dom-if" if="[[surveyCompleted]]">
      <div class="surveyCompleted">
        <template is="dom-if" if="[[group.configuration.customThankYouTextNewPosts]]">
          <yp-magic-text id="customThankYouTextNewPostsId" hidden content-id="[[group.id]]" text-only content="[[group.configuration.customThankYouTextNewPosts]]"
                         content-language="[[group.language]]"
                         text-type="customThankYouTextNewPosts"></yp-magic-text>
        </template>
        <template is="dom-if" if="[[group.configuration.customThankYouTextNewPosts]]">
          [[t('thankYouForCompletingTheSurvey')]]
        </template>
      </div>
    </template>

    <div class="layout horizontal center-center">
      <yp-ajax large-spinner id="ajax" on-response="_surveyGroupResponse"></yp-ajax>
    </div>

  </template>

  <script>
    Polymer({

      is: 'yp-survey-group',

      behaviors: [
        Polymer.ypLanguageBehavior,
        Polymer.ypThemeBehavior,
        Polymer.ypDetectOldiOs,
        Polymer.ypNumberFormatBehavior
      ],

      properties: {

        idRoute: Object,
        tabRoute: Object,
        idRouteData: Object,
        tabRouteData: Object,

        surveyGroupId: {
          type: Number,
          observer: "_surveyGroupIdChanged"
        },

        surveySubmitError: {
          type: String,
          value: null
        },

        surveyCompleted: {
          type: Boolean,
          value: false
        },

        surveyGroup: {
          type: Object,
          value: null
        },

        structuredQuestions: {
          type: Array,
          value: []
        },

        structuredAnswers: {
          type: Array,
          value: null
        }
      },

      observers: [
        '_routeIdChanged(idRouteData.id)'
      ],

      _serializeAnswers: function () {
        var answers = [];
        this.structuredQuestions.forEach(function (questionData, index) {
          var questionElement = this.$$("#structuredQuestion_"+index);
          if (questionElement) {
            var question = questionElement.question;
            if (question.isRadios) {
              answers.push(this._getSelectedRadios(questionElement));
            } else if (questions.isCheckboxes) {
              answers.push(this._getSelectedCheckboxes(questionElement));
            } else if (questions.isDropdown) {
              answers.push(this._getSelectedDropdown(questionElement));
            } else if (questions.isText) {
              answers.push({uniqueId: question.uniqueId, value: questionElement.value});
            }
          }
        }).bind(this);
        this.structuredAnswers = answers;
      },

      _deserializeAnswers: function () {
        var answersHash = {};
        this.structuredAnswers.forEach(function (answer) {
          answersHash[answer.uniqueId]=answer;
        }).bind(this);

        this.structuredQuestions.forEach(function (questionData, index) {
          var questionElement = this.$$("#structuredQuestion_"+index);
          if (questionElement) {
            var question = questionElement.question;
            var answer = answersHash[question.uniqueId];
            if (answer) {
              if (question.isRadios) {
                this._setSelectedRadios(questionElement, answer);
              } else if (questions.isCheckboxes) {
                this._setSelectedCheckboxes(questionElement, answer);
              } else if (questions.isDropdown) {
                this._setSelectedDropdown(questionElement, answer);
              } else if (questions.isText) {
                questionElement.value = answer.value;
              }
            } else {
              console.warn("No answer for question, maybe questions have been updated");
            }
          }
        }).bind(this);
      },

      _surveySubmitResponse: function (event, detail) {
        if (detail.error) {
          this.set('surveySubmitError', detail.error);
        } else {
          this.set('surveyCompleted', true)
        }
      },

      _submit: function () {
        this._serializeAnswers();
        var submitAjax = this.$$("#submitAjax");
        submitAjax.url = "/group/"+this.surveyGroup.id+"/survey";
        submitAjax.body = this.structuredAnswers;
        submitAjax.generateRequest();
      },

      _saveState: function () {
        this._serializeAnswers();
        localStorage.setItem("yp-survey-response-for-"+this.surveyGroup.id, JSON.stringify(this.structuredAnswers));
      },

      _clearState: function () {
        localStorage.setItem("yp-survey-response-for-"+this.surveyGroup.id, null);
      },

      _checkAndLoadState: function () {
        var answers =  localStorage.getItem("yp-survey-response-for-"+this.surveyGroup.id);
        if (answers){
          this.structuredAnswers = JSON.parse(answers);
          this._deserializeAnswers();
        }
      },

      _hideToQuestion: function (event, detail) {

      },

      _isIpad: function () {
        return /iPad/.test(navigator.userAgent) && !window.MSStream;
      },

      _routeIdChanged: function (newId) {
        if (newId) {
          this.set('surveyGroupId', newId);
        }
      },

      _surveyGroupIdChanged: function (groupId) {
        if (groupId) {
          this.set('surveyGroup', null);
          this._getSurveyGroup();
        }
      },

      _getSurveyGroup: function () {
        this.$.ajax.url = '/api/groups/' + this.surveyGroupId + '/survey';
        this.$.ajax.retryMethodAfter401Login = this._getSurveyGroup.bind(this);
        this.$.ajax.generateRequest();
      },

      _pagesResponse: function (event, detail) {
        this.fire('yp-set-pages', detail.response);
      },

      _surveyGroupResponse: function (event, detail) {
        this.set('surveyGroup', detail.response.surveyGroup);
        this.set('structuredQuestions', detail.response.surveyGroup.structuredQuestions);
        this.set('surveyGroup.configuration', window.appGlobals.overrideGroupConfigIfNeeded(this.surveyGroup.id, this.surveyGroup.configuration));
        this.refresh();
      },

      _useHardBack: function (configuration) {
        if (configuration && configuration.customBackURL) {
          var backUrl = configuration.customBackURL;
          if (backUrl.startsWith("/community/") ||
            backUrl.startsWith("/group/") ||
            backUrl.startsWith("/domain/") ||
            backUrl.startsWith("/post/")) {
            return false;
          } else {
            return true;
          }
        } else {
          return false;
        }
      },

      refresh: function () {
        if (this.surveyGroup) {
          this.fire('yp-set-home-link', {
            type: 'group',
            id: this.surveyGroup.id,
            name: this.surveyGroup.name
          });

          if (this.surveyGroup.configuration.defaultLocale!=null) {
            window.appGlobals.changeLocaleIfNeeded(this.surveyGroup.configuration.defaultLocale);
          }

          window.appGlobals.setCommunityAnalyticsTracker(this.surveyGroup.Community.google_analytics_code);

          if (this.surveyGroup.theme_id!=null ||
             (this.surveyGroup.configuration && this.surveyGroup.configuration.themeOverrideColorPrimary!=null)) {
            this.setTheme(this.surveyGroup.theme_id, this.surveyGroup.configuration);
          } else if (this.surveyGroup.Community &&
                    (this.surveyGroup.Community.theme_id!=null ||
                      (this.surveyGroup.Community.configuration && this.surveyGroup.Community.configuration.themeOverrideColorPrimary))) {
            this.setTheme(this.surveyGroup.Community.theme_id, this.surveyGroup.Community.configuration);
          } else if (this.surveyGroup.Community && this.surveyGroup.Community.Domain && this.surveyGroup.Community.Domain.theme_id!=null) {
            this.setTheme(this.surveyGroup.Community.Domain.theme_id);
          } else {
            this.setTheme(1);
          }

          if (this.surveyGroup.configuration.useCommunityTopBanner &&
            this.surveyGroup.Community.CommunityHeaderImages &&
            this.surveyGroup.Community.CommunityHeaderImages.length>0) {
            this.setupTopHeaderImage(this.surveyGroup.Community.CommunityHeaderImages);
          } else if (this.surveyGroup.GroupHeaderImages && this.surveyGroup.GroupHeaderImages.length>0) {
            this.setupTopHeaderImage(this.surveyGroup.GroupHeaderImages);
          } else {
            this.setupTopHeaderImage(null);
          }

          this.fire("change-header", {
            headerTitle: this.surveyGroup.configuration.customBackName ?
                           this.surveyGroup.configuration.customBackName :
                           this.surveyGroup.Community.name,
            headerDescription: this.surveyGroup.Community.description,
            headerIcon: "social:group",
            documentTitle: this.surveyGroup.name,
            enableSearch: true,
            hideHelpIcon: this.surveyGroup.configuration.hideHelpIcon ? true : null,
            useHardBack: this._useHardBack(this.surveyGroup.configuration),
            backPath:  this.surveyGroup.configuration.customBackURL ?
                         this.surveyGroup.configuration.customBackURL :
                         "/community/" + this.surveyGroup.community_id
          });

          this.$.pagesAjax.url = "/api/groups/"+this.surveyGroup.id+"/pages";
          this.$.pagesAjax.generateRequest();

          window.appGlobals.setAnonymousGroupStatus(this.surveyGroup);

          if (this.surveyGroup.configuration && this.surveyGroup.configuration.disableFacebookLoginForGroup===true) {
            window.appGlobals.disableFacebookLoginForGroup = true;
          } else {
            window.appGlobals.disableFacebookLoginForGroup = false;
          }

          if (this.surveyGroup.configuration && this.surveyGroup.configuration.externalGoalTriggerUrl) {
            window.appGlobals.externalGoalTriggerGroupId = this.surveyGroup.id;
          } else {
            window.appGlobals.externalGoalTriggerGroupId = null;
          }

          if (this.surveyGroup.Community && this.surveyGroup.Community.configuration && this.surveyGroup.Community.configuration.signupTermsPageId &&
            this.surveyGroup.Community.configuration.signupTermsPageId!=-1) {
            window.appGlobals.signupTermsPageId = this.surveyGroup.Community.configuration.signupTermsPageId;
          } else {
            window.appGlobals.signupTermsPageId = null;
          }

          if (this.surveyGroup.Community && this.surveyGroup.Community.configuration && this.surveyGroup.Community.configuration.customSamlDeniedMessage) {
            window.appGlobals.currentSamlDeniedMessage = this.surveyGroup.Community.configuration.customSamlDeniedMessage;
          } else {
            window.appGlobals.currentSamlDeniedMessage = null;
          }

          if (this.surveyGroup.Community.configuration && this.surveyGroup.Community.configuration.customSamlLoginMessage) {
            window.appGlobals.currentSamlLoginMessage = this.surveyGroup.Community.configuration.customSamlLoginMessage;
          } else {
            window.appGlobals.currentSamlLoginMessage = null;
          }

          window.appGlobals.currentGroup = this.surveyGroup;

          if ((this.surveyGroup.configuration &&
               this.surveyGroup.configuration.forceSecureSamlLogin &&
               !this.checkGroupAccess(this.surveyGroup)) ||
             (this.surveyGroup.Community &&
              this.surveyGroup.Community.configuration &&
              this.surveyGroup.Community.configuration.forceSecureSamlLogin &&
              !this.checkCommunityAccess(this.surveyGroup.Community))) {
            window.appGlobals.currentForceSaml = true;
          } else {
            window.appGlobals.currentForceSaml = false;
          }
        }
      }
    });
  </script>
</dom-module>
