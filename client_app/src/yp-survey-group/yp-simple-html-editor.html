<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../yp-behaviors/yp-language-behavior.html">

<dom-module id="yp-simple-html-editor">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: inline-block;
        margin-top: 8px;
        width: 100%;
      }

      #htmlEditor {
        width: 100%;
        height: 300px;
        border-top: 1px solid #cccccc;
        border-bottom: 1px solid #888888;
        outline: none;
        overflow: auto;
        padding-top: 8px;
        padding-bottom: 8px;
        transition: border-bottom-color 0.1s;
        -webkit-user-select: text;
        user-select: text;
      }

      #htmlEditor:focus {
        border-bottom: 2px solid var(--accent-color);
      }

      .characterCounter {
        color: #212121;
        font-size: 12px;
        text-align: right;
        width: 100%;
        transition: color 0.1s;
        margin-top: 1px;
      }

      .characterCounter[has-focus] {
          color: var(--accent-color);
          margin-top: 0px;
      }

      @media (max-width: 800px) {
        #htmlEditor {
            height: 220px;
        }
      }

      paper-icon-button {
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
      }
    </style>
    <div class="layout horizontal wrap">
      <div class="layout horizontal">
        <paper-icon-button aria-label$="[[t('formatBold')]]" icon="format-bold" on-tap="_toggleBold"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatItalic')]]" icon="format-italic" on-tap="_toggleItalic"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatUnderline')]]" icon="format-underlined" on-tap="_toggleUnderline"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatListBullets')]]" icon="format-list-bulleted" on-tap="_toggleListBullets"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatListNumbered')]]" icon="format-list-numbered" on-tap="_toggleListNumbers"></paper-icon-button>
      </div>
      <div class="layout horizontal">
        <paper-icon-button aria-label$="[[t('formatLeft')]]" icon="format-align-left" on-tap="_toggleAlignLeft"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatCenter')]]" icon="format-align-center" on-tap="_toggleAlignCenter"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatRight')]]" icon="format-align-right" on-tap="_toggleAlignRight"></paper-icon-button>
        <paper-icon-button hidden aria-label$="[[t('formatJustify')]]" icon="format-align-justify" on-tap="_toggleAlignJustify"></paper-icon-button>
      </div>

      <div class="layout horizontal">
        <paper-icon-button aria-label$="[[t('formatH1')]]" icon="format-header-1" on-tap="_toggleH1"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatH2')]]" icon="format-header-2" on-tap="_toggleH2"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatH3')]]" icon="format-header-3" on-tap="_toggleH3"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatH4')]]" icon="format-header-4" on-tap="_toggleH4"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatH5')]]" icon="format-header-5" on-tap="_toggleH5"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatH6')]]" icon="format-header-6" on-tap="_toggleH6"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatP')]]" icon="format-paragraph" on-tap="_toggleP"></paper-icon-button>
        <paper-icon-button aria-label$="[[t('formatClear')]]" icon="format-clear" on-tap="_clearFormat"></paper-icon-button>
      </div>
    </div>
    <div id="htmlEditor" on-focus="_setFocus" on-blur="_setBlur" contenteditable="true" spellcheck="false" on-keydown="_keydown" on-paste="_paste" on-click="_changed" on-keyup="_changed" on-changed="_changed"></div>
    <div has-focus$="[[hasFocus]]" class="layout end characterCounter">[[characterCount]]<span hidden$="[[!question.maxLength]]">/[[question.maxLength]]</span></div>
  </template>
  <script>

    class YpSimpleHtmlEditor extends Polymer.Element {
      static get is() {
        return 'yp-simple-html-editor';
      }

      _setFocus() {
        this.set('hasFocus', true);
      }

      _setBlur() {
        //TODO: Fix blinking on using the icon buttons
        this.set('hasFocus', false);
      }

      static get properties() {
        return {
          question: {
            type: Object,
            observer: '_questionChanged'
          },

          index: {
            type: Number
          },

          language: {
            type: String,
          },

          useSmallFont: {
            type: Boolean,
            value: false
          },

          value: {
            type: String,
            value: ""
          },

          characterCount: {
            type: Number,
            value: 0
          },

          hasFocus: {
            type: Boolean,
            value: false
          }
        }
      }

      setRichValue(value) {
        this.set('value', value);
        this.shadowRoot.querySelector("#htmlEditor").innerHTML = this.value;
      }

      _updateCharacterCounter() {
        var textContent = this.shadowRoot.querySelector("#htmlEditor").textContent;

        if (textContent) {
          this.set('characterCount', textContent.length);
        } else {
          this.set('characterCount', 0);
        }
      }

      _keydown(event) {
        this._updateCharacterCounter();

        if (this.question.maxLength) {
          var allowedKeyCodes = [8, 37, 38, 39, 40];
          var allowedKeyCodesWithCtrlKey = [65, 90, 86, 67, 88, 8];
          var isAllowedKey = allowedKeyCodes.includes(event.keyCode);
          var isShortcut = event.ctrlKey && allowedKeyCodesWithCtrlKey.includes(event.keyCode);
          var isAllowedAction = isAllowedKey || isShortcut;

          if (isAllowedAction) {
            return
          }

          if (this.characterCount>=this.question.maxLength) {
            event.preventDefault();
          }
        }
      }

      _paste(event) {
        if (this.question.maxLength) {
          var clipboardData = event.clipboardData || window.clipboardData;
          var pastedText = clipboardData.getData('text/plain');
          var content = event.target.textContent;
          var contentLength = content.length;
          var selectedText = window.getSelection().toString();
          const allowedPasteLength = this.question.maxLength - contentLength + selectedText.length;
          const slicedPasteText = pastedText.substring(0, allowedPasteLength);

          event.preventDefault();

          document.execCommand('insertHTML', false, slicedPasteText);
        }

        setTimeout(function() {
          this._updateCharacterCounter();
        }.bind(this));
      }

      _changed() {
        this.set('value', this.shadowRoot.querySelector("#htmlEditor").innerHTML);
        this._updateCharacterCounter();
      }

      validate() {
        if (this.question.required) {
          if (this.value && this.value.length>0) {
            return true;
          } else {
            return false;
          }
        } else {
          return true;
        }
      }

      _clearFormat() {
        document.execCommand('removeFormat');
        document.execCommand('formatBlock', false, 'p');
        this._changed();
      }

      _toggleH1() {
        document.execCommand('formatBlock',false,'h1');
        this._changed();
      }

      _toggleH2() {
        document.execCommand('formatBlock',false,'h2');
        this._changed();
      }

      _toggleH3() {
        document.execCommand('formatBlock',false,'h3');
        this._changed();
      }

      _toggleH4() {
        document.execCommand('formatBlock',false,'h4');
        this._changed();
      }

      _toggleH5() {
        document.execCommand('formatBlock',false,'h5');
        this._changed();
      }

      _toggleH6() {
        document.execCommand('formatBlock',false,'h6');
        this._changed();
      }

      _toggleP() {
        document.execCommand('formatBlock',false,'p');
        this._changed();
      }

      _toggleAlignLeft() {
        document.execCommand("JustifyLeft", false, "");
        this._changed();
      }

      _toggleAlignRight() {
        document.execCommand("JustifyRight", false, "");
        this._changed();
      }

      _toggleAlignCenter() {
        document.execCommand("JustifyCenter", false, "");
        this._changed();
      }

      _toggleAlignJustify() {
        document.execCommand("JustifyFull", false, "");
        this._changed();
      }

      _toggleBold() {
        document.execCommand('bold');
        this._changed();
      }

      _toggleItalic() {
        document.execCommand('italic');
        this._changed();
      }

      _toggleUnderline() {
        document.execCommand('underline');
        this._changed();
      }

      _toggleListBullets() {
        document.execCommand('insertUnorderedList');
        this._changed();
      }

      _toggleListNumbers() {
        document.execCommand('insertOrderedList');
        this._changed();
      }

      ready() {
        if (window.i18nTranslation) {
          this.set('language', window.locale);
        }

        super.ready();
      }
    }

    customElements.define(YpSimpleHtmlEditor.is, YpSimpleHtmlEditor);
  </script>
</dom-module>
