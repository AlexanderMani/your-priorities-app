<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../yp-behaviors/yp-language-behavior.html">

<script src="https://unpkg.com/recordrtc@5.4.8/RecordRTC.js"></script>

<dom-module id="yp-media-recorder">
  <template>
    <style>
      video {
      }

      paper-dialog {
        background-color: #FFF;
      }

      #dialog {
      }

      .mainbuttons {
        width: 100%;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .horizontal {
        @apply --layout-horizontal;
      }

      .flex {
        @apply --layout-flex;
      }

      .recording {
        color: #f00;
        animation-name: pulse;
        animation-duration: 1.3s;
        animation-iteration-count: infinite;
        animation-timing-function: linear;
      }

      @keyframes pulse {
        from { opacity: 1; }
        to { opacity: 0; }
      }

      .buttonText {
        margin-left: 6px;
      }

      .actionButton {
        color: var(--accent-color);
      }

      .iconButtons {
        margin-top: 2px;
      }

      #secondsLeft {
        margin-top: 12px;
        margin-left: 4px;
        margin-right: 4px;
      }

      @media (max-width: 640px) {
        #dialog {
          padding: 0;
          margin: 0;
          @apply --layout-self-start;
        }
      }

      .rememberBox {
        margin-top: 8px;
      }

      #checkBox {
        margin-left: 6px;
      }
    </style>

    <paper-dialog id="selectDevices" modal>
      <h2>[[selectDeviceTitle]]</h2>
      <paper-dialog-scrollable>
        <paper-listbox id="deviceListBox">
          <template is="dom-repeat" items="[[allDevices]]">
            <paper-item on-tap="selectDeviceFunction" id="[[item.deviceId]]">[[item.label]]</paper-item>
          </template>
        </paper-listbox>
        <div class="layout horizontal rememberBox">
          <div>
            [[t('rememberDevice')]]
          </div>
          <input id="checkBox" type="checkbox">
        </div>
      </paper-dialog-scrollable>
    </paper-dialog>

    <paper-dialog id="dialog" modal>
      <div class="layout vertical">
        <template is="dom-if" if="[[videoRecording]]">
          <video id="videoRecorder" class="videoRecorder" hidden$="[[previewActive]]"></video>
          <video id="videoPreviewer" preload="auto" class="videoRecorder" hidden$="[[!previewActive]]"></video>
        </template>
        <template is="dom-if" if="[[audioRecording]]">
          <audio id="audioRecorder" class="audioRecorder"></audio>
        </template>
        <div class="layout horizontal buttons mainbuttons" hidden$="[[!recorder]]">
          <paper-icon-button icon="clear" class="iconButtons" on-tap="_close"></paper-icon-button>
          <paper-icon-button icon="delete" class="iconButtons" on-tap="_deleteRecording" hidden$="[[!recordedData]]"></paper-icon-button>
          <paper-button on-tap="_startRecording" hidden$="[[recordedData]]">
            <iron-icon id="recordingIcon" icon="fiber-manual-record"></iron-icon>
            <div class="buttonText">[[t('record')]]</div>
          </paper-button>
          <div id="secondsLeft" hidden$="[[recordedData]]">[[recordSecondsLeft]] [[t('seconds')]]</div>
          <paper-button on-tap="_stopRecording" hidden$="[[!isRecording]]">
            <iron-icon icon="stop"></iron-icon>
            <div class="buttonText">[[t('stop')]]</div>
          </paper-button>
          <paper-button on-tap="_stopRecording" on-tap="_sendBack" class="actionButton" hidden$="[[!recordedData]]">
            <iron-icon icon="send"></iron-icon>
            <div class="buttonText">[[t('send')]]</div>
          </paper-button>
        </div>

        <div class="layout horizontal center-justified"></div>
      </div>
      <div hidden$="[[!error]]">
        [[error]]
      </div>
    </paper-dialog>

    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>
    <iron-ajax id="getTranslationAjax" on-response="_getTranslationResponse"></iron-ajax>
  </template>

  <script>

    class YpMediaRecorder extends  Polymer.mixinBehaviors([Polymer.ypLanguageBehavior], Polymer.Element) {
      static get is() { return 'yp-media-recorder'; }

      static get properties() {
        return {
          recorder: {
            type: Object,
            value: null
          },

          mediaStream: Object,

          audioRecording: {
            type: Boolean,
            value: false
          },

          videoRecording: {
            type: Boolean,
            value: false
          },

          maxLength: {
            type: Number,
            value: 5
          },

          recordedData: {
            type: Object,
            value: null
          },

          recordingFinished: {
            type: Boolean,
            value: false
          },

          callbackFunction: {
            type: Function,
            value: null
          },

          error: {
            type: String,
            value: null
          },

          recordSecondsLeft: Number,

          isRecording: {
            type: Boolean,
            value: false
          },

          rememberDevice: {
            type: Boolean,
            value: false
          },

          audioDevices: Array,

          videoDevices: Array,

          allDevices: Array,

          captureCallback: Function,

          captureStream: Object,

          previewActive: {
            type: Boolean,
            value: false
          },

          videoOptions: Object,

          selectDeviceTitle: String,

          selectDeviceFunction: {
            type: Function,
            value: null
          }
        }
      }

      _selectAudioDevice (event, detail) {
        console.error("_selectAudioDevice");
        if (event.target.id) {
          this.set('selectedAudioDeviceId', event.target.id);
        }

        if (this.$$("#checkBox").checked) {
          localStorage.setItem("selectedAudioDeviceId", this.selectedAudioDeviceId);
        }

        this.$.selectDevices.close();
        this._openMediaSession(this.captureCallback);
      }

      _selectVideoDevice (event) {
        console.error("_selectVideoDevice");

        if (event.target.id) {
          this.set('selectedVideoDeviceId', event.target.id);
        }

        if (this.$$("#checkBox").checked) {
          localStorage.setItem("selectedVideoDeviceId", this.selectedVideoDeviceId);
        }

        this.$.selectDevices.close();
        this._checkAudioDevices();
      }

      _checkAudioDevices () {
        if (this.audioDevices && this.audioDevices.length>1) {
          if (localStorage.getItem("selectedAudioDeviceId")) {
            this.set('selectedAudioDeviceId', localStorage.getItem("selectedAudioDeviceId"));
            this._openMediaSession(this.captureCallback);
          } else {
            this.set('selectDeviceTitle', this.t('selectAudioDevice'));
            this.$$("#checkBox").checked = false;
            this.selectDeviceFunction = this._selectAudioDevice.bind(this);
            this.set('allDevices', this.audioDevices);
            this.$$("#deviceListBox").selected = null;
            this.$.selectDevices.open();
          }
        } else {
          this._openMediaSession(this.captureCallback);
        }
      }

      _checkVideoDevices () {
        if (this.videoDevices && this.videoDevices.length>1) {
          if (localStorage.getItem("selectedVideoDeviceId")) {
            this.set('selectedVideoDeviceId', localStorage.getItem("selectedVideoDeviceId"));
            this._checkAudioDevices();
          } else {
            this.set('selectDeviceTitle', this.t('selectVideoDevice'));
            this.$$("#checkBox").checked = false;
            this.set('rememberDevice', false);
            this.selectDeviceFunction = this._selectVideoDevice.bind(this);
            this.set('allDevices', this.videoDevices);
            this.$$("#deviceListBox").selected = null;
            this.$.selectDevices.open();
          }
        } else {
          this._checkAudioDevices();
        }
      }

      _close () {
        if (this.mediaStream) {
          this.mediaStream.getTracks().forEach(function (track) {
            track.stop();
          });
        }
        this.$.dialog.close();
      }

      _sendBack () {
        if (this.callbackFunction && this.recorder) {
          this.callbackFunction(this.recordedData);
          this.recordedData = null;
          this.recorder.clearRecordedData();
          this.recorder.reset();
          this.recorder = null;
          this._close();
        } else {
          console.error("No callback function for media player");
        }
      }

      checkDevices (callback) {
        navigator.mediaDevices.enumerateDevices().then( function (devicesIn) {
          this.audioDevices =  devicesIn.filter(function (d) {
            return d.kind === 'audioinput'
          });

          this.videoDevices =  devicesIn.filter(function (d) {
            return d.kind === 'videoinput'
          });

          this._checkVideoDevices();
        }.bind(this));
      }

      captureUserMedia (callback) {
        this.captureCallback = callback;
        this.checkDevices();
      }

      _openMediaSession (callback) {
        if (this.selectedVideoDeviceId) {
          this.videoSettings.deviceId = this.selectedVideoDeviceId;
        }

        var session = {
          audio: this.selectedAudioDeviceId ? { deviceId: this.selectedAudioDeviceId } : true,
          video: this.videoRecording ? this.videoSettings : null
        };

        navigator.getUserMedia(session, callback, function(error) {
          console.error(error);
          //TODO: Fire user error
          callback(null)
          ;
        }.bind(this));
      }

      $$ (id) {
        return this.shadowRoot.querySelector(id)
      }

      open (options) {
        this.callbackFunction = options.callbackFunction;
        this.set('recordingFinished', false);
        this.set('error', null);
        this.set('audioRecording', false);
        this.set('videoRecording', false);
        if (options.videoRecording) {
          this.set('videoRecording', true);
        } else if (options.audioRecording) {
          this.set('audioRecording', true);
        }

        setTimeout(function () {
          if (this.videoRecording) {
            var videoElement = this.shadowRoot.querySelector('#videoRecorder');
            var videoPreviewElement = this.shadowRoot.querySelector('#videoPreviewer');
            var width, height;
            if (window.innerHeight>window.innerWidth) {
              this.set('videoSettings', { width: 720, height: 1280 });
              height = Math.min(1280, Math.abs(window.innerHeight*0.8)).toFixed();
              width = Math.min(720, Math.abs(height*0.5625)).toFixed();
              console.error("Portrait - width: "+width+" height: "+height);
            } else {
              this.set('videoSettings', { width: 1280, height: 720 });
              height = Math.min(720, Math.abs(window.innerHeight*0.8)).toFixed();
              width = Math.min(1280, Math.abs(height*1.77777777778)).toFixed();
              console.error("Landscape - width: "+width+" height: "+height);
            }
            videoElement.style.height = height + 'px';
            videoElement.style.width = width + 'px';
            videoPreviewElement.style.height = height + 'px';
            videoPreviewElement.style.width = width + 'px';

            setTimeout(function () {
              this.$.dialog.open();
            }.bind(this));
          } else {

          }
        }.bind(this));

        setTimeout(function () {
          this.setupRecorders();
        }.bind(this), 20);
      }

      _generateRandomString () {
        if (window.crypto) {
          var a = window.crypto.getRandomValues(new Uint32Array(3)),
            token = '';
          for (var i = 0, l = a.length; i < l; i++) token += a[i].toString(36);
          return token;
        } else {
          return (Math.random() * new Date().getTime()).toString(36).replace( /\./g , '');
        }
      }

      _startRecording () {
        var videoElement = this.shadowRoot.querySelector('#videoRecorder');
        this.recorder.startRecording();
        this.recordSecondsLeft = this.maxLength;
        this.set('isRecording', true);
        this.$$("#recordingIcon").className = "recording";
        this._recordingTimer();
      }

      _stopRecording () {
        var videoElement = this.shadowRoot.querySelector('#videoRecorder');
        videoElement.pause();
        this.$$("#recordingIcon").className = "";
        this.set('isRecording', false);
        this.recorder.stopRecording(this._storeRecordedData.bind(this));
      }

      _deleteRecording () {
        this.recorder.reset();
        this.set('previewActive', false);
        this.set('recordedData',  null);
        this.recordSecondsLeft = this.maxLength;
        var videoElement = this.shadowRoot.querySelector('#videoRecorder');
        videoElement.play();
      }

      _storeRecordedData () {
        var blob = this.recorder.getBlob();
        var fileName;

        if (this.videoRecording) {
          var videoElement = this.shadowRoot.querySelector('#videoRecorder');
          var videoPreviewer = this.shadowRoot.querySelector('#videoPreviewer');
          fileName = this._generateRandomString() + '.webm';
          this.recordedData = new File([blob], fileName, {
            type: 'video/webm'
          });
          videoElement.controls = true;
          this.recorder.reset();
          videoPreviewer.src = window.URL.createObjectURL(this.recordedData);
          videoPreviewer.controls = true;
          this.set('previewActive', true);
        } else if (this.audioRecording) {
          var audioElement = this.shadowRoot.querySelector('#audioRecorder');
          fileName = this._generateRandomString() + '.mp3';
          this.recordedData = new File([blob], fileName, {
            type: 'audio/mp3'
          });
          audioElement.controls = true;
          audioElement.pause();
          this.recorder.reset();
          try {
            audioElement.srcObject = this.recordedData;
          } catch (error) {
            console.error(error);
            audioElement.src = window.URL.createObjectURL(this.recordedData);
          }
        }
      }

      _recordingTimer () {
        if (this.isRecording) {
          setTimeout(function () {
            if (this.isRecording) {
              this.recordSecondsLeft -= 1;
              if (this.recordSecondsLeft>=0) {
                this._recordingTimer();
              } else {
                this._stopRecording();
              }
            }
          }.bind(this), 1000);
        } else {
          console.error("_recordingTimer called without in recording mode");
        }
      }

      setupRecorders () {
        this.recordSecondsLeft = this.maxLength;
        if (this.videoRecording) {
          var videoElement = this.shadowRoot.querySelector('#videoRecorder');

          this.captureUserMedia(function(stream) {
            if (stream) {
              this.mediaStream = stream;
              try {
                videoElement.srcObject = stream;
              } catch (error) {
                console.error(error);
                videoElement.src = window.URL.createObjectURL(stream);
              }
              videoElement.play();
              videoElement.muted = true;
              videoElement.controls = false;

              this.recorder = RecordRTC(stream, {
                type: 'video'
              });
            } else {
              console.error("Can't find stream");
            }
          }.bind(this));

        } else if (this.audioRecording) {

        }
        setTimeout(function () {
          this.$.dialog.center();
        }.bind(this));
      }

      ready () {
        if (window.i18nTranslation) {
          this.set('language', window.locale);
        }
        super.ready();
      }

      _languageEvent (event, detail) {
        if (detail.type === 'language-loaded') {
          this.set('language', detail.language);
          this._update();
        }
      }
    }

    customElements.define(YpMediaRecorder.is, YpMediaRecorder);
  </script>
</dom-module>
