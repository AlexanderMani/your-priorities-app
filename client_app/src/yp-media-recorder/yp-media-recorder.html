<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../yp-behaviors/yp-language-behavior.html">

<link rel="import" href="videojs-css.html">

<script src="https://unpkg.com/video.js@7.0.0/dist/video.min.js"></script>
<script src="https://unpkg.com/videojs-record@2.4.1/dist/videojs.record.min.js"></script>

<script src="https://unpkg.com/recordrtc@5.4.8/RecordRTC.js"></script>

<!--
<script src="../../bower_components/video.js/src/js/video.js"></script>
<script src="../../bower_components/videojs-record/src/js/videojs.record.js"></script>
<script src="../../bower_components/wavesurfer.js/src/wavesurfer.js"></script>
<script src="../../bower_components/videojs-wavesurfer/src/js/videojs.wavesurfer.js"></script>
-->

<dom-module id="yp-media-recorder">
  <template>
    <style include="videojs-css">
      .video-js {
        height: 720px;
        width: 1280px;

      }
    </style>

    <paper-dialog id="dialog" modal>
      <div class="layout vertical">
        <template is="dom-if" if="[[videoRecording]]">
          <video id="videoRecorder" class="video-js vjs-default-skin"></video>
        </template>
        <template is="dom-if" if="[[audioRecording]]">
          <audio id="audioRecorder" class="video-js vjs-default-skin"></audio>
        </template>
        <div class="layout horizontal center-justified">
          <paper-icon-button icon="delete" on-tap="_close"></paper-icon-button>
          <div class="flex"></div>
          <paper-icon-button icon="send" on-tap="_sendBack"></paper-icon-button>
        </div>
      </div>
      <div hidden$="[[!error]]">
        [[error]]
      </div>
    </paper-dialog>

    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>
    <iron-ajax id="getTranslationAjax" on-response="_getTranslationResponse"></iron-ajax>
  </template>

  <script>

    class YpMediaRecorder extends Polymer.Element {
      static get is() { return 'yp-media-recorder'; }

      static get properties() {
        return {
          player: {
            type: Object,
            value: null
          },

          audioRecording: {
            type: Boolean,
            value: false
          },

          videoRecording: {
            type: Boolean,
            value: false
          },

          maxLength: {
            type: Number,
            value: 5
          },

          recordedData: {
            type: Object
          },

          recordingFinished: {
            type: Boolean,
            value: false
          },

          callbackFunction: {
            type: Function,
            value: null
          },

          error: {
            type: String,
            value: null
          }
        }
      }

      _close () {
        this.$.dialog.close();
      }

      _sendBack () {
        debugger;
        if (this.callbackFunction && this.player) {
          this.callbackFunction(this.player.recordedData);
          this.player.record().destroy();
          this.player = null;
          this._close();
        } else {
          console.error("No callback function for media player");
        }
      }

      open (options) {
        this.callbackFunction = options.callbackFunction;
        this.set('recordingFinished', false);
        this.set('error', null);
        this.set('audioRecording', false);
        this.set('videoRecording', false);
        if (options.videoRecording) {
          this.set('videoRecording', true);
        } else if (options.audioRecording) {
          this.set('audioRecording', true);
        }
        setTimeout(function () {
          this.setupRecorders();
          this.$.dialog.open();
        }.bind(this));
      }

      setupRecorders () {
        if (this.videoRecording) {
          var videoElement = this.shadowRoot.querySelector('#videoRecorder');
          this.player = videojs(videoElement, {
            controls: true,
            width: 430,
            height: 242,
            fluid: false,
            plugins: {
              record: {
                audio: true,
                video: true,
                maxLength: this.maxLength,
                debug: true
              }
            }
          }, function(){
            var msg = 'Using video.js ' + videojs.VERSION +
              ' with videojs-record ' + videojs.getPluginVersion('record') +
              ' and recordrtc ' + RecordRTC.version;
            console.log(msg);
          });

          this.player.on('startRecord', function () {
            console.log("startRecord recording");
            this.set('recordingFinished', false);
          }.bind(this));

          this.player.on('progressRecord', function (event, detail) {
            var duration = this.player.record().getDuration();
            console.log("progressRecord recording "+duration);
            if (duration>=this.maxLength) {
              this.player.record().stop();
            }
          }.bind(this));


          this.player.on('error', function (error) {
            console.error(error);
          });

          this.player.on('finishRecord', function () {
            console.log("Finished recording");
            this.set('recordingFinished', true);
            setTimeout(function () {
              this.player.record().stopDevice();
              this.player.currentTime(0);
              this.player.play();
            }.bind(this), 100);
          }.bind(this));

          this.player.on('deviceError', function () {
            this.set('recordingFinished', false);
            this.set('error', this.player.deviceErrorCode);
            console.error(this.player.deviceErrorCode);
          }.bind(this));
          this.player.on('enumerateError', function () {
            this.set('recordingFinished', false);
            this.set('error', this.player.enumerateError);
            console.error(this.player.enumerateError);
          }.bind(this));

          this.player.record().getDevice();

          setTimeout(function () {
            console.error("Start");
            this.player.record().start();
          }.bind(this), 5000);

        } else if (this.audioRecording) {

        }
      }

      ready () {
        if (window.i18nTranslation) {
          this.set('language', window.locale);
        }
        super.ready();
      }

      _languageEvent (event, detail) {
        if (detail.type === 'language-loaded') {
          this.set('language', detail.language);
          this._update();
        }
      }
    }

    customElements.define(YpMediaRecorder.is, YpMediaRecorder);
  </script>
</dom-module>
