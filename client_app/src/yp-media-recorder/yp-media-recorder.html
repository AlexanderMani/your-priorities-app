<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../yp-behaviors/yp-language-behavior.html">

<script src="https://unpkg.com/recordrtc@5.4.8/RecordRTC.js"></script>

<!--
<script src="../../bower_components/video.js/src/js/video.js"></script>
<script src="../../bower_components/videojs-record/src/js/videojs.record.js"></script>
<script src="../../bower_components/wavesurfer.js/src/wavesurfer.js"></script>
<script src="../../bower_components/videojs-wavesurfer/src/js/videojs.wavesurfer.js"></script>
-->

<dom-module id="yp-media-recorder">
  <template>
    <style>
      video {
        height: 720px;
        width: 1280px;
      }

      paper-dialog {
        background-color: #FFF;
      }
    </style>

    <paper-dialog id="dialog" modal>
      <div class="layout vertical">
        <template is="dom-if" if="[[videoRecording]]">
          <video id="videoRecorder" class="videoRecorder"></video>
        </template>
        <template is="dom-if" if="[[audioRecording]]">
          <audio id="audioRecorder" class="audioRecorder"></audio>
        </template>
        <div class="layout horizontal" hidden$="[[!recorder]]">
          <paper-icon-button icon="delete" on-tap="_close"></paper-icon-button>
          <paper-button on-tap="_startRecording" hidden$="[[recordedData]]"><iron-icon icon="fiber-manual-record"></iron-icon>[[t('record')]]</paper-button>
          <paper-button on-tap="_stopRecording" hidden$="[[recordedData]]"><iron-icon icon="stop"></iron-icon>[[t('stop')]]</paper-button>
          <div class="flex"></div>
          <paper-icon-button icon="send" on-tap="_sendBack" hidden$="[[!recordedData]]"></paper-icon-button>
          <div id="secondsLeft" hidden$="[[recordedData]]">[[recordSecondsLeft]] [[t('seconds')]]</div>
        </div>

        <div class="layout horizontal center-justified"></div>
      </div>
      <div hidden$="[[!error]]">
        [[error]]
      </div>
    </paper-dialog>

    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>
    <iron-ajax id="getTranslationAjax" on-response="_getTranslationResponse"></iron-ajax>
  </template>

  <script>

    class YpMediaRecorder extends Polymer.Element {
      static get is() { return 'yp-media-recorder'; }

      static get properties() {
        return {
          recorder: {
            type: Object,
            value: null
          },

          mediaStream: Object,

          audioRecording: {
            type: Boolean,
            value: false
          },

          videoRecording: {
            type: Boolean,
            value: false
          },

          maxLength: {
            type: Number,
            value: 5
          },

          recordedData: {
            type: Object
          },

          recordingFinished: {
            type: Boolean,
            value: false
          },

          callbackFunction: {
            type: Function,
            value: null
          },

          error: {
            type: String,
            value: null
          },

          recordSecondsLeft: Number,

          isRecording: {
            type: Boolean,
            value: false
          }
        }
      }

      _close () {
        this.$.dialog.close();
      }

      _sendBack () {
        if (this.callbackFunction && this.recorder) {
          this.callbackFunction(this.recordedData);
          this.recordedData = null;
          this.recorder.clearRecordedData();
          this.recorder.reset();
          this.recorder = null;
          this._close();
        } else {
          console.error("No callback function for media player");
        }
      }

      captureUserMedia (callback) {
        var session = {
          audio: true,
          video: this.videoRecording ? { width: 1280, height: 720 } : null
        };

        debugger;

        navigator.getUserMedia(session, callback, function(error) {
          console.error(error);
          //TODO: Fire user error
          callback(null);
        });
      }

      open (options) {
        this.callbackFunction = options.callbackFunction;
        this.set('recordingFinished', false);
        this.set('error', null);
        this.set('audioRecording', false);
        this.set('videoRecording', false);
        if (options.videoRecording) {
          this.set('videoRecording', true);
        } else if (options.audioRecording) {
          this.set('audioRecording', true);
        }
        setTimeout(function () {
          this.setupRecorders();
          this.$.dialog.open();
        }.bind(this), 100);
      }

      _generateRandomString () {
        if (window.crypto) {
          var a = window.crypto.getRandomValues(new Uint32Array(3)),
            token = '';
          for (var i = 0, l = a.length; i < l; i++) token += a[i].toString(36);
          return token;
        } else {
          return (Math.random() * new Date().getTime()).toString(36).replace( /\./g , '');
        }
      }

      _startRecording () {
        this.recorder.startRecording();
        this.recordSecondsLeft = this.maxLength;
        this.set('isRecording', true);
        this._recordingTimer();
      }

      _stopRecording () {
        this.set('isRecording', false);
        this.recorder.stopRecording(this._storeRecordedData.bind(this));
      }

      _storeRecordedData () {
        var blob = this.recorder.getBlob();
        var fileName;

        if (this.videoRecording) {
          var videoElement = this.shadowRoot.querySelector('#videoRecorder');
          fileName = this._generateRandomString() + '.webm';
          this.recordedData = new File([blob], fileName, {
            type: 'video/webm'
          });
          videoElement.controls = true;

        } else if (this.audioRecording) {
          var audioElement = this.shadowRoot.querySelector('#audioRecorder');
          fileName = this._generateRandomString() + '.mp3';
          this.recordedData = new File([blob], fileName, {
            type: 'audio/mp3'
          });
          audioElement.controls = true;
        }
      }

      _recordingTimer () {
        if (this.isRecording) {
          setTimeout(function () {
            if (this.isRecording) {
              this.recordSecondsLeft -= 1;
              if (this.recordSecondsLeft>0) {
                this._recordingTimer();
              } else {
                this._stopRecording();
              }
            }
          }.bind(this), 1000);
        } else {
          console.error("_recordingTimer called without in recording mode");
        }
      }

      setupRecorders () {
        if (this.videoRecording) {
          var videoElement = this.shadowRoot.querySelector('#videoRecorder');

          this.captureUserMedia(function(stream) {
            if (stream) {
              this.mediaStream = stream;
              try {
                var mediaSource = new MediaSource();
                mediaSource.addSourceBuffer(stream);
                videoElement.srcObject = mediaSource;
              } catch (error) {
                console.error(error);
                videoElement.src = window.URL.createObjectURL(stream);
              }
              videoElement.play();
              videoElement.muted = true;
              videoElement.controls = false;

              this.recorder = RecordRTC(stream, {
                type: 'video'
              });
            } else {
              console.error("Can't find stream");
            }
          }.bind(this));

        } else if (this.audioRecording) {

        }
      }

      ready () {
        if (window.i18nTranslation) {
          this.set('language', window.locale);
        }
        super.ready();
      }

      _languageEvent (event, detail) {
        if (detail.type === 'language-loaded') {
          this.set('language', detail.language);
          this._update();
        }
      }
    }

    customElements.define(YpMediaRecorder.is, YpMediaRecorder);
  </script>
</dom-module>
