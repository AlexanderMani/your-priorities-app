<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html" >
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html" >
<link rel="import" href="../../bower_components/paper-button/paper-button.html" >
<link rel="import" href="../../bower_components/paper-input/paper-input.html" >
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html" >
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" >

<link rel="import" href="../yp-ajax/yp-ajax.html" >
<link rel="import" href="../yp-behaviors/yp-number-format-behavior.html" >
<link rel="import" href="../yp-behaviors/yp-language-behavior.html" >

<dom-module id="yp-content-moderation">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #dialog {
        width: 90%;
        max-width: 1024px;
        background-color: #FFF;
      }

      .itemItem {
        padding-right: 16px;
      }

      .id {
        width: 40px;
      }

      .name {
        width: 200px;
      }

      .email {
        width: 190px;
        overflow-wrap: break-word;
      }

      .organization {
        width: 150px;
      }

      .addDeletedButtons {
        width: 150px;
      }

      #selectOrganizationDialog {
        background-color: #FFF;

      }

      [hidden] {
        display: none !important;
      }

      paper-listbox {
        margin-right: 8px !important;
      }

      .headerBox {
        margin: 16px;
        margin-bottom: 0;
        margin-left: 0;
        margin-right: 0;
      }

      paper-button {
        margin-left: 24px;
      }

      .inputBox {
        margin-left: 16px;
        padding-left: 8px;
        padding-right: 8px;
        padding-bottom: 4px;
        margin-bottom: 4px;
        align-self: flex-start;
      }

      #grid {
        margin-top: 8px;
      }

      .headerText {
        display: flex;
        font-size: 22px;
      }

      .innerHeader {
        align-self: flex-end;
        margin-bottom: 24px;
      }

      @media (max-width: 600px) {
        paper-listbox {
          margin-right: 8px;
        }

        #dialog {
          width: 100%;
          height: 100%;
          margin: 0;
        }

        .headerText {
          font-size: 20px;
          line-height: 1.2em;
          text-align: center;
        }
      }

    </style>
    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>

    <paper-dialog id="dialog" modal>
      <div class="layout horizontal headerBox wrap">
        <div class="headerText"><div class="innerHeader">[[collectionName]] <span hidden$="[[!totalItemsCount]]">([[totalItemsCount]] [[itemsCountText]])</span></div></div>
      </div>

      <vaadin-grid id="grid" aria-label="[[headerText]]" items="[[items]]" selected-items="{{selectedItems}}">
        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>

        <vaadin-grid-column>
          <template class="header">[[t('date')]]</template>
          <template>[[item.formattedDate]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('contentType')]]</template>
          <template>[[item.type]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('moderationStatus')]]</template>
          <template>[[item.moderationStatus]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('flags')]]</template>
          <template>[[item.flags]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('content')]]</template>
          <template>
            <yp-magic-text content="[[item.content]]" content-type="[[item.contentTranslationType]]"></yp-magic-text>
          </template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('title')]]</template>
          <template>[[item.title]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('media')]]</template>
          <template>
            <yp-moderation-media item="[[item]]"></yp-moderation-media>
          </template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">[[t('itemEmail')]]</template>
          <template>[[item.email]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column width="70px" flex-grow="0">
          <template class="header">
            <paper-menu-button horizontal-align="right" class="helpButton" disabled$="[[selectedItemsEmpty]]">
              <paper-icon-button icon="more-vert" slot="dropdown-trigger" ></paper-icon-button>
              <paper-listbox slot="dropdown-content" on-iron-select="_menuSelection">
                <template is="dom-if" if="[[!selectedItemsEmpty]]" restamp>
                  <paper-item data-args$="[[item.id]]" on-tap="_deleteSelectedContent">
                    [[t('deleteSelectedContent')]] [[selectedContentCount]]
                  </paper-item>
                  <paper-item data-args$="[[item.id]]" hidden$="[[adminItems]]" on-tap="_approveSelectedContent">
                    [[t('approveSelectedContent')]] [[selectedContentCount]]
                  </paper-item>
                  <paper-item data-args$="[[item.id]]" hidden$="[[adminItems]]" on-tap="_clearSelectedFlags">
                    [[t('clearSelectedFlags')]] [[selectedContentCount]]
                  </paper-item>
                </template>
              </paper-listbox>
            </paper-menu-button>
          </template>
          <template>
            <paper-menu-button horizontal-align="right" class="helpButton">
              <paper-icon-button icon="more-vert" data-args$="[[item.id]]" on-tap="_setSelected" slot="dropdown-trigger"></paper-icon-button>
              <paper-listbox slot="dropdown-content" on-iron-select="_menuSelection">
                <paper-item data-args$="[[item.id]]" on-tap="_deleteContent">
                  [[t('deleteContent')]]
                </paper-item>
                <paper-item data-args$="[[item.id]]" hidden$="[[adminItems]]" on-tap="_approveContent">
                  [[t('approveContent')]]
                </paper-item>
                <paper-item data-args$="[[item.id]]" hidden$="[[adminItems]]" on-tap="_clearFlags">
                  [[t('clearFlags')]]
                </paper-item>
              </paper-listbox>
            </paper-menu-button>
          </template>
        </vaadin-grid-column>
      </vaadin-grid>

      <div class="buttons">
        <paper-button raised dialog-dismiss>[[t('close')]]</paper-button>
      </div>
    </paper-dialog>

    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" on-response="_itemsResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteAdminAjax" on-response="_deleteAdminResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteManyAdminAjax" on-response="_deleteManyAdminResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteUserAjax" on-response="_deleteUserResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteManyItemsAjax" on-response="_deleteManyItemsResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteOrganizationAjax" on-response="_deleteOrganizationResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteAndDeleteAjax" on-response="_deleteAndDeleteCompleted"></yp-ajax>
      <yp-ajax method="DELETE" id="deleteAndDeleteManyAjax" on-response="_deleteAndDeleteManyCompleted"></yp-ajax>
      <yp-ajax method="POST" id="inviteUserAjax" on-response="_inviteUserResponse"></yp-ajax>
      <yp-ajax method="POST" id="addAdminAjax" on-response="_addAdminResponse"></yp-ajax>
      <yp-ajax method="POST" id="addOrganizationAjax" on-response="_addOrganizationResponse"></yp-ajax>
    </div>
  </template>

  <script>
    Polymer({

      is: 'yp-content-moderation',

      behaviors: [
        Polymer.ypLanguageBehavior,
        Polymer.ypNumberFormatBehavior
      ],

      properties: {

        items: {
          type: Array,
          notify: true
        },

        headerText: {
          type: String
        },

        groupId: {
          type: Number,
          observer: '_groupIdChanged'
        },

        domainId: {
          type: Number,
          observer: '_domainIdChanged'
        },

        communityId: {
          type: Number,
          observer: '_communityIdChanged'
        },

        selected: {
          type: Object
        },

        modelType: {
          type: String
        },

        opened: {
          type: Boolean,
          value: false
        },

        selectedItems: {
          type: Array,
          notify: true
        },

        selectedContentCount: {
          type: Number,
          value: 0
        },

        selectedItemsEmpty: {
          type: Boolean,
          value: true
        },

        selectedItemIds: {
          type: Array
        },

        selectedItemId: {
          type: String
        },

        totalItemsCount: {
          type: String,
          computed: '_totalItemsCount(items)'
        },

        collectionName: String,

        itemsCountText: String
      },

      observers: [
        '_selectedItemsChanged(selectedItems.splices)'
      ],

      _menuSelection: function (event, detail) {
        var allMenus = this.$.grid.querySelectorAll("paper-listbox");
        allMenus.forEach(function (item) {
          item.select(null);
        });
      },

      _totalItemsCount: function (items) {
        if (items) {
          return this.formatNumber(items.length);
        } else {
          return null;
        }
      },

      _selectedItemsChanged: function () {
        if (this.selectedItems && this.selectedItems.length>0) {
          this.set('selectedItemsEmpty', false);
          this.set('selectedContentCount', this.selectedItems.length);
        } else {
          this.set('selectedItemsEmpty', true);
          this.set('selectedContentCount', 0);
        }
        this.selectedItemIds = this.selectedItems.map(function (item) { return item.id });
      },

      _itemOrganizationId: function (item) {
        if (item && item.OrganizationItems && item.OrganizationItems.length>0) {
          return item.OrganizationItems[0].id;
        } else {
          return null;
        }
      },

      _itemOrganizationName: function (item) {
        if (item && item.OrganizationItems && item.OrganizationItems.length>0) {
          return item.OrganizationItems[0].name;
        } else {
          return null;
        }
      },

      _availableOrganizations: function () {
        if (window.appUser.adminRights && window.appUser.adminRights.OrganizationAdmins) {
          return  window.appUser.adminRights.OrganizationAdmins;
        } else {
          return [];
        }
      },

      _deleteAdmin: function (event) {
        var itemId = event.target.getAttribute('data-args');
        this.$.deleteAdminAjax.body = {};
        if (this.modelType=="groups" && this.groupId) {
          this.$.deleteAdminAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + itemId + "/delete_admin";
          this.$.deleteAdminAjax.generateRequest();
        } else if (this.modelType=="communities" && this.communityId) {
          this.$.deleteAdminAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + itemId + "/delete_admin";
          this.$.deleteAdminAjax.generateRequest();
        } else if (this.modelType=="domains" && this.domainId) {
          this.$.deleteAdminAjax.url = "/api/" + this.modelType + "/" + this.domainId + "/" + itemId + "/delete_admin";
          this.$.deleteAdminAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _deleteSelectedAdmins: function (event) {
        this._setupUserIdFromEvent(event);
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('areYouSureYouWantToDeletedAdmins'), this._reallyDeletedSelectedAdmins.bind(this), true, false);
        }.bind(this));
      },

      _deleteAndDeleteContentselectedItems: function (event) {
        this._setupUserIdFromEvent(event);
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('areYouSureDeletedAndDeleteSelectedUserContent'), this._reallyDeletedAndDeleteContentselectedItems.bind(this), true, true);
        }.bind(this));
      },

      _deleteselectedItemsFromCollection: function (event) {
        this._setupUserIdFromEvent(event);
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('areYouSureDeletedselectedItems'), this._reallyDeletedselectedItemsFromCollection.bind(this), true, true);
        }.bind(this));
      },

      _deleteUserFromCollection: function (event) {
        this._setupUserIdFromEvent(event);
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('areYouSureDeletedUser'), this._reallyDeletedUserFromCollection.bind(this), true, false);
        }.bind(this));
      },

      _deleteAndDeleteUserContent: function (event) {
        this._setupUserIdFromEvent(event);
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('areYouSureDeletedAndDeleteUser'), this._reallyDeletedAndDeleteUserContent.bind(this), true, true);
        }.bind(this));
      },

      _reallyDeletedSelectedAdmins: function () {
        this._deleteMaster(this.$.deleteManyAdminAjax, 'delete_many_admins', this.selectedItemIds);
      },

      _reallyDeletedAndDeleteContentselectedItems: function () {
        this._deleteMaster(this.$.deleteAndDeleteManyAjax, 'delete_many_items_and_delete_content', this.selectedItemIds);
      },

      _reallyDeletedselectedItemsFromCollection: function () {
        this._deleteMaster(this.$.deleteManyItemsAjax, 'delete_many_items', this.selectedItemIds);
      },

      _reallyDeletedUserFromCollection: function () {
        this._deleteMaster(this.$.deleteUserAjax, 'delete_item');
      },

      _reallyDeletedAndDeleteUserContent: function () {
        this._deleteMaster(this.$.deleteAndDeleteAjax, 'delete_and_delete_item_content');
      },

      _setupUserIdFromEvent(event) {
        var itemId = event.target.parentElement.getAttribute('data-args');
        if (!itemId)
          itemId = event.target.getAttribute('data-args');
        this.set('selectedItemId', itemId);
      },

      _deleteMaster: function (ajax, type, itemIds) {
        var url, collectionId;
        if (this.modelType==="groups" && this.groupId) {
          collectionId = this.groupId;
        } else if (this.modelType==="communities" && this.communityId) {
          collectionId = this.communityId;
        } else if (this.modelType==="domains" && this.domainId) {
          collectionId = this.domainId;
        } else {
          console.error("Can't find model type or ids");
          return;
        }
        if (itemIds && itemIds.length>0) {
          url = "/api/" + this.modelType + "/" + collectionId + "/" +type;
          ajax.body = { itemIds: itemIds };
        } else if (this.selectedItemId) {
          url = "/api/" + this.modelType + "/" + collectionId + "/" + this.selectedItemId + "/"+type;
          ajax.body = {};
        } else {
          console.error("No item ids to delete");
          return;
        }
        if (this.modelType==="groups" && this.groupId) {
          ajax.url = url;
          ajax.generateRequest();
        } else if (this.modelType==="communities" && this.communityId) {
          ajax.url = url;
          ajax.generateRequest();
        } else if (this.modelType==="domains" && this.domainId) {
          ajax.url = url;
          ajax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
        if (this.selectedItemId) {
          var item = this._findUserFromId(this.selectedItemId);
          if (item)
            this.$.grid.deselectItem(item);
        }
      },

      _setSelected: function (event) {
        var item = this._findUserFromId(event.target.getAttribute('data-args'));
        if (item)
          this.$.grid.selectItem(item);
      },

      _findUserFromId: function (id) {
        var foundUser;
        this.items.forEach(function (item) {
          if (item.id==id) {
            foundUser = item;
          }
        }.bind(this));
        return foundUser;
      },

      _addAdmin: function (event) {
        this.$.addAdminAjax.body = {};
        if (this.modelType==="groups" && this.groupId) {
          this.$.addAdminAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + this.addAdminEmail + "/add_admin";
          this.$.addAdminAjax.generateRequest();
        } else if (this.modelType==="communities" && this.communityId) {
          this.$.addAdminAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + this.addAdminEmail + "/add_admin";
          this.$.addAdminAjax.generateRequest();
        } else if (this.modelType==="domains" && this.domainId) {
          this.$.addAdminAjax.url = "/api/" + this.modelType + "/" + this.domainId + "/" + this.addAdminEmail + "/add_admin";
          this.$.addAdminAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _inviteUser: function (event) {
        this.$.inviteUserAjax.body = {};
        if (this.modelType==="groups" && this.groupId) {
          this.$.inviteUserAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + this.inviteUserEmail + "/invite_item";
          this.$.inviteUserAjax.generateRequest();
        } else if (this.modelType==="communities" && this.communityId) {
          this.$.inviteUserAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + this.inviteUserEmail + "/invite_item";
          this.$.inviteUserAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _deleteAdminResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('adminDeleted'));
        this.$.ajax.generateRequest();
      },

      _deleteManyAdminResponse: function () {
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('removalsInProgress'), null, true, false, true);
        }.bind(this));
        this.$.dialog.close();
      },

      _deleteManyItemsResponse: function () {
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('removalsInProgress'), null, true, false, true);
        }.bind(this));
        this.$.dialog.close();
      },

      _deleteAndDeleteCompleted: function () {
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('removalAndDeletionInProgress'), null, true, false, true);
        }.bind(this));
        this.$.dialog.close();
      },

      _deleteAndDeleteManyCompleted: function () {
        Polymer.dom(document).querySelector('yp-app').getDialogAsync("confirmationDialog", function (dialog) {
          dialog.open(this.t('removalsAndDeletionsInProgress'), null, true, false, true);
        }.bind(this));
        this.$.dialog.close();
      },

      _deleteUserResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('itemDeleted'));
        this.$.ajax.generateRequest();
      },

      _addAdminResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('adminAdded')+' '+this.addAdminEmail);
        this.set('addAdminEmail', null);
        this.$.ajax.generateRequest();
      },

      _addOrganizationResponse: function (event, detail) {
        window.appGlobals.notifyUserViaToast(this.t('organizationUserAdded')+' '+ detail.response.email);
        this.$.ajax.generateRequest();
      },

      _deleteOrganizationResponse: function (event, detail) {
        window.appGlobals.notifyUserViaToast(this.t('organizationUserDeleted')+' '+ detail.response.email);
        this.$.ajax.generateRequest();
      },

      _domainIdChanged: function (newDomainId) {
        if (newDomainId) {
          this._reset();
          this.set('modelType', 'domains');
          this._generateRequest(newDomainId);
        }
      },

      _groupIdChanged: function (newGroupId) {
        if (newGroupId) {
          this._reset();
          this.set('modelType', 'groups');
          this._generateRequest(newGroupId);
        }
      },

      _communityIdChanged: function (newCommunityId) {
        if (newCommunityId) {
          this._reset();
          this.set('modelType', 'communities');
          this._generateRequest(newCommunityId);
        }
      },

      _generateRequest: function (id) {
        this.$.ajax.url = "/api/"+this.modelType+"/"+id+"/moderation_items";
        this.$.ajax.generateRequest();
      },

      _itemsResponse: function (event, detail) {
        this.set('items', detail.response);
        this.$.grid.clearCache();
        this.set('selectedContentCount', 0);
        this.set('selectedItemsEmpty', true);
      },

      setup: function (groupId, communityId, domainId) {
        this.set('groupId', null);
        this.set('communityId', null);
        this.set('domainId', null);
        this.set('items', null);

        if (groupId)
          this.set('groupId', groupId);

        if (communityId)
          this.set('communityId', communityId);

        if (domainId)
          this.set('domainId', domainId);

        this._setupHeaderText();
      },

      open: function (name) {
        this.set('opened', true);
        this.$.dialog.open();
      },

      _reset: function () {
        this.set('items', []);
        this.set('selectedItems', []);
        this.set('selectedContentCount', 0);
        this.set('selectedItemsEmpty', true);
        this.$.grid.clearCache();
      },

      _setupHeaderText: function () {
        if (this.adminItems) {
          this.set('itemsCountText', this.t('adminsCount'));
        } else {
          this.set('itemsCountText', this.t('itemsCount'));
        }
        if (this.groupId) {
          if (this.adminItems) {
            this.set('headerText', this.t('group.admins'));
          } else {
            this.set('headerText', this.t('group.items'));
          }
        } else if (this.communityId) {
          if (this.adminItems) {
            this.set('headerText', this.t('community.admins'));
          } else {
            this.set('headerText', this.t('community.items'));
          }
        } else if (this.domainId) {
          if (this.adminItems) {
            this.set('headerText', this.t('domainAdmins'));
          } else {
            this.set('headerText', this.t('domainItems'));
          }
        }
      }
    });
  </script>
</dom-module>
