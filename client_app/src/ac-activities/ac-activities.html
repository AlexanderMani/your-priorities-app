-<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../with-in-viewport/with-in-viewport.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/yp-scroll-tab-behavior.html">
<link rel="import" href="../yp-behaviors/yp-logged-in-user-behavior.html">
<link rel="import" href="../yp-behaviors/access-helpers.html">
<link rel="import" href="../yp-behaviors/yp-iron-list-behavior.html">

<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-point/yp-point-news-story-edit.html">
<link rel="import" href="../yp-post/yp-post-cover-media.html">

<link rel="import" href="./ac-activity-header.html">
<link rel="import" href="./ac-activity-post.html">
<link rel="import" href="./ac-activity-point.html">
<link rel="import" href="./ac-activity-point-news-story.html">
<link rel="import" href="./ac-activity-post-status-update.html">
<link rel="import" href="./ac-activity-group.html">
<link rel="import" href="./ac-activity-recommended-posts.html">

<dom-module id="ac-activities">
  <template>
    <style include="iron-flex iron-flex-alignment">

      iron-list {
        margin-top: 8px;
        width: 600px !important;
      }

      .activity {
        margin: 16px !important;
        background-color: #FFF;
        width: 550px !important;
        height: 100% !important;
        padding-left: 16px;
        padding-right: 16px;
        margin-bottom: 8px;
        margin-top: 8px;
      }

      .activity[small] {
        width: 420px !important;
      }

      .recommendedPosts {
        margin: 16px !important;
        width: 220px !important;
        height: 100% !important;
      }

      .recommendedPosts[not-active] {
        display: none;
      }

      .container {
        position: relative;
      }

      .topHeader {
        background-color: var(--primary-color);
        color: #fff;
        height: 100% !important;
        z-index: 100;
      }

      .shadow {
        text-shadow: 2px 2px 4px #333;
      }

      .mainActivityContent {
        height: 100% !important;
      }

      .topHeader[newpost] {
        background-color: var(--accent-color);
      }

      ac-activity-header {
      }

      ac-activity-post {
        width :100%;
      }

      .headerUserImage {
        padding-top: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .userInfo {
        padding-right: 18px;
        text-align: left;
      }

      paper-button {
        color: var(--accent-color);
      }

      iron-icon {
        width: 48px;
        height: 48px;
        padding-top: 14px;
      }

      .headerText {
        padding-left: 8px;
      }

      .typeName {
        font-size: 30px;
        padding-top: 12px;
        padding-left: 4px;
      }

      .postName {
        font-size: 18px;
      }

      .postNameInHeader {
        font-size: 26px;
        padding: 8px;
        padding-right: 12px;
        margin-top: 6px;
      }

      .postNameInHeader[long-text] {
        font-size: 23px;
        padding: 8px;
      }

      .postNameInHeader[very-long-text] {
        font-size: 18px;
        padding: 8px;
      }

      .bulb {
        width: 54px;
        height: 54px;
        padding-top: 10px;
        padding-left: 0;
        padding-right: 0;
      }

      .postCoverMedia {
        width:  420px;
        min-width: 420px !important;
        height: 236px;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1000;
      }

      .textGradient {
        width:  420px;
        min-width: 420px !important;
        height: 236px;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -100;
        opacity: 0.5;
        filter: alpha(opacity=50);
        background: linear-gradient(
          to bottom,
          rgba(50,50,50, 100),
          rgba(50,50,50, 0)
        )
      }

      .groupCover {
        padding-top: 12px;
        padding-right: 12px;
      }

      .grayLine {
        background-color: #f0f0f0;
      }

      .thumbIconNewsFeed {
        height: 28px;
        width: 28px;
        padding-top: 2px;
        padding-left: 12px;
      }

      .participateButton {
        padding-top: 24px;
        padding-right: 4px;
      }

      .postPadding {
        padding-top: 38px;
      }

      .createdAt {
        color: #777;
        margin-top: 16px;
        font-size: 14px;
      }

      .userHeaderContainer {
        position: absolute;
        bottom: 0px;
        right: 0px;
      }

      yp-ajax {
        background-color: var(--primary-background-color);
      }

      .deleteIcon {
        position: absolute;
        right: 8px;
        bottom: 8px;
        color: #ddd;
      }

      .withCursor {
        cursor: pointer;
      }

      @media (max-width: 480px) {
        .typeName {
          font-size: 22px;
          padding-top: 12px;
          padding-left: 4px;
        }

        .activity {
          margin: 0 !important;
          margin-top: 24px !important;
          width: 307px !important;
/*          height: 100% !important; */
          height: 570px !important;
        }

        .postCoverMedia {
          width:  307px;
          min-width: 307px !important;
          height: 173px;
        }

        .textGradient {
          width:  307px;
          min-width: 307px !important;
          height: 173px;
        }

        .topHeader {
          height: 173px !important;
          max-height: 173px !important;
          z-index: 100;
        }

        .mainActivityContent {
/*          height: 100% !important;
          max-height: 100% !important;
          padding-bottom: 64px;
          */
            height: 390px !important;
            max-height: 390% !important;
        }

        .postNameInHeader {
          font-size: 22px;
          padding: 4px;
        }

        .postNameInHeader[long-text] {
          font-size: 19px;
          padding: 4px;
        }

        .postNameInHeader[very-long-text] {
          font-size: 15px;
          padding: 4px;
        }
      }

      .full {
        width: 100%;
      }

      .addNewsBox {
        background-color: #FFF;
        margin-top: 32px;
      }

      .nudgeBox {
        margin-left: -4px;
      }

      @media (max-width: 400px) {
        .userInfoContainer {
          padding-left: 64px;
        }
      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <div class="layout horizontal center-center">
      <div class="layout vertical self-start">
        <template is="dom-if" if="[[loggedInUser]]">
          <div class="layout vertical full nudgeBox">
            <paper-material elevation="1" hidden$="[[disableNewPosts]]" class="layout vertical activity addNewsBox">
              <yp-point-news-story-edit domain-id="[[domainId]]"
                                        community-id="[[communityId]]"
                                        group-id="[[groupId]]"
                                        post-group-id="[[postGroupId]]"
                                        post-id="[[postId]]"
                                        on-refresh="loadNewData">
              </yp-point-news-story-edit>
            </paper-material>
          </div>
        </template>
        <iron-list id="ironList" fire-resize-after-scrolling="1000" override-padding-top="600" scroll-target="document" items="[[activities]]" as="activity" on-tap="fireResize">
          <template>
            <div class="layout vertical center-center full">
              <paper-material elevation="[[_elevationForType(activity.type)]]" class="layout vertical activity" tabindex$="[[tabIndex]]">
                <paper-icon-button hidden$="[[!_hasActivityAccess(activity)]]" icon="delete" data-args$="[[activity.id]]" class="deleteIcon" on-tap="_deleteActivity"></paper-icon-button>
                <div class="mainActivityContent">
                  <div class="layout horizontal">
                    <ac-activity-header class="layout horizontal headerUserImage" activity="[[activity]]"></ac-activity-header>
                    <div class="flex"></div>
                    <div class="createdAt" title="[[fromLongTime(activity.created_at)]]">
                      [[fromTime(activity.created_at)]]
                    </div>
                  </div>

                  <template is="dom-if" if="[[_isActivityType(activity,'activity.post.new')]]">
                    <ac-activity-post post-id$="[[postId]]" activity="[[activity]]"></ac-activity-post>
                  </template>

                  <template is="dom-if" if="[[_isActivityType(activity,'activity.point.new')]]">
                    <ac-activity-point post-id$="[[postId]]" activity="[[activity]]"></ac-activity-point>
                  </template>

                  <template is="dom-if" if="[[_isActivityType(activity,'activity.point.newsStory.new')]]">
                    <ac-activity-point-news-story activity="[[activity]]"></ac-activity-point-news-story>
                  </template>

                  <template is="dom-if" if="[[_isActivityType(activity,'activity.post.status.change')]]">
                    <ac-activity-post-status-update activity="[[activity]]"></ac-activity-post-status-update>
                  </template>
                </div>
              </paper-material>
            </div>
          </template>
        </iron-list>
      </div>
      <div class="layout horizontal center-center recommendedPosts" not-active$="[[!recommendedPosts]]">
        <ac-activity-recommended-posts id="recommendedPosts" recommended-posts="[[recommendedPosts]]" class="layout vertical"></ac-activity-recommended-posts>
      </div>
      <div class="layout horizontal center-center">
        <yp-ajax id="recommendationAjax" large-spinner on-response="_recommendedPostsResponse"></yp-ajax>
      </div>
    </div>
    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" large-spinner on-response="_activitiesResponse"></yp-ajax>
      <yp-ajax id="deleteActivityAjax" method="DELETE" large-spinner on-response="_activityDeletedResponse"></yp-ajax>
    </div>

    <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>

    <iron-signals on-iron-signal-logged-in="_userLoggedIn"></iron-signals>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>
    <iron-signals on-iron-signal-yp-refresh-activities-scroll-threshold="_clearScrollThreshold"></iron-signals>

    <iron-scroll-threshold id="scrollTheshold"
                           lower-threshold="200"
                           on-lower-threshold="_loadMoreData"
                           scroll-target="document">
    </iron-scroll-threshold>
  </template>

  <script>
    Polymer({

      is: 'ac-activities',

      behaviors: [
        Polymer.appHelpers,
        Polymer.YpScrollTabBehavior,
        Polymer.ypLoggedInUserBehavior,
        Polymer.AccessHelpers,
        Polymer.ypIronListBehavior
      ],

      properties: {

        disableNewPosts: {
          type: Boolean,
          value: false
        },

        activities: {
          type: Array,
          notify: true
        },

        domainId: {
          type: Number,
          observer: "_domainIdChanged"
        },

        communityId: {
          type: Number,
          observer: "_communityIdChanged"
        },

        groupId: {
          type: Number,
          observer: "_groupIdChanged"
        },

        postId: {
          type: Number,
          observer: "_postIdChanged"
        },

        postGroupId: {
          type: Number
        },

        // 'activities' and 'news_feed'
        mode: {
          type: String,
          value: "activities"
        },

        url: {
          type: String
        },

        oldestProcessedActivityAt: {
          type: Date
        },

        latestProcessedActivityAt: {
          type: Date
        },

        activityIdToDelete: {
          type: Number
        },

        wide: {
          type: Boolean,
          value: false
        },

        selectedTab: {
          type: String
        },

        recommendedPosts: {
          type: Array,
          value: null
        },

        skipIronListWidth: {
          type: Boolean,
          value: true
        }
      },

      _hasPostImage: function (post) {
        return post && post.cover_media_type=="image";
      },

      _getActivityTypeName: function (activity) {
        if (activity.type=='activity.point.new' && activity.Point) {
          if (activity.Point.value>0) {
            return this.t('activity.point.newFor');
          } else if (activity.Point.value<0) {
            return this.t('activity.point.newAgainst');
          } else {
            return this.t('activity.point.newComment')
          }
        } else {
          return this.t(activity.type);
        }
      },

      _hidePostListPadding: function () {
        if (!this.postId) {
          return true;
        } else {
          return false;
        }
      },

      _postNameFor: function (activity) {
        if (activity.Post) {
          return activity.Post.name;
        } else if (activity.Point && activity.Point.Post) {
          return activity.Point.Post.name
        } else {
          return "";
        }
      },

      _longPostNameFor: function (activity) {
        if (activity.Post) {
          return activity.Post.name.length>50;
        } else if (activity.Point && activity.Point.Post) {
          return activity.Point.Post.name.length>50;
        } else {
          return false;
        }
      },

      _veryLongPostNameFor: function (activity) {
        if (activity.Post) {
          return activity.Post.name.length>70;
        } else if (activity.Point && activity.Point.Post) {
          return activity.Point.Post.name.length>70;
        } else {
          return false;
        }
      },

      _showGroup: function (activity) {
        if (activity.PostStatusChange) {
          return false;
        } else if (activity.Group) {
          if (activity.Group.name == 'hidden_public_group_for_domain_level_points') {
            return false;
          } else {
            return true;
          }
        } else {
          return false;
        }
      },

      _elevationForType: function (type) {
        return 1;

        /*if (type=='activity.post.new') {
          return 5;
        } else if (type=='activity.post.status.change') {
          return 3;
        } else {
          return 2;
        }*/
      },

      _hasActivityAccess: function (activity) {
        if (this.domainId) {
          return this.checkDomainAccess(activity.Domain)
        } else if (this.communityId) {
          return this.checkCommunityAccess(activity.Community)
        } else if (this.groupId) {
          return this.checkGroupAccess(activity.Group)
        } else if (this.postId) {
          return this.checkPostAccess(activity.Post)
        } else {
          return false;
        }
      },

      _activityDeletedResponse: function (event, detail) {
        var activityId = detail.response.activityId;
        this.set('activities', _.filter(this.activities, function(o) { return (o.id!=activityId) }));
      },

      _deleteActivity: function (event) {
        this.set('activityIdToDelete', event.model.activity.id);
        var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("confirmationDialog");
        dialog.open(this.t('activity.confirmDelete'), this._reallyDelete.bind(this));
      },

      _reallyDelete: function () {
        if (this.domainId) {
          this.$.deleteActivityAjax.url = "/api/domains/"+this.domainId+"/"+this.activityIdToDelete+"/delete_activity";
        } else if (this.communityId) {
          this.$.deleteActivityAjax.url = "/api/communities/"+this.communityId+"/"+this.activityIdToDelete+"/delete_activity";
        } else if (this.groupId) {
          this.$.deleteActivityAjax.url = "/api/groups/"+this.groupId+"/"+this.activityIdToDelete+"/delete_activity";
        } else if (this.postId) {
          this.$.deleteActivityAjax.url = "/api/posts/"+this.postId+"/"+this.activityIdToDelete+"/delete_activity";
        }
        this.$.deleteActivityAjax.body = {};
        this.$.deleteActivityAjax.generateRequest();
        this.set('activityIdToDelete', null);
      },

      _upVote: function (point) {
        if (point && point.value == 0) {
          return true;
        } else if (!point) {
          return false;
        } else {
          return point.value > 0;
        }
      },

      _downVote: function (point) {
        if (point && point.value == 0) {
          return true;
        } else if (!point) {
          return false;
        } else {
          return point.value < 0;
        }
      },

      _joinPost: function (event) {
        if (!this.postId) {
          if (event.model.activity.Post) {
            this.goToPost(event.model.activity.Post.id);
          } else if (event.model.activity.PostStatusChange) {
            this.goToPost(event.model.activity.PostStatusChange.post_id);
          }
        }
      },

      _getActivityWithPostTitle: function (activity) {
        return this.t(activity.type) + ' ' + activity.Post.name;
      },

      _isNotActivityType: function (activity, type) {
        return activity.type!=type
      },

      _isActivityType: function (activity, type) {
        return activity.type==type
      },

      _generateRequest: function (typeId, typeName) {
        if (typeId) {
          this.set('activities', []);
          this.set('oldestProcessedActivityAt', null);

          if (window.appUser && window.appUser.user) {
            this.mode = 'news_feeds';
          }

          this.set('url', '/api/'+this.mode+'/' + typeName + '/' + typeId);
          this.$.ajax.url = this.url;
          this.$.ajax.generateRequest();
          if (typeName!='posts') {
            this.$.recommendationAjax.url = '/api/recommendations/' + typeName + '/' + typeId;
            this.$.recommendationAjax.generateRequest();
          }
        }
      },

      _loadMoreData: function () {
        this.async(function () {
          if (this.$$("#ironList").offsetWidth > 0 && this.$$("#ironList").offsetHeight > 0) {
            if (this.url!='' && this.moreToLoad && this.oldestProcessedActivityAt) {
              this.set('moreToLoad', false);
              console.info("_loadMoreData for domainId: "+this.domainId+" communityId: "+this.communityId+" groupId: "+this.groupId+" postId: "+this.postId);
              this.$.ajax.url = this.url + '?beforeDate='+this.oldestProcessedActivityAt;
              this.$.ajax.generateRequest();
            }
          } else {
            console.warn("NOT VISIBLE for domainId: "+this.domainId+" communityId: "+this.communityId+" groupId: "+this.groupId+" postId: "+this.postId);
          }
        });
      },

      loadNewData: function () {
        if (this.url!='' && this.latestProcessedActivityAt) {
          this.$.ajax.url = this.url + '?afterDate='+this.latestProcessedActivityAt;
          this.$.ajax.generateRequest();
        } else if (!this.latestProcessedActivityAt) {
          this.$.ajax.url = this.url;
          this.$.ajax.generateRequest();
        }
      },

      _domainIdChanged: function (newValue) {
        this.set('activities', null);
        this.set('recommendedPosts', null);
        this._generateRequest(newValue, 'domains');
      },

      _communityIdChanged: function (newValue) {
        this.set('activities', null);
        this.set('recommendedPosts', null);
        this._generateRequest(newValue, 'communities');
      },

      _groupIdChanged: function (newValue) {
        this.set('activities', null);
        this.set('recommendedPosts', null);
        this._generateRequest(newValue, 'groups');
      },

      _postIdChanged: function (newValue) {
        this.set('activities', null);
        this.set('recommendedPosts', null);
        this._generateRequest(newValue, 'posts');
      },

      _clearScrollThreshold: function () {
        this.$$("#scrollTheshold").clearTriggers();
        console.info("Clearing scrolling triggers for activity");
      },

      _recommendedPostsResponse: function (event, detail) {
        this.set('recommendedPosts', detail.response);
      },

      _activitiesResponse: function (event, detail) {
        var activities = detail.response.activities;

        if (detail.response.oldestProcessedActivityAt) {
          this.set('oldestProcessedActivityAt', detail.response.oldestProcessedActivityAt);
        }

        activities.forEach(function(activity) {
          if ((activity.Post && activity.Post.deleted) || (activity.Point && activity.Point.deleted) ) {
            // deleted post
          } else {
            if (this.$.ajax.url.indexOf('afterDate') > -1) {
              this.unshift('activities', activity);
            } else {
              this.push('activities', activity);
            }
          }
        }.bind(this));

        /*this.async(function () {
          this.activities.forEach(function(activity, index) {
            this.$$("#ironList").updateSizeForItem(index);
          }.bind(this));
        }, 22);*/

        if (activities.length>0) {
          if (!this.latestProcessedActivityAt || this.latestProcessedActivityAt < activities[0].created_at) {
            this.set('latestProcessedActivityAt', activities[0].created_at);
          }
          this.set('moreToLoad', true);
          if (this.activities.length<12) {
            this._loadMoreData();
          }
        }

        var scrollThresholdEvent = new CustomEvent("iron-signal", { detail: { name: 'yp-refresh-activities-scroll-threshold', data: {} } } );
        document.dispatchEvent(scrollThresholdEvent);

        this.async(function () {
          this.$.ironList.updateViewportBoundaries();
          this.$.ironList.fire('iron-resize');
        }, 20);
      },

      fireResize: function () {
        console.log("fireResize");
        this.$.ironList.fire('iron-resize');
      }
    });
  </script>
</dom-module>
