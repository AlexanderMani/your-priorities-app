<link rel="import" href="../../bower_components/polymer/polymer.html">

<script src='../../bower_components/moment/min/moment.min.js'></script>
<script src='../../bower_components/moment/locale/is.js'></script>
<script src='../../bower_components/moment/locale/nb.js'></script>
<script src='../../bower_components/moment/locale/nl.js'></script>
<script src='../../bower_components/moment/locale/hu.js'></script>
<script src='../../bower_components/moment/locale/zh-tw.js'></script>
<script src='../../bower_components/moment/locale/sr.js'></script>
<script src='../../bower_components/moment/locale/hr.js'></script>
<script src='../../bower_components/moment/locale/sl.js'></script>
<script src='../../bower_components/moment/locale/pt.js'></script>
<script src='../../bower_components/moment/locale/pl.js'></script>

<script src="../../bower_components/linkifyjs/linkify.js"></script>
<script src="../../bower_components/linkifyjs/linkify-string.js"></script>
<script src='../../bower_components/lodash/lodash.js'></script>

<script>
  window.__ = _.noConflict();

  /** @polymerBehavior Polymer.appHelpers */
  Polymer.appHelpers = {

    properties: {
      t: {
        type: Function,
        computed: '_translate(loadedLanguage)'
      },

      language: {
        type: String,
        value: null
      },

      loadedLanguage: {
        type: String,
        value: null
      }
    },

    ready: function () {
      if (window.i18nTranslation) {
        this.set('loadedLanguage', window.locale);
        this.set('language', window.locale);
      }
    },

    _languageEvent: function (event, detail) {
      if (detail.type == 'language-loaded') {
        var oldLang= this.language;
        var oldLoaded = this.loadedLanguage;
        this.set('loadedLanguage', detail.language);
        this.set('language', detail.language);
        window.locale = detail.language;
      }
    },

    _translate: function (language) {
      return function() {
        var key = arguments[0];
        if (window.i18nTranslation) {
          var translation = window.i18nTranslation.t(key);
          if (translation=='')
            translation = key;
          return translation;
        } else {
          return key;
          //console.warn("Translation system i18n not initialized for "+key);
        }
      };
    },

    redirectTo: function (path) {
      //this.fire("yp-redirect-to", { path: path });
      window.history.pushState({}, null, path);
      window.dispatchEvent(new CustomEvent('location-changed'));
    },

    goToPost: function (postIdIn, pointId) {
      var postId;
      if (postIdIn && !(postIdIn instanceof Event)) {
        postId = postIdIn;
      } else if (this.post && this.post.id) {
        postId = this.post.id
      } else {
        console.error("Can't find post id for goToPost");
        return;
      }
      var postUrl = '/post/' + postId;
      if (pointId && !(postIdIn instanceof Event)) {
        postUrl += '/' + pointId;
      }
      var windowLocation = window.location.href;
      console.log(postUrl);
      console.log(windowLocation);
      if (windowLocation.indexOf(postUrl) == -1) {
        window.appGlobals.activity('open', 'post', postUrl);
        window.app.setKeepOpenForPostsOn(window.location.pathname);
        this.async(function () {
          this.redirectTo(postUrl);
        });
      }
    },

    cardMouseOver: function (event) {
      event.currentTarget.elevation = 5;
    },

    cardMouseOut: function (event) {
      event.currentTarget.elevation = 1;
    },

    getImageFormatUrl: function(images, formatId) {
      if (images && images.length>0) {
        var formats = JSON.parse(images[images.length-1].formats);
        if (formats && formats.length>0)
          return formats[formatId];
      } else {
        return "";
      }
    },

    removeClass: function(element, classToRemove) {
      var newClassName = "";
      var classes = element.className.split(" ");
      for(var i = 0; i < classes.length; i++) {
        if(classes[i] !== classToRemove) {
          newClassName += classes[i] + " ";
        }
      }
      element.className = newClassName;
    },

    formatNumber: function (value) {
      if (value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      } else {
        return "0";
      }
    },

    truncate: function (input, length, killwords, end) {
      var orig = input;
      length = length || 255;

      if (input.length <= length)
        return input;

      if (killwords) {
        input = input.substring(0, length);
      } else {
        var idx = input.lastIndexOf(' ', length);
        if (idx === -1) {
          idx = length;
        }

        input = input.substring(0, idx);
      }

      input += (end !== undefined && end !== null) ? end : '...';
      return input;
    },

    trim: function(input){
      return input.replace(/^\s*|\s*$/g, '');
    }
  };
</script>
