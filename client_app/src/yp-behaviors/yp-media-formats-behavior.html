<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
  /** @polymerBehavior Polymer.ypMediaFormatsBehavior */
  Polymer.ypMediaFormatsBehavior = {

    properties: {
      playStartedAt: {
        type: Date,
        value: null
      }
    },

    _checkVideoLongPlayTimeAndReset(videoPlayer) {
      var videoId = videoPlayer.getAttribute('data-id');
      if (this.playStartedAt && videoId) {
        var seconds = (new Date().getTime() - this.playStartedAt.getTime()) / 1000;
        if (seconds>5) {
          window.appGlobals.sendLongVideoView(videoId)
        }
        window.appGlobals.activity("completed",'video',seconds);
        this.playStartedAt = null;
      } else if (this.playStartedAt) {
        console.error("Got long view check without id");
        this.playStartedAt = null;
      }
    },

    _checkAudioLongPlayTimeAndReset(audioPlayer) {
      var audioId = audioPlayer.getAttribute('data-id');
      if (this.playStartedAt && audioId) {
        var seconds = (new Date().getTime() - this.playStartedAt.getTime()) / 1000;
        if (seconds>5) {
          window.appGlobals.sendLongAudioListen(audioId)
        }
        window.appGlobals.activity("completed",'audio',seconds);
        this.playStartedAt = null;
      } else if (this.playStartedAt) {
        console.error("Got long view check without audio id");
        this.playStartedAt = null;
      }
    },

    getImageFormatUrl: function(images, formatId) {
      if (images && images.length>0) {
        var formats = JSON.parse(images[images.length-1].formats);
        if (formats && formats.length>0)
          return formats[formatId];
      } else {
        return "";
      }
    },

    attached: function () {
      this.async(function () {
        var videoPlayer = this.$$("#videoPlayer");
        var audioPlayer = this.$$("#audioPlayer");
        if (videoPlayer) {
          var videoId = videoPlayer.getAttribute('data-id');
          if (videoId) {
            videoPlayer.addEventListener("play", function () {
              this.set('playStartedAt', new Date());
              window.appGlobals.sendVideoView(videoId)
            }.bind(this));
            videoPlayer.addEventListener("pause", function () {
              this._checkVideoLongPlayTimeAndReset(videoPlayer);
            }.bind(this));
            videoPlayer.addEventListener("ended", function () {
              this._checkVideoLongPlayTimeAndReset(videoPlayer);
            }.bind(this));
          }
        } else if (audioPlayer) {
          var audioId = audioPlayer.getAttribute('data-id');
          if (audioId) {
            audioPlayer.addEventListener("play", function () {
              this.set('playStartedAt', new Date());
              window.appGlobals.sendAudioListen(audioId)
            }.bind(this));
            audioPlayer.addEventListener("pause", function () {
              this._checkAudioLongPlayTimeAndReset(audioPlayer);
            }.bind(this));
            audioPlayer.addEventListener("ended", function () {
              this._checkAudioLongPlayTimeAndReset(audioPlayer);
            }.bind(this));
          }
        }
      }, 500);
    },

    detached: function () {
      var videoPlayer = this.$$("#videoPlayer");
      var audioPlayer = this.$$("#audioPlayer");
      if (videoPlayer) {
        videoPlayer.removeEventListener("play");
        videoPlayer.removeEventListener("pause");
        videoPlayer.removeEventListener("ended");
        this._checkVideoLongPlayTimeAndReset(videoPlayer);
      } else if (audioPlayer) {
        audioPlayer.removeEventListener("play");
        audioPlayer.removeEventListener("pause");
        audioPlayer.removeEventListener("ended");
        this._checkVideoLongPlayTimeAndReset(audioPlayer);
      }
    },

    _pauseMediaPlayback: function () {
      var videoPlayer = this.$$("#videoPlayer");
      var audioPlayer = this.$$("#audioPlayer");
      if (videoPlayer) {
        videoPlayer.pause();
      }
      if (audioPlayer) {
        audioPlayer.pause();
      }
    },

    _getVideoURL: function (videos) {
      if (videos &&
          videos.length>0 &&
          videos[0].formats &&
          videos[0].formats.length>0) {
        return videos[0].formats[0];
      } else {
        return null;
      }
    },

    _getAudioURL: function (audios) {
      if (audios &&
          audios.length>0 &&
          audios[0].formats &&
          audios[0].formats.length>0) {
          return audios[0].formats[0];
      } else {
        return null;
      }
    },

    _getVideoPosterURL: function (videos, selectedImageIndex) {
      if (!selectedImageIndex)
        selectedImageIndex = 0;
      if (videos &&
        videos.length>0 &&
        videos[0].VideoImages &&
        videos[0].VideoImages.length>0) {
          return JSON.parse(videos[0].VideoImages[0].formats)[selectedImageIndex];
      } else {
        return null;
      }
    }
  };
</script>
