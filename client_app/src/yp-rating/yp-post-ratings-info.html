<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">

<link rel="import" href="../../bower_components/paper-share-button/paper-share-button.html">

<link rel="import" href="../yp-app-globals/yp-app-icons.html">
<link rel="import" href="../yp-behaviors/yp-language-behavior.html">
<link rel="import" href="../yp-behaviors/yp-number-format-behavior.html">
<link rel="import" href="../yp-behaviors/yp-remove-class-behavior.html">
<link rel="import" href="../yp-behaviors/yp-goto-behavior.html">
<link rel="import" href="yp-rating.html">

<dom-module id="yp-post-ratings-info">

  <template>

    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      .ratingsCount {
        font-size: 0.6em;
        color: #aaa;
      }

      .ratingContainer {
        margin-left: 16px;
        margin-bottom: 4px;
      }

      .ratingContainer[widtha] {
        width: 105px;
      }

      .ratingContainer[widthb] {
        width: 95px;
      }

      .ratingContainer[widthc] {
        width: 85px;
      }

      .ratingContainer[widthd] {
        width: 70px;
      }

      .ratingContainerMain {
        text-align: right;
        margin-right: 8px;
        max-width: 230px;
      }

      .topDiv {
        cursor: pointer;
      }

      [hidden] {
        display: none !important;
      }
    </style>
    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>

    <iron-media-query query="(max-width: 420px)" query-matches="{{small}}"></iron-media-query>
    <div class="layout vertical center-center topDiv" aria-label="[[t('evaluatePost')]" title="[[t('evaluatePost')]]" on-tap="openRatingsDialog">
      <div id="ratingContainerMain" class="ratingContainerMain layout horizontal center-center  wrap" style="display: flex; justify-content: flex-end" card-mode$="[[cardMode]]">
        <template is="dom-repeat" items="[[customRatings]]" as="rating">
          <div class="layout horizontal ratingContainer" widtha$="[[hasWidthA]]" widthb$="[[hasWidthB]]" widthc$="[[hasWidthC]]" widthd$="[[hasWidthD]]">
            <yp-rating title$="[[rating.name]]" read-only post-id="[[post.id]]"
                       rating-index="[[index]]"
                       emoji="[[rating.emoji]]"
                       rate="[[getRating(index)]]"
                       number-of="[[rating.numberOf]]"></yp-rating>
            <div class="ratingsCount">[[getRatingsCount(index)]]</div>
          </div>
        </template>
      </div>
    </div>
    <lite-signal on-lite-signal-got-endorsements-and-qualities="_updateEndorsementsFromSignal"></lite-signal>
  </template>
  <script>
    Polymer({
      is: 'yp-post-ratings-info',

      behaviors: [
        Polymer.ypLanguageBehavior,
        Polymer.ypNumberFormatBehavior,
        Polymer.ypRemoveClassBehavior,
        Polymer.ypGotoBehavior
      ],

      properties: {
        post: {
          type: Object,
          observer: '_onPostChanged'
        },

        hasWidthA: {
          type: Boolean,
          value: false
        },

        hasWidthB: {
            type: Boolean,
            value: false
        },

        hasWidthC: {
            type: Boolean,
            value: false
        },

        hasWidthD: {
            type: Boolean,
            value: false
        },

        active: {
          type: Boolean,
          value: false
        },

        allDisabled: {
          type: Boolean,
          value: false
        },

        votingDisabled: {
          type: Boolean,
          value: false
        },

        postUrl: {
          type: String,
          computed: '_postUrl(post)'
        },

        customRatings: Array
      },

      getRating: function (ratingIndex) {
        if (this.post.public_data && this.post.public_data.ratings && this.post.public_data.ratings[ratingIndex])
          return this.post.public_data.ratings[ratingIndex].averageRating;
        else
          return 0;
      },

      getRatingsCount: function (ratingIndex) {
        if (this.post.public_data && this.post.public_data.ratings && this.post.public_data.ratings[ratingIndex])
          return this.formatNumber(this.post.public_data.ratings[ratingIndex].count);
//          return this.formatNumber(1*(Math.floor(Math.random() * 10000) + 1)) //this.formatNumber(this.post.public_data.ratings[ratingIndex].count);
        else
          return 0;
        debugger;
      },

      _fireRefresh: function () {
        this.fire("refresh", {id: this.post.id});
      },

      openRatingsDialog: function () {
        window.appGlobals.activity('open', 'post.ratings');
        if (window.appUser.loggedIn()===true) {
          Polymer.dom(document).querySelector('yp-app').getRatingsDialogAsync(function (dialog) {
            dialog.open(this.post, this._fireRefresh.bind(this));
          }.bind(this));
        } else {
          window.appUser.loginForRatings(this);
        }
      },

      _postUrl: function (post) {
        if (post) {
          return encodeURIComponent("https://"+window.location.host+"/post/"+post.id);
        } else {
          console.warn("Can't find post for action");
          return "";
        }
      },

      _onPostChanged: function (post, oldValue) {
        console.error("Changed");
        this.set('isEndorsed', false);
        if (post) {
          if (post.Group.configuration && post.Group.configuration.customRatings) {
              this.set('customRatings', []);
              this.async(function () {
                  this.set('customRatings', post.Group.configuration.customRatings);
              });

              var maxCount = 0;
              if (this.post.public_data && this.post.public_data.ratings) {
                  if (this.post.public_data.ratings[0])
                    this.post.public_data.ratings[0].count=1*(Math.floor(Math.random() * 1000) + 1);
                  if (this.post.public_data.ratings[1])
                    this.post.public_data.ratings[1].count=1*(Math.floor(Math.random() * 1000) + 1);
                  if (this.post.public_data.ratings[2])
                    this.post.public_data.ratings[2].count=1*(Math.floor(Math.random() * 1000) + 1);
                  if (this.post.public_data && this.post.public_data.ratings) {
                      Object.values(this.post.public_data.ratings).forEach(function (item) {
                          if (item.count>maxCount) {
                              maxCount=item.count;
                          }
                      }.bind(this));
                  }
              }

              console.error(maxCount);
              if (maxCount>100000) {
                this.set('hasWidthA', true);
                this.set('hasWidthB', false);
                this.set('hasWidthC', false);
                this.set('hasWidthD', false);
                this.$$("#ratingContainerMain").style.maxWidth="255px";
                console.error("maxCount>100000")
              } else if (maxCount>1000) {
                this.set('hasWidthA', false);
                this.set('hasWidthB', true);
                this.set('hasWidthC', false);
                this.set('hasWidthD', false);
                this.$$("#ratingContainerMain").style.maxWidth="245px";
                console.error("maxCount>1000")
              } else if (maxCount>10) {
                this.set('hasWidthA', false);
                this.set('hasWidthB', false);
                this.set('hasWidthC', true);
                this.set('hasWidthD', false);
                this.$$("#ratingContainerMain").style.maxWidth="210px";
                console.error("maxCount>10")
             }  else {
                this.set('hasWidthA', false);
                this.set('hasWidthB', false);
                this.set('hasWidthC', false);
                this.set('hasWidthD', true);
                this.$$("#ratingContainerMain").style.maxWidth="195px";
                console.error("maxCount<=10")
              }
          }
          if (post.Group.configuration && post.Group.configuration.canVote!=undefined && post.Group.configuration.canVote==false) {
              this.set('votingDisabled', true);
              this.set('allDisabled', true);
              this.set('disabledTitle', this.t('votingDisabled'));
          } else {
              this.set('votingDisabled', false);
              this.set('allDisabled', false);
          }

          if (post.Group.configuration) {
              this.set('post.Group.configuration.originalHideVoteCount', post.Group.configuration.hideVoteCount);
              if (post.Group.configuration.hideVoteCountUntilVoteCompleted) {
                  this.set('post.Group.configuration.hideVoteCount', true);
              }
          }
        } else {
          this.set('customRatings', post.Group.configuration.null);
          console.warn("No post found for post actions");
        }
      },

      _updateEndorsementsFromSignal: function () {
        if (this.post) {
          this._updateEndorsements(this.post);
        } else {
          this.async(function () {
            if (this.post) {
              this._updateEndorsements(this.post);
            } else {
              console.warn("Trying to update post null from signal");
            }
          }, 50);
        }
      },

      _updateEndorsements: function (post) {
        this.set('isEndorsed', false);
        if (window.appUser && window.appUser.loggedIn() && window.appUser.user && window.appUser.user.Endorsements) {
          var thisPostsEndorsement = window.appUser.endorsementPostsIndex[post.id];
          if (thisPostsEndorsement)
            this._setEndorsement(thisPostsEndorsement.value);
          else
            this._setEndorsement(0);
        }
      },

    });
  </script>
</dom-module>
