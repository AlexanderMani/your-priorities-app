<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../yp-user/yp-user-info.html">

<dom-module id="yp-language-selector">

  <template>

    <style include="iron-flex iron-flex-alignment">

      .language {
        margin-top: 16px;
      }

      .languageSelection {
        margin-top: 16px;
        font-weight: bold;
      }

      paper-button {
        height: 15px;

      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <div class="layout vertical center-center">

    <paper-dropdown-menu label="[[t('selectLanguage')]]" selected="{{selectedLocale}}" attr-for-selected="name">
      <paper-listbox class="dropdown-content" selected="{{selectedLocale}}"  attr-for-selected="name">
        <template is="dom-repeat" items="[[languages]]">
          <paper-item name="[[item.language]]">[[item.name]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </template>

  <script>
    Polymer({

      is: 'yp-language-selector',

      behaviors: [
        Polymer.appHelpers
      ],

      properties: {
        supportedLanguages: {
          type: Object,
          value: {
            en: 'English',
            is: '√çslenska',
            no: 'Norwegian',
            hr: 'Croatian',
            sl: 'Slovenian',
            pt: 'Portuguese',
            pl: 'Polish'
          }
        },

        languages: {
          type: Array,
          computed: '_languages(supportedLanguages)'
        },

        selectedLocale: {
          type: String,
          observer: '_selectedLocaleChanged'
        },

        noUserEvents: {
          type: Boolean,
          value: false
        }
      },

      _languages: function (supportedLanguages) {
        if (supportedLanguages) {
          var arr = [];
          for (var key in supportedLanguages) {
            if (supportedLanguages.hasOwnProperty(key)) {
              arr.push({ language: key, name: supportedLanguages[key] });
            }
          }
          return arr;
        } else {
          return [];
        }
      },

      _selectedLocaleChanged: function (locale) {
        if (!this.noUserEvents) {
          localStorage.setItem('yp-user-locale', locale);
          i18n.init({ lng: locale, resGetPath: '/locales/__lng__/__ns__.json' }, function(loaded) {
            var event = new CustomEvent("iron-signal", { detail: { name: 'yp-language', data: { type: 'language-loaded', language: locale } } } );
            document.dispatchEvent(event);
            window.appUser.setLocale(locale);
          });
          if (window.appUser && window.appUser.user) {
            window.appUser.setLocale(locale);
          }
        }
      }
    });
  </script>
</dom-module>
