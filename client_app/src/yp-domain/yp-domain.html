<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/collection-helpers.html">

<link rel="import" href="../yp-behaviors/yp-scroll-tab-behavior.html">
<link rel="import" href="../yp-theme/yp-theme-behavior.html">

<link rel="import" href="../ac-activities/ac-activities.html">

<link rel="import" href="../yp-post/yp-post.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-community/yp-community-card.html">
<link rel="import" href="../yp-community/yp-community-card-add.html">
<link rel="import" href="../yp-page/yp-page.html">
<link rel="import" href="../yp-other-social-media/yp-other-social-media.html">
<link rel="import" href="../yp-community/yp-community-grid.html">
<link rel="import" href="../yp-community/yp-community-collection-behaviors.html">

<link rel="import" href="yp-domain-large-card.html">

<dom-module id="yp-domain">
  <template>
    <style>

      ac-activities {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      .card-container {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .card {
        padding: 16px;
      }

      @media (max-width: 330px) {
        .card {
          padding-left: 0;
          padding-right: 0;
          padding-bottom: 8px;
          padding-top: 8px;
        }

        .card-container {
          padding: 0;
          margin: 0;
        }
      }

      yp-ajax {
        background-color: var(--primary-background-color);
      }

      .twitterFeed {
        margin-top: 24px;
      }

      .archivedText {
        font-size: 26px;
        color: #333;
      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <yp-page id="page" create-fab-icon="[[createFabIcon]]" create-fab-title="[[t('community.add')]]" on-yp-create-fab-tap="_newCommunity">

      <yp-domain-large-card id="domainCard" class="largeCard card" domain="[[domain]]" on-update-domain="_refresh"></yp-domain-large-card>

      <paper-tabs id="paper_tabs" class="tabs" selected="{{selected}}" focused>
        <paper-tab class="tab"><span>[[t('communities')]]</span> &nbsp; (<span>[[communitiesLength]]</span>)</paper-tab>
        <paper-tab class="tab">[[t('news')]]</paper-tab>
        <paper-tab class="tab">
          <div class="layout vertical center-center">
            <div>[[t('other')]]</div>
            <div>[[t('socialMedia')]]</div>
          </div>
        </paper-tab>
      </paper-tabs>

      <iron-pages class="tabPages" selected="{{selected}}" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
        <section class="layout vertical">
          <div class="card-container layout center-center wrap">
            <yp-community-grid
              featured-communities="[[featuredCommunities]]"
              active-communities="[[activeCommunities]]"
              archived-communities="[[archivedCommunities]]">
            </yp-community-grid>
          </div>
          <yp-community-card-add hidden$="[[!createFabIcon]]" class="card" on-tap="_newCommunity"></yp-community-card-add>
        </section>
        <section>
          <ac-activities domain-id="[[domain.id]]"></ac-activities>
        </section>
        <section class="layout vertical">
          <yp-other-social-media active="[[otherSocialMediaActive]]"></yp-other-social-media>
        </section>
      </iron-pages>
    </yp-page>

    <yp-ajax id="ajax" url="[[url]]" on-response="_response"></yp-ajax>
    <yp-ajax id="pagesAjax" on-response="_pagesResponse"></yp-ajax>

  </template>

  <script>
    Polymer({

      is: 'yp-domain',

      behaviors: [
        Polymer.appHelpers,
        Polymer.ypThemeBehavior,
        Polymer.CommunityCollectionBehaviors,
        Polymer.CollectionHelpers,
        Polymer.AccessHelpers
      ],

      properties: {

        createFabIcon: {
          type: String,
          value: null,
          notify: true
        },

        domainId: {
          type: Number,
          value: null,
          observer: "_domainIdChanged"
        },

        url: {
          type: String
        },

        domainEmpty: {
          type: Boolean,
          value: false
        },

        domain: {
          type: Object
        },

        hideAdd: {
          type: Boolean,
          value: true
        },

        selected: {
          type: Number,
          value: 0,
          observer: '_selectedChanged'
        },

        otherSocialMediaActive: {
          type: Boolean,
          value: false
        },

        domainTabName: {
          type: String,
          value: null,
          observer: '_tabNameChanged'
        }
      },

      _tabNameChanged: function (newValue) {
        if (newValue) {
          if (newValue=='communities') {
            this.set('selected', 0);
          } else if (newValue=='news') {
            this.set('selected', 1);
          } else if (newValue=='other_social_media') {
            this.set('selected', 2);
          }
        }
      },

      _selectedChanged: function (newValue) {
        if (newValue==2) {
          this.set('otherSocialMediaActive', true);
        } else {
          this.set('otherSocialMediaActive', false);
        }

        if (this.domain) {
          if (newValue == 0) {
            this.redirectTo("/domain/" + this.domain.id + '/communities');
          } else if (newValue == 1) {
            this.redirectTo("/domain/" + this.domain.id + '/news');
          } else if (newValue == 2) {
            this.redirectTo("/domain/" + this.domain.id + '/other_social_media');
          }
        }
      },

      _domainIdChanged: function (newValue, oldValue) {
        if (newValue) {
          this.set("featuredCommunities",null);
          this.set("activeCommunities",null);
          this.set("archivedCommunities",null);
          this.$.ajax.url = '/api/domains/' + this.domainId;
          this.$.ajax.generateRequest();
          this.hideAdd = true;
        }
      },

      _refresh: function () {
        this.$.ajax.generateRequest();
      },

      _newCommunity: function () {
        window.appGlobals.activity('open', 'newCommunity');
        var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("communityEdit");
        dialog.setup(null, true, null);
        dialog.open('new', { domainId: this.domainId });
      },

      _pagesResponse: function (event, detail) {
        this.fire('yp-set-pages', detail.response);
      },

      _response: function (event, detail, sender) {
        this.set('domain', detail.response);
        this.fire('yp-set-home-link', { type: 'domain', id: this.domain.id, name: this.domain.name });
        window.appGlobals.domain = this.domain;
        if (this.domain.theme_id!=null) {
          this.setTheme(this.domain.theme_id);
        }

        if (!this.domain.only_admins_can_create_communities || this.checkDomainAccess(this.domain)) {
          this.set('createFabIcon', 'group-work');
        }

        this.$.pagesAjax.url = "/api/domains/"+this.domain.id+"/pages";
        this.$.pagesAjax.generateRequest();

        window.appGlobals.setupGoogleAnalytics(this.domain);
        if (this.domain.DomainHeaderImages && this.domain.DomainHeaderImages.length>0) {
          this.$.page.setupTopHeaderImage(this.domain.DomainHeaderImages);
        }
        if (this.domain.Communities) {
          this.setupCommunities(_.dropRight(this.domain.Communities, this.domain.Communities.length-15));
        }

        this.$.domainCard.setElevation(5);
        this.$.domainCard.lowerCardLater();

        this.fire("change-header", { headerTitle: null, documentTitle: this.domain.name,
                                     headerDescription: this.domain.description});

        if (this.activeCommunities.length>0) {
          this.hideAdd = true;
        } else {
          this.hideAdd = false;
        }
      }

    });
  </script>
</dom-module>
