<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">

<link rel="import" href="../yp-behaviors/yp-language-behavior.html">

<script src="../../bower_components/twemoji-min/2/twemoji.min.js"></script>
<script type="text/javascript" src="sanitize-html.min.js"></script>

<dom-module id="yp-magic-text">
  <template>
    <style>
      :host {
        display: inline;
      }
    </style>
    <div inner-h-t-m-l="[[finalContent]]"></div>
    <div hidden$="[[finalContent]]">[[content]]</div>
    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>
    <lite-signal on-lite-signal-yp-auto-translate="_autoTranslateEvent"></lite-signal>

    <iron-ajax id="getTranslationAjax" on-response="_getTranslationResponse" on-error="_getTranslationError"></iron-ajax>
  </template>

  <script>

    class YpMagicTextBox extends Polymer.Element {
      static get is() { return 'yp-magic-text'; }

      static get properties() {
        return {

          content: {
            type: String,
            observer: '_contentChanged'
          },

          processedContent: {
            type: String,
            value: null
          },

          finalContent: {
            type: String,
            value: null
          },

          textType: {
            type: String
          },

          contentLanguage: {
            type: String
          },

          autoTranslate: {
            type: Boolean,
            value: true
          },

          language: {
            type: String,
            value: null
          }
        }
      }

      _contentChanged(newValue) {
        console.error("Content changed: "+newValue);
        if (newValue && newValue!=="") {
          this.set('finalContent', null);
          this._update();
        }
      }

      _autoTranslateEvent(event, detail) {
        if (detail===true) {
          this.set('autoTranslate', true);
        } else {
          this.set('autoTranslate', false);
        }
        this._update();
      }

      _languageEvent (event, detail) {
        if (detail.type === 'language-loaded') {
          if (this.language!==detail.language) {
            this.set('language', detail.language);
            this._update();
          } else {
            this.set('language', detail.language);
          }
        }
      }

      _startTranslationAndFinalize () {
        let indexKey = `${this.textType}-${this.contentId}-${this.language}`;
        if (window.appGlobals.autoTranslateCache[indexKey]) {
          this.set('processedContent', window.appGlobals.autoTranslateCache[indexKey]);
          this._finalize();
        } else {
          this.$.getTranslationAjax.params = {
            textType: this.textType,
            contentId: this.contentId,
            targetLanguage: this.language
          };
          switch(this.textType) {
            case 'postName':
            case 'postContent':
              this.$.getTranslationAjax.url = "/api/posts/"+this.contentId+"/translatedText";
              break;
            case 'pointContent':
              this.$.getTranslationAjax.url = "/api/points/"+this.contentId+"/translatedText";
              break;
            case 'domainName':
            case 'domainContent':
              this.$.getTranslationAjax.url = "/api/domains/"+this.contentId+"/translatedText";
              break;
            case 'communityName':
            case 'communityContent':
              this.$.getTranslationAjax.url = "/api/communities/"+this.contentId+"/translatedText";
              break;
            case 'groupName':
            case 'groupContent':
              this.$.getTranslationAjax.url = "/api/groups/"+this.contentId+"/translatedText";
              break;
            case 'categoryName':
              this.$.getTranslationAjax.url = "/api/categories/"+this.contentId+"/translatedText";
              break;
            case 'statusChangeContent':
              this.$.getTranslationAjax.url = "/api/post_status_changes/"+this.contentId+"/translatedText";
              break;
            default:
              console.error("No valid textType for magic text: "+this.textType);
              return;
          }
          this.$.getTranslationAjax.generateRequest();
        }
      }

      _getTranslationResponse(event, detail) {
        console.error("Get response: "+detail.response.content);
        if (detail.response.content) {
          this.processedContent = detail.response.content;
        } else {
          console.error("No content for magic text");
        }
        this._finalize();
      }

      _update() {
        this.processedContent = this.content;
        if (this.autoTranslate && this.language!==this.contentLanguage) {
          this._startTranslationAndFinalize();
        } else {
          this._finalize();
        }
      }

      _finalize() {
        if (!this.textOnly) {
          this._linksAndEmojis()
        }
        this.set('finalContent', this.processedContent);
      }

      _linksAndEmojis () {
        this.processedContent = sanitizeHtml(this.processedContent, { allowedTags: [ 'b', 'i', 'em', 'strong'] });
        this.processedContent = linkifyStr(this.processedContent, {
          format: function (value, type) {
            if (type === 'url' && value.length > 34) {
              value = value.slice(0, 35) + 'â€¦';
            }
            return value;
          },
          ignoreTags: [
            'b',
            'i',
            'em',
            'strong'
          ]
        });
        this.processedContent = twemoji.parse(this.processedContent).
                 replace(/&amp\;quot\;/g,"\"").
                 replace(/class=\"emoji\" /g,'style="height: 1em;width: 1em;margin: 0 .3em 0 .3em;vertical-align: -0.1em;" ');
      }

      ready () {
        if (window.i18nTranslation) {
          this.set('language', window.locale);
        }
        super.ready();
      }
    }

    customElements.define(YpMagicTextBox.is, YpMagicTextBox);
  </script>
</dom-module>