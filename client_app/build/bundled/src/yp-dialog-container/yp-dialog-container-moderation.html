<div hidden=""by-polymer-bundler=""><dom-module id="yp-content-moderation"assetpath="../yp-moderation/"><template><style include="iron-flex iron-flex-alignment">#dialog{width:100%;height:100%;margin:0;top:unset !important;left:unset !important;background-color:#FFF;}.itemItem{padding-right:16px;}.id{width:40px;}.name{width:200px;}.email{width:190px;overflow-wrap:break-word;}.addDeletedButtons{width:150px;}[hidden]{display:none !important;}paper-listbox{margin-right:8px !important;}.headerBox{background-color:var(--accent-color);color:#FFF;margin:0;padding:0 0;padding-top:12px;padding-bottom:10px;}paper-button{margin-left:8px;}#grid{margin-top:0;}.headerText{padding:0 0 !important;}.collectionName{font-size:22px;margin-bottom:1px;margin-top:4px;}.innerHeader{font-size:17px;color:#F5F5F5;}.closeButton{width:50px;height:50px;margin-left:4px;margin-right:4px;}paper-checkbox{color:#FFF !important;margin-top:16px;margin-right:24px;--primary-color:#FFF;--primary-text-color:#FFF;--paper-checkbox-checked-ink-color:#FFF;--paper-checkbox-unchecked-ink-color:#FFF;}@media (max-width: 600px){.closeButton{width:45px;height:45px;}paper-listbox{margin-right:8px;}#dialog{width:100%;height:100%;margin:0;padding:0;}.headerText{font-size:20px;line-height:1.2em;text-align:center;}}.details{display:flex;margin:8px;}yp-point{min-height:100px;max-width:500px;margin-bottom:8px;}yp-post-header{margin-bottom:8px;}paper-button{font-size:18px;margin-top:16px;}.analysis{margin-top:12px;color:#656565;}.leftColumn{padding-right:16px;}.mainScore{color:#000;}paper-spinner{margin-left:20px;margin-top:8px;--paper-spinner-layer-1-color:#FFF;--paper-spinner-layer-2-color:#FFF;--paper-spinner-layer-3-color:#FFF;--paper-spinner-layer-4-color:#FFF;}.linkIcon{color:#000;}vaadin-grid{font-size:14px;}</style><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><paper-dialog id="dialog"modal=""><div class="layout horizontal headerBox wrap"><div><paper-icon-button aria-label$="[[t('close')]]"id="dismissBtn"icon="close"class="closeButton"dialog-dismiss=""></paper-icon-button></div><div class="headerText layout vertical"><div class="layout horizontal"><div class="collectionName">[[collectionName]]</div></div><div class="innerHeader">[[headerText]] <span hidden$="[[!totalItemsCount]]">([[totalItemsCount]] [[itemsCountText]])</span></div></div><div hidden$="[[!spinnerActive]]"><paper-spinner active=""></paper-spinner></div><div class="flex"></div><div class="checkBox"hidden$="[[narrow]]"><paper-checkbox checked="{{multiSortEnabled}}">[[t('multiSortEnabled')]]</paper-checkbox></div><div hidden$="[[!showReload]]"><paper-icon-button aria-label$="[[t('reload')]]"icon="autorenew"class="closeButton"on-tap="_reload"></paper-icon-button></div></div><vaadin-grid id="grid"multi-sort="[[multiSortEnabled]]"active-item="{{activeItem}}"aria-label$="[[headerText]]"items="[[items]]"selected-items="{{selectedItems}}"><vaadin-grid-selection-column></vaadin-grid-selection-column><template class="row-details"><div class="details layout vertical center-center detailArea"><div class="layout horizontal"><template is="dom-if"if="[[item.is_post]]"><div class="layout vertical center-center"><yp-post-header hide-actions=""post="[[item]]"post-name="[[item.name]]"header-mode=""></yp-post-header><a href="/post/[[item.id]]"target="_blank"><paper-icon-button aria-label$="[[t('linkToContentItem')]]"class="linkIcon"icon="link"></paper-icon-button></a></div></template><template is="dom-if"if="[[item.is_point]]"><div class="layout vertical center-center"><yp-point hide-actions=""point="[[item]]"></yp-point><a hidden$="[[!item.post_id]]"href="/post/[[item.post_id]]/[[item.id]]"target="_blank"><paper-icon-button aria-label$="[[t('linkToContentItem')]]"class="linkIcon"icon="link"></paper-icon-button></a></div></template></div><div hidden$="[[!item.toxicityScore]]"class="layout horizontal analysis"><div class="layout vertical leftColumn"hidden$="[[userId]]"><div class="mainScore"hidden$="[[!item.moderation_data.moderation.toxicityScore]]">Toxicity Score: [[_toPercent(item.moderation_data.moderation.toxicityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.identityAttackScore]]">Identity Attack Score: [[_toPercent(item.moderation_data.moderation.identityAttackScore)]]</div><div hidden$="[[!item.moderation_data.moderation.identityAttachScore]]">Identity Attack Score: [[_toPercent(item.moderation_data.moderation.identityAttachScore)]]</div><div hidden$="[[!item.moderation_data.moderation.threatScore]]">Threat Score: [[_toPercent(item.moderation_data.moderation.threatScore)]]</div><div hidden$="[[!item.moderation_data.moderation.insultScore]]">Insult Score: [[_toPercent(item.moderation_data.moderation.insultScore)]]</div></div><div class="layout vertical"hidden$="[[userId]]"><div class="mainScore"hidden$="[[!item.moderation_data.moderation.severeToxicityScore]]">Severe Toxicity Score: [[_toPercent(item.moderation_data.moderation.severeToxicityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.profanityScore]]">Profanity Score: [[_toPercent(item.moderation_data.moderation.profanityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.sexuallyExplicitScore]]">Sexually Excplicit Score: [[_toPercent(item.moderation_data.moderation.sexuallyExplicitScore)]]</div><div hidden$="[[!item.moderation_data.moderation.flirtationScore]]">Flirtation Score: [[_toPercent(item.moderation_data.moderation.flirtationScore)]]</div></div></div></div></template><vaadin-grid-sort-column width="130px"flex-grow="0"path="firstReportedDate"header="[[t('firstReported')]]"hidden$="[[onlyFlaggedItems]]"><template>[[item.firstReportedDateFormatted]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="130px"flex-grow="0"path="lastReportedAtDate"header="[[t('lastReported')]]"hidden$="[[userId]]"><template>[[item.lastReportedAtDateFormatted]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="start"flex-grow="0"path="type"header="[[t('type')]]"><template>[[_getType(item.type)]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="start"flex-grow="0"path="status"header="[[t('publishStatus')]]"><template>[[item.status]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="center"flex-grow="0"path="counter_flags"header="[[t('flags')]]"hidden$="[[userId]]"><template>[[item.counter_flags]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="130px"text-align="start"flex-grow="0"path="source"header="[[t('source')]]"hidden$="[[!onlyFlaggedItems]]"><template>[[item.source]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="105px"text-align="center"flex-grow="0"path="toxicityScoreRaw"header="[[t('toxicityScore')]]?"hidden$="[[userId]]"><template>[[item.toxicityScore]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="150px"text-align="start"flex-grow="1"path="groupName"header="[[t('groupName')]]"hidden$="[[!userId]]"><template>[[item.groupName]]</template></vaadin-grid-sort-column><vaadin-grid-filter-column width="200px"flex-grow="4"path="content"header="[[t('content')]]"hidden$="[[narrow]]"><template><div class="layout horizontal"><yp-magic-text content-id="[[item.id]]"content="[[item.pointTextContent]]"text-type="pointContent"></yp-magic-text><yp-magic-text content-id="[[item.id]]"content="[[item.postNameContent]]"text-type="postName"></yp-magic-text>&nbsp;<yp-magic-text content-id="[[item.id]]"content="[[item.postTextContent]]"text-type="postContent"></yp-magic-text>&nbsp;<yp-magic-text content-id="[[item.id]]"content="[[item.postTranscriptContent]]"text-type="postTranscriptContent"></yp-magic-text></div></template></vaadin-grid-filter-column><vaadin-grid-filter-column flex-grow="1"path="user_email"width="150px"header="[[t('creator')]]"hidden$="[[userId]]"><template>[[item.user_email]]</template></vaadin-grid-filter-column><vaadin-grid-filter-column flex-grow="0"path="lastReportedByEmail"width="150px"header="[[t('flaggedBy')]]"hidden$="[[!onlyFlaggedItems]]"></vaadin-grid-filter-column><vaadin-grid-column width="70px"flex-grow="0"><template class="header"><paper-menu-button horizontal-align="right"on-opened-changed="_refreshGridAsyncDelay"class="helpButton"disabled$="[[selectedItemsEmpty]]"><paper-icon-button aria-label$="[[t('openSelectedItemsMenu')]]"icon="more-vert"slot="dropdown-trigger"on-tap="_menuOpened"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><template is="dom-if"if="[[!selectedItemsEmpty]]"restamp=""><paper-item data-args$="[[item.id]]"hidden$="[[userId]]"on-tap="_approveSelected">[[t('approveSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[!onlyFlaggedItems]]"on-tap="_clearSelectedFlags">[[t('clearSelectedFlags')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[userId]]"on-tap="_blockSelected">[[t('blockSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[!userId]]"on-tap="_anonymizeSelected">[[t('anonymizeSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"on-tap="_deleteSelected">[[t('deleteSelectedContent')]] [[selectedItemsCount]]</paper-item></template></paper-listbox></paper-menu-button></template><template><paper-menu-button horizontal-align="right"class="helpButton"on-opened-changed="_refreshGridAsyncDelay"><paper-icon-button aria-label$="[[t('openOneItemMenu')]]"icon="more-vert"data-args$="[[item.id]]"on-tap="_setSelected"slot="dropdown-trigger"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[userId]]"on-tap="_approve">[[t('approveContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[!onlyFlaggedItems]]"on-tap="_clearFlags">[[t('clearFlags')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[userId]]"on-tap="_block">[[t('blockContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[!userId]]"on-tap="_anonymize">[[t('anonymizeContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"on-tap="_delete">[[t('deleteContent')]]</paper-item></paper-listbox></paper-menu-button></template></vaadin-grid-column></vaadin-grid></paper-dialog><div class="layout horizontal center-center"><yp-ajax id="ajax"on-response="_itemsResponse"on-error="_ajaxError"></yp-ajax><yp-ajax method="DELETE"id="singleItemAjax"on-error="_ajaxError"on-response="_singleItemResponse"></yp-ajax><yp-ajax method="DELETE"id="manyItemsAjax"on-error="_ajaxError"on-response="_manyItemsResponse"></yp-ajax></div><iron-media-query query="(max-width: 600px)"query-matches="{{narrow}}"></iron-media-query></template><script>Polymer({is:"yp-content-moderation",behaviors:[Polymer.ypLanguageBehavior,Polymer.ypNumberFormatBehavior],properties:{multiSortEnabled:{type:Boolean,value:!1},items:{type:Array,notify:!0,value:null},headerText:{type:String},groupId:{type:Number,observer:"_groupIdChanged"},domainId:{type:Number,observer:"_domainIdChanged"},communityId:{type:Number,observer:"_communityIdChanged"},userId:{type:Number,observer:"_userIdChanged"},selected:{type:Object},modelType:{type:String},opened:{type:Boolean,value:!1},selectedItems:{type:Array,notify:!0},selectedItemsCount:{type:Number,value:0},selectedItemsEmpty:{type:Boolean,value:!0},selectedItemIdsAndType:{type:Array},selectedItemId:{type:String},selectedModelClass:{type:String},totalItemsCount:{type:String,computed:"_totalItemsCount(items)"},collectionName:String,itemsCountText:String,resizeTimeout:{type:Object,value:null},activeItem:{type:Object,observer:"_activeItemChanged"},typeOfModeration:{type:String,value:"/flagged_content"},onlyFlaggedItems:{type:Boolean,computed:"_onlyFlaggedItems(typeOfModeration)"},showReload:{type:Boolean,value:!1},forceSpinner:{type:Boolean,value:!1},spinnerActive:{type:Boolean,computed:"_spinnerActive(totalItemsCount, forceSpinner)"}},_spinnerActive:function(e,t){return!e||t},observers:["_selectedItemsChanged(selectedItems.splices)"],_ajaxError:function(){this.set("forceSpinner",!1)},_reload:function(){this.$.ajax.generateRequest(),this.set("forceSpinner",!0)},_onlyFlaggedItems:function(e){return"/flagged_content"===e},_manyItemsResponse:function(){this.set("forceSpinner",!1),this.set("showReload",!0),window.appGlobals.notifyUserViaToast(this.t("operationInProgressTryReloading"))},_singleItemResponse:function(){this._reload()},_getType:function(e){return"post"===e?this.t("posts.post"):"point"===e?this.t("point.point"):void 0},_activeItemChanged:function(e,t){e&&this.$.grid.openItemDetails(e),t&&this.$.grid.closeItemDetails(t),this._refreshGridAsync()},_refreshGridAsync:function(){this._refreshGridAsyncBase(10)},_refreshGridAsyncDelay:function(){this.allowGridEventsAfterMenuOpen&&this._refreshGridAsyncBase(250)},_refreshGridAsyncBase:function(e){this.async(function(){this.$.grid.fire("iron-resize"),this.$.grid.notifyResize()},e)},_menuSelection:function(){this.$.grid.querySelectorAll("paper-listbox").forEach(function(e){e.select(null)}),this._refreshGridAsync()},ready:function(){this._setGridSize(),window.addEventListener("resize",this._resizeThrottler.bind(this),!1)},_toPercent:function(e){return e?Math.round(100*e)+"%":null},_resizeThrottler:function(){this.resizeTimeout||(this.resizeTimeout=setTimeout(function(){this.resizeTimeout=null,this._setGridSize()}.bind(this),66))},_setGridSize:function(){window.innerWidth<=600?this.$.grid.style.width=window.innerWidth.toFixed()+"px":this.$.grid.style.width=(window.innerWidth-16).toFixed()+"px",this.$.grid.style.height=window.innerHeight.toFixed()+"px"},_totalItemsCount:function(e){return e?this.formatNumber(e.length):null},_selectedItemsChanged:function(){this.selectedItems&&0<this.selectedItems.length?(this.set("selectedItemsEmpty",!1),this.set("selectedItemsCount",this.selectedItems.length)):(this.set("selectedItemsEmpty",!0),this.set("selectedItemsCount",0)),this.selectedItemIdsAndType=this.selectedItems.map(function(e){return{id:e.id,modelType:e.type}}),this._refreshGridAsyncDelay()},_setupItemIdFromEvent:function(e){var t=e.target.parentElement.getAttribute("data-args");t=t||e.target.getAttribute("data-args"),this.set("selectedItemId",t);var s=e.target.parentElement.getAttribute("data-model-class");s=s||e.target.getAttribute("data-model-class"),this.set("selectedModelClass",s),this._refreshGridAsync()},_deleteSelected:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteSelectedContent"),this._reallyDeleteSelected.bind(this),!0,!0)}.bind(this))},_reallyDeleteSelected:function(){this._ajaxMaster(this.$.manyItemsAjax,"delete",this.selectedItemIdsAndType)},_delete:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteContent"),this._reallyDelete.bind(this),!0,!1)}.bind(this))},_reallyDelete:function(){this._ajaxMaster(this.$.singleItemAjax,"delete")},_anonymizeSelected:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureAnonymizeSelectedContent"),this._reallyAnonymizeSelected.bind(this),!0,!0)}.bind(this))},_reallyAnonymizeSelected:function(){this._ajaxMaster(this.$.manyItemsAjax,"anonymize",this.selectedItemIdsAndType)},_anonymize:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureAnonymizeContent"),this._reallyAnonymize.bind(this),!0,!1)}.bind(this))},_reallyAnonymize:function(){this._ajaxMaster(this.$.singleItemAjax,"anonymize")},_approve:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"approve")},_approveSelected:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"approve",this.selectedItemIdsAndType)},_block:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"block")},_blockSelected:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"block",this.selectedItemIdsAndType)},_clearFlags:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"clearFlags")},_clearSelectedFlags:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"clearFlags",this.selectedItemIdsAndType)},_ajaxMaster:function(e,t,s){var i,n;if("groups"===this.modelType&&this.groupId)n=this.groupId;else if("communities"===this.modelType&&this.communityId)n=this.communityId;else if("domains"===this.modelType&&this.domainId)n=this.domainId;else{if("users"!==this.modelType||!this.userId)return void console.error("Can't find model type or ids");n=this.userId}if(s&&0<s.length)i="/api/"+this.modelType+"/"+n+"/"+t+"/process_many_moderation_item",e.body={items:s};else{if(!this.selectedItemId)return void console.error("No item ids to process");i="/api/"+this.modelType+"/"+n+"/"+this.selectedItemId+"/"+this.selectedModelClass+"/"+t+"/process_one_moderation_item",e.body={}}if(e.url=i,e.generateRequest(),this.set("forceSpinner",!0),this.selectedItemId){var o=this._findItemFromId(this.selectedItemId);o&&this.$.grid.deselectItem(o),this.selectedItemId=null,this.selectedModelClass=null}},_menuOpened:function(){this.allowGridEventsAfterMenuOpen=!0},_setSelected:function(e){var t=this._findItemFromId(e.target.getAttribute("data-args"));t&&this.$.grid.selectItem(t),this.allowGridEventsAfterMenuOpen=!0,this._refreshGridAsync()},_findItemFromId:function(t){var s;return this.items.forEach(function(e){e.id==t&&(s=e)}.bind(this)),s},_domainIdChanged:function(e){e&&(this._reset(),this.set("modelType","domains"),this._generateRequest(e))},_groupIdChanged:function(e){e&&(this._reset(),this.set("modelType","groups"),this._generateRequest(e))},_communityIdChanged:function(e){e&&(this._reset(),this.set("modelType","communities"),this._generateRequest(e))},_userIdChanged:function(e){e&&(this._reset(),this.set("modelType","users"),this._generateRequest(e))},_generateRequest:function(e){this.$.ajax.url="/api/"+this.modelType+"/"+e+this.typeOfModeration,this.$.ajax.generateRequest()},_itemsResponse:function(e,t){this.set("forceSpinner",!1),this.set("items",t.response),this._resetSelectedAndClearCache()},setup:function(e,t,s,i,n){i?this.set("typeOfModeration",i):this.set("typeOfModeration","/flagged_content"),this.set("groupId",null),this.set("communityId",null),this.set("domainId",null),this.set("userId",null),this.set("items",null),e&&this.set("groupId",e),t&&this.set("communityId",t),s&&this.set("domainId",s),n&&this.set("userId",n),this._setupHeaderText()},open:function(e){this.set("collectionName",e),this.set("opened",!0),this.$.dialog.open()},_reset:function(){this.set("items",null),this._resetSelectedAndClearCache()},_resetSelectedAndClearCache:function(){this.set("selectedItemsCount",0),this.set("selectedItemsEmpty",!0),this.set("selectedItemIdsAndType",[]),this.set("selectedItems",[]),this.$.grid.clearCache()},_setupHeaderText:function(){this.onlyFlaggedItems?this.set("itemsCountText",this.t("contentItemsFlagged")):this.set("itemsCountText",this.t("items")),this.groupId?this.set("headerText",this.t("groupContentModeration")):this.communityId?this.set("headerText",this.t("communityContentModeration")):this.domainId?this.set("headerText",this.t("domainContentModeration")):this.userId&&this.set("headerText",this.t("userContentModeration"))}})</script></dom-module></div>