<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../../bower_components/file-upload/file-upload.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/access-helpers.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">

<link rel="import" href="../yp-edit-dialog/yp-edit-dialog.html">
<link rel="import" href="../yp-edit-dialog/yp-edit-dialog-behavior.html">

</head><body><dom-module id="yp-post-move">
  <template>

    <style include="iron-flex iron-flex-alignment">
      .additionalSettings {
        padding-top: 16px;
      }

      paper-textarea {
        padding-top: 16px;
      }

      .groupName {
        cursor: pointer;
      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <yp-edit-dialog id="editDialog" icon="language" confirmation-text="[[t('post.statusChangeConfirmText')]]" action="[[action]]" method="[[method]]" params="[[params]]" save-text="[[saveText]]" toast-text="[[toastText]]">
      <h2>[[editHeaderText]]</h2>

      <iron-list items="[[availableGroups]]" as="group">
        <template>
          <div class="groupName" on-tap="_selectGroup" data-args$="[[group.id]]" data-args-name$="[[group.name]]">[[group.name]]</div>
        </template>
      </iron-list>

      <div class="layout horizontal center-center">
        <yp-ajax method="GET" id="getAvailableGroupsAjax" url="/api/users/available/groups" on-response="_getGroupsResponse"></yp-ajax>
        <yp-ajax method="PUT" id="movePostAjax" on-response="_movePostResponse"></yp-ajax>
      </div>
    </yp-edit-dialog>
  </template>

</dom-module>

<script>Polymer({is:"yp-post-move",behaviors:[Polymer.appHelpers,Polymer.ypEditDialogBehavior,Polymer.AccessHelpers],properties:{action:{type:String,value:"/api/posts"},post:{type:Object},availableGroups:{type:Array,value:null},selectedGroupId:Number},_selectGroup:function(t){this.set("selectedGroupId",t.target.getAttribute("data-args"));var e=t.target.getAttribute("data-args-name"),s=Polymer.dom(document).querySelector("yp-app").getDialog("confirmationDialog");s.open(this.t("post.confirmMove")+' "'+this.post.name+'" '+this.t("to")+' "'+e+'"',this._reallyMove.bind(this))},_reallyMove:function(){this.$.movePostAjax.url="/api/posts/"+this.post.id+"/"+this.selectedGroupId+"/move",this.$.movePostAjax.body={},this.$.movePostAjax.generateRequest()},_movePostResponse:function(){location.reload()},_getGroupsResponse:function(t,e){if(e.response){var s=[];s=s.concat(window.appUser.adminRights.GroupAdmins,window.appUser.memberships.GroupUsers),s=s.concat(e.response.groups),s=this._uniqueInDomain(s,e.response.domainId),this.set("availableGroups",s)}},_uniqueInDomain:function(t,e){var s=[],o={};return _.each(t,function(t){o[t.id]||(o[t.id]=t.id,t.configuration||(t.configuration={canAddNewPosts:!0}),t.Community&&t.Community.domain_id==e&&(t.configuration.canAddNewPosts||this._hasAdminRights(t.id,window.appUser.adminRights.GroupAdmins))?s.push(t):console.log("Ignoring group:"+t.name))}.bind(this)),s},_clear:function(){this.set("selectedGroupId",null),this.set("post",null)},setupAndOpen:function(t,e){this.set("post",t),this.set("refreshFunction",e),this._setupTranslation(),this.$.getAvailableGroupsAjax.generateRequest(),this.open()},_setupTranslation:function(){this.set("editHeaderText",this.t("post.move")),this.set("toastText",this.t("post.haveMovedPost")),this.set("saveText",this.t("post.move"))}});</script>
</body></html>