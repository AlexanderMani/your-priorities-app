<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../yp-ajax/yp-ajax.html">

<link rel="import" href="yp-user-image.html">

</head><body><dom-module id="yp-users-grid">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #dialog {
        width: 90%;
        height: 90%;
        background-color: #FFF;
      }

      iron-list {
        color: #000;
        height: 500px;
        width: 100%;
      }

      .userItem {
        padding-right: 16px;
      }

      .id {
        width: 60px;
      }

      .name {
        width: 200px;
      }

      .email {
        width: 240px;
      }

      #selectOrganizationDialog {
        background-color: #FFF;

      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <paper-dialog id="selectOrganizationDialog" modal="">
      <h2>[[t('users.selectOrganization')]]</h2>
      <paper-menu>
        <template is="dom-repeat" items="[[availableOrganizations]]">
          <paper-item on-tap="_selectOrganization" id="[[item.id]]">[[item.name]]</paper-item>
        </template>
      </paper-menu>

      <div class="buttons">
        <paper-button dialog-dismiss="">[[t('Close')]]</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="dialog">
      <h2>[[headerText]]</h2>
      <iron-list items="[[users]]" as="user">
        <template>
          <div class="layout horizontal">
            <div class="userItem id">
              [[user.id]]
            </div>
            <div class="userItem name">
              [[user.name]]
            </div>
            <div class="userItem email">
              [[user.email]]
            </div>
            <template is="dom-if" if="[[!_userOrganizationName(user)]]">
              <div class="organization">
                <paper-button data-args$="[[user.id]]" on-tap="_addToOrganization">[[t('users.addToOrganization')]]</paper-button>
              </div>
            </template>
            <div class="organization" hidden$="[[!_userOrganizationName(user)]]">
              <div class="organizationName">
                [[_userOrganizationName(user)]]
              </div>
              <paper-button data-args$="[[user.id]]" data-args-org$="[[_userOrganizationId(user)]]" on-tap="_removeFromOrganization">[[t('users.removeFromOrganization')]]</paper-button>
            </div>
            <div hidden$="[[!adminUsers]]">
              <paper-button data-args$="[[user.id]]" on-tap="_removeAdmin">[[t('users.removeAdmin')]]</paper-button>
            </div>
            <div hidden$="[[adminUsers]]">
              <paper-button data-args$="[[user.id]]" on-tap="_removeUser">[[t('users.removeUser')]]</paper-button>
            </div>
          </div>
        </template>
      </iron-list>
      <div hidden$="[[!adminUsers]]" class="layout horizontal">
        <paper-input label="[[t('users.email')]]" value="{{addAdminEmail}}"></paper-input>
        <paper-button on-tap="_addAdmin">[[t('users.addAdmin')]]</paper-button>
      </div>
      <div hidden$="[[adminUsers]]" class="layout horizontal">
        <paper-input label="[[t('users.email')]]" value="{{inviteUserEmail}}"></paper-input>
        <paper-button on-tap="_inviteUser">[[t('users.inviteUser')]]</paper-button>
      </div>

      <div class="buttons">
        <paper-button dialog-dismiss="">[[t('close')]]</paper-button>
      </div>
    </paper-dialog>

    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" on-response="_usersResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="removeAdminAjax" on-response="_removeAdminResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="removeUserAjax" on-response="_removeUserResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="removeOrganizationAjax" on-response="_removeOrganizationResponse"></yp-ajax>
      <yp-ajax method="POST" id="inviteUserAjax" on-response="_inviteUserResponse"></yp-ajax>
      <yp-ajax method="POST" id="addAdminAjax" on-response="_addAdminResponse"></yp-ajax>
      <yp-ajax method="POST" id="addOrganizationAjax" on-response="_addOrganizationResponse"></yp-ajax>
    </div>

  </template>

  <script>Polymer({is:"yp-users-grid",behaviors:[Polymer.appHelpers],properties:{addAdminEmail:{type:String},inviteUserEmail:{type:String},users:{type:Array,notify:!0},headerText:{type:String},groupId:{type:Number,observer:"_groupIdChanged"},domainId:{type:Number,observer:"_domainIdChanged"},communityId:{type:Number,observer:"_communityIdChanged"},adminUsers:{type:Boolean,value:!1},selected:{type:Object},modelType:{type:String},opened:{type:Boolean,value:!1},availableOrganizations:{type:Array},userIdForSelectingOrganization:Number},_userOrganizationId:function(e){return e&&e.OrganizationUsers&&e.OrganizationUsers.length>0?e.OrganizationUsers[0].id:null},_userOrganizationName:function(e){return e&&e.OrganizationUsers&&e.OrganizationUsers.length>0?e.OrganizationUsers[0].name:null},_availableOrganizations:function(){return window.appUser.adminRights&&window.appUser.adminRights.OrganizationAdmins?window.appUser.adminRights.OrganizationAdmins:[]},_addToOrganization:function(e){this.set("userIdForSelectingOrganization",e.target.getAttribute("data-args")),this.set("availableOrganizations",this._availableOrganizations()),this.$.selectOrganizationDialog.open()},_removeFromOrganization:function(e){var t=e.target.getAttribute("data-args"),i=e.target.getAttribute("data-args-org");this.$.removeOrganizationAjax.body={},this.$.removeOrganizationAjax.url="/api/organizations/"+i+"/"+t+"/remove_user",this.$.removeOrganizationAjax.generateRequest()},_selectOrganization:function(e,t){this.$.addOrganizationAjax.body={},this.$.addOrganizationAjax.url="/api/organizations/"+e.target.id+"/"+this.userIdForSelectingOrganization+"/add_user",this.$.addOrganizationAjax.generateRequest(),this.$.selectOrganizationDialog.close()},_removeAdmin:function(e){var t=e.target.getAttribute("data-args");this.$.removeAdminAjax.body={},"groups"==this.modelType&&this.groupId?(this.$.removeAdminAjax.url="/api/"+this.modelType+"/"+this.groupId+"/"+t+"/remove_admin",this.$.removeAdminAjax.generateRequest()):"communities"==this.modelType&&this.communityId?(this.$.removeAdminAjax.url="/api/"+this.modelType+"/"+this.communityId+"/"+t+"/remove_admin",this.$.removeAdminAjax.generateRequest()):console.warn("Can't find model type or ids")},_removeUser:function(e){var t=e.target.getAttribute("data-args");this.$.removeUserAjax.body={},"groups"==this.modelType&&this.groupId?(this.$.removeUserAjax.url="/api/"+this.modelType+"/"+this.groupId+"/"+t+"/remove_user",this.$.removeUserAjax.generateRequest()):"communities"==this.modelType&&this.communityId?(this.$.removeUserAjax.url="/api/"+this.modelType+"/"+this.communityId+"/"+t+"/remove_user",this.$.removeUserAjax.generateRequest()):console.warn("Can't find model type or ids")},_addAdmin:function(e){this.$.addAdminAjax.body={},"groups"==this.modelType&&this.groupId?(this.$.addAdminAjax.url="/api/"+this.modelType+"/"+this.groupId+"/"+this.addAdminEmail+"/add_admin",this.$.addAdminAjax.generateRequest()):"communities"==this.modelType&&this.communityId?(this.$.addAdminAjax.url="/api/"+this.modelType+"/"+this.communityId+"/"+this.addAdminEmail+"/add_admin",this.$.addAdminAjax.generateRequest()):console.warn("Can't find model type or ids")},_inviteUser:function(e){this.$.inviteUserAjax.body={},"groups"==this.modelType&&this.groupId?(this.$.inviteUserAjax.url="/api/"+this.modelType+"/"+this.groupId+"/"+this.inviteUserEmail+"/invite_user",this.$.inviteUserAjax.generateRequest()):"communities"==this.modelType&&this.communityId?(this.$.inviteUserAjax.url="/api/"+this.modelType+"/"+this.communityId+"/"+this.inviteUserEmail+"/invite_user",this.$.inviteUserAjax.generateRequest()):console.warn("Can't find model type or ids")},_removeAdminResponse:function(){window.appGlobals.notifyUserViaToast(this.t("users.adminRemoved")),this.$.ajax.generateRequest()},_removeUserResponse:function(){window.appGlobals.notifyUserViaToast(this.t("users.userRemoved")),this.$.ajax.generateRequest()},_addAdminResponse:function(){window.appGlobals.notifyUserViaToast(this.t("users.adminAdded")+" "+this.addAdminEmail),this.set("addAdminEmail",null),this.$.ajax.generateRequest()},_addOrganizationResponse:function(e,t){window.appGlobals.notifyUserViaToast(this.t("users.organizationUserAdded")+" "+t.response.email),this.$.ajax.generateRequest()},_removeOrganizationResponse:function(e,t){window.appGlobals.notifyUserViaToast(this.t("users.organizationUserRemoved")+" "+t.response.email),this.$.ajax.generateRequest()},_inviteUserResponse:function(){window.appGlobals.notifyUserViaToast(this.t("users.userInvited")+" "+this.inviteUserEmail),this.set("inviteUserEmail",null),this.$.ajax.generateRequest()},_domainIdChanged:function(e){e&&(this.set("modelType","domains"),this._generateRequest(e))},_groupIdChanged:function(e){e&&(this.set("modelType","groups"),this._generateRequest(e))},_communityIdChanged:function(e){e&&(this.set("modelType","communities"),this._generateRequest(e))},_generateRequest:function(e){var t=this.adminUsers?"admin_users":"users";this.$.ajax.url="/api/"+this.modelType+"/"+e+"/"+t,this.$.ajax.generateRequest()},_usersResponse:function(e,t){this.set("users",t.response)},setup:function(e,t,i,s){this.set("groupId",null),this.set("communityId",null),this.set("domainId",null),this.set("users",null),this.set("adminUsers",s),e&&this.set("groupId",e),t&&this.set("communityId",t),i&&this.set("domainId",i),this._setupHeaderText()},open:function(){this.set("opened",!0),this.$.dialog.open()},_setupHeaderText:function(){this.groupId?this.adminUsers?this.set("headerText",this.t("group.admins")):this.set("headerText",this.t("group.users")):this.communityId?this.adminUsers?this.set("headerText",this.t("community.admins")):this.set("headerText",this.t("community.users")):this.domainId&&(this.adminUsers?this.set("headerText",this.t("domain.admins")):this.set("headerText",this.t("domain.users")))},ready2:function(){},_adminActionRenderer:function(e){e.element.innerHTML="";var t=document.createElement("progress");t.setAttribute("value",e.data),e.element.appendChild(t)},_onSelect:function(){0===this.$.grid.selection.selected().length?this.selected=null:this.selected=this.users[this.$.grid.selection.selected()]}});</script>
</dom-module>
</body></html>