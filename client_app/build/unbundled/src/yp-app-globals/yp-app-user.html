<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-session/yp-session.html">
<link rel="import" href="../yp-user/yp-login.html">
<link rel="import" href="../yp-user/yp-forgot-password.html">
<link rel="import" href="../yp-user/yp-reset-password.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">

</head><body><dom-module id="yp-app-user">
  <template>
    <style include="iron-flex iron-flex-alignment">
      paper-toast {
        z-index: 9999;
      }
    </style>

    <yp-session id="session"></yp-session>

    <div class="layout horizontal center-center">
      <yp-ajax id="isLoggedInAjax" method="GET" url="/api/users/loggedInUser/isloggedin" on-response="_isLoggedInResponse"></yp-ajax>
      <yp-ajax id="adminRightsAjax" method="GET" url="/api/users/loggedInUser/adminRights" on-response="_adminRightsResponse"></yp-ajax>
      <yp-ajax id="membershipsAjax" method="GET" url="/api/users/loggedInUser/memberships" on-response="_membershipsResponse"></yp-ajax>
      <yp-ajax id="logoutAjax" method="POST" url="/api/users/logout" on-response="_logoutResponse"></yp-ajax>
      <yp-ajax id="setLocaleAjax" method="PUT" url="/api/users/loggedInUser/setLocale"></yp-ajax>
    </div>

    <paper-toast id="loginToast" text="[[toastLoginTextCombined]]"></paper-toast>
    <paper-toast id="logoutToast" text="[[toastLogoutTextCombined]]"></paper-toast>
  </template>

  <script>!function(){Polymer({is:"yp-app-user",behaviors:[Polymer.appHelpers],listeners:{"yp-forgot-password":"_forgotPassword","yp-reset-password":"_resetPassword"},properties:{loginForAcceptInviteParams:Object,loginForEditParams:{type:Object},loginForNewPointParams:{type:Object},loginForEndorseParams:{type:Object},loginForPointQualityParams:{type:Object},loginForMembershipParams:{type:Object},loginFor401refreshFunction:{type:Function,value:null},toastLoginTextCombined:{type:String},toastLogoutTextCombined:{type:String},user:{type:Object,observer:"_onUserChanged"},endorsementPostsIndex:{type:Object},membershipsIndex:{type:Object},pointQualitiesIndex:{type:Object},adminRights:{type:Object},memberships:{type:Object},completeExternalLoginText:{type:String,value:null}},loginForAcceptInvite:function(e,s){this.loginForAcceptInviteParams={editDialog:e,token:s},this.openUserlogin()},loginForEdit:function(e,s,t){this.loginForEditParams={editDialog:e,newOrUpdate:s,params:t},this.openUserlogin()},loginForNewPoint:function(e,s){this.loginForNewPointParams={postPointsElement:e,params:s},this.openUserlogin()},loginForEndorse:function(e,s){this.loginForEndorseParams={postActionElement:e,params:s},this.openUserlogin()},loginForPointQuality:function(e,s){this.loginForPointQualityParams={pointActionElement:e,params:s},this.openUserlogin()},loginForMembership:function(e,s){this.loginForMembershipParams={membershipActionElement:e,params:s},this.openUserlogin()},loginFor401:function(e){this.set("loginFor401refreshFunction",e),this.openUserlogin()},openUserlogin:function(){var e=Polymer.dom(document).querySelector("yp-app").getDialog("userLogin");e.setup(this._handleLogin.bind(this)),e.open()},_closeUserLogin:function(){var e=Polymer.dom(document).querySelector("yp-app").getDialog("userLogin");e.close()},_setUserLoginSpinner:function(){var e=Polymer.dom(document).querySelector("yp-app").getDialog("userLogin");e.setUserSpinner(!0)},_handleLogin:function(e){if(this._closeUserLogin(),this.setLoggedInUser(e),this.$.adminRightsAjax.generateRequest(),this.$.membershipsAjax.generateRequest(),this.toastLoginTextCombined=this.t("user.loginCompleteFor")+" "+this.user.name,this.$.loginToast.show(),this.fire("login"),this.loginForEditParams){var s=this.loginForEditParams;s.editDialog.open(s.newOrUpdate,s.params),this.loginForEditParams=null}else if(this.loginForNewPointParams){var t=this.loginForNewPointParams;t.postPointsElement.addPoint(t.params.content,t.params.value),this.loginForNewPointParams=null}else if(this.loginForEndorseParams){var i=this.loginForEndorseParams;i.postActionElement.generateEndorsementFromLogin(i.params.value),this.loginForEndorseParams=null}else if(this.loginForPointQualityParams){var n=this.loginForPointQualityParams;n.pointActionElement.generatePointQualityFromLogin(n.params.value),this.loginForPointQualityParams=null}else if(this.loginForMembershipParams){var o=this.loginForMembershipParams;o.membershipActionElement.generateMembershipFromLogin(o.params.value),this.loginForMembershipParams=null}else if(this.loginForAcceptInviteParams){var r=this.loginForAcceptInviteParams;r.editDialog.open(r.token),this.loginForAcceptInviteParams=null}else this.loginFor401refreshFunction&&this.loginFor401refreshFunction()},_forgotPassword:function(e,s){var t=Polymer.dom(document).querySelector("yp-app").getDialog("forgotPassword");t.open(s)},_resetPassword:function(e,s){var t=Polymer.dom(document).querySelector("yp-app").getDialog("resetPassword");t.open(s)},getUser:function(){return this.$.session.get("user")},setLoggedInUser:function(e){this.$.session.set("user",e),this.user=e,this.fire("iron-signal",{name:"logged-in",data:e})},removeUserSession:function(){this.$.session.unset("user"),this.user=null},loggedIn:function(){return this.$.session.has("user")},logout:function(){this.$.logoutAjax.body={},this.$.logoutAjax.generateRequest()},setLocale:function(e){this.$.setLocaleAjax.body={locale:e},this.$.setLocaleAjax.generateRequest()},ready:function(){window.appUser=this,this.checkLogin()},loginFromFacebook:function(){this._completeExternalLogin(this.t("user.loggedInWithFacebook"))},loginFromSaml:function(){this._completeExternalLogin(this.t("user.loggedInWithSaml"))},_completeExternalLogin:function(e){this.checkLogin(),this._setUserLoginSpinner(),this.set("completeExternalLoginText",e)},checkLogin:function(){this.$.isLoggedInAjax.url="/api/users/loggedInUser/isloggedin?"+(new Date).getTime(),this.$.isLoggedInAjax.generateRequest(),this.$.adminRightsAjax.url="/api/users/loggedInUser/adminRights?"+(new Date).getTime(),this.$.adminRightsAjax.generateRequest(),this.$.membershipsAjax.url="/api/users/loggedInUser/memberships?"+(new Date).getTime(),this.$.membershipsAjax.generateRequest()},recheckAdminRights:function(){this.$.adminRightsAjax.generateRequest()},updateEndorsementForPost:function(e,s){if(this.user.Endorsements){for(var t=!1,i=0;i<this.user.Endorsements.length;i++)if(this.user.Endorsements[i].post_id===e){s?this.user.Endorsements[i]=s:this.user.Endorsements[i].splice(i,1),t=!0;break}t&&this._updateEndorsementPostsIndex(this.user)}},_updateEndorsementPostsIndex:function(e){if(e&&e.Endorsements&&e.Endorsements.length>0){this.endorsementPostsIndex={};for(var s=0;s<e.Endorsements.length;s++)this.endorsementPostsIndex[e.Endorsements[s].post_id]=e.Endorsements[s]}else this.endorsementPostsIndex={}},updatePointQualityForPost:function(e,s){if(this.user.PointQualities){for(var t=!1,i=0;i<this.user.PointQualities.length;i++)if(this.user.PointQualities[i].point_id===e){s?this.user.PointQualities[i]=s:this.user.PointQualities[i].splice(i,1),t=!0;break}t&&this._updateEndorsementPostsIndex(this.user)}},_updatePointQualitiesIndex:function(e){if(e&&e.PointQualities&&e.PointQualities.length>0){this.pointQualitiesIndex={};for(var s=0;s<e.PointQualities.length;s++)this.pointQualitiesIndex[e.PointQualities[s].point_id]=e.PointQualities[s]}else this.pointQualitiesIndex={}},_onUserChanged:function(e,s){this.fire("user-changed",e),e&&(this._updateEndorsementPostsIndex(e),this._updatePointQualitiesIndex(e),this.fire("iron-signal",{name:"got-endorsements-and-qualities"}))},_logoutResponse:function(e,s){this.toastLogoutTextCombined=this.t("user.logoutCompleteFor")+" "+this.user.name,this.removeUserSession(),this.$.logoutToast.show(),this.async(function(){location.reload()},1200)},_isLoggedInResponse:function(e,s){if(0===s.response?this.removeUserSession():s.response.name&&this.setLoggedInUser(s.response),s.response.missingEmail){var t=Polymer.dom(document).querySelector("yp-app").getDialog("missingEmail");t.open(s.response.loginProvider)}this.completeExternalLoginText&&(window.appGlobals.notifyUserViaToast(this.completeExternalLoginText),this._closeUserLogin(),this.set("completeExternalLoginText",null))},_adminRightsResponse:function(e,s){s.response&&0!=s.response&&(this.set("adminRights",s.response),this.fire("iron-signal",{name:"got-admin-rights"}))},_updateMembershipsIndex:function(e){if(e){var s;for(this.membershipsIndex={groups:{},communities:{},domains:{}},s=0;s<e.GroupUsers.length;s++)this.membershipsIndex.groups[e.GroupUsers[s].id]=!0;for(s=0;s<e.CommunityUsers.length;s++)this.membershipsIndex.communities[e.CommunityUsers[s].id]=!0;for(s=0;s<e.DomainUsers.length;s++)this.membershipsIndex.domains[e.DomainUsers[s].id]=!0}else this.membershipsIndex={groups:{},communities:{},domains:{}}},_membershipsResponse:function(e,s){s.response&&0!=s.response&&(this.set("memberships",s.response),this._updateMembershipsIndex(this.memberships),this.fire("iron-signal",{name:"got-memberships"}))}})}();</script>
</dom-module>
</body></html>