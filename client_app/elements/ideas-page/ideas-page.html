  <!--
      TODO(polyup): unable to infer path to components
      directory. This import path is probably incomplete.
   -->
  <link rel="import" href="iron-flex-layout/iron-flex-layout.html">
<!--
    TODO(polyup): Inheriting from other custom elements is not yet supported.
    See: https://www.polymer-project.org/1.0/docs/migration.html#inheritance
 -->
<dom-module id="ideas-page">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [layout] {
      @apply(--layout);
    }
    [layout][center-center] {
      @apply(--layout-center-center);
    }
  </style>
  <link rel="import" type="css" href="ideas-page.css">
  <template bind="">

    <iron-ajax auto="false" id="ideasAjax" url="" last-response="{{ideasResponse}}" handle-as="json">
    </iron-ajax>

    <iron-ajax auto="false" id="categoryAjax" url="{{computeUrl(groupId)}}" last-response="{{categoriesResponse}}" handle-as="json">
    </iron-ajax>

    <iron-ajax auto="false" id="categoryDefaultAjax" url="/api/groups/default/categories" last-response="{{categoriesResponse}}" handle-as="json">
    </iron-ajax>

    <base-layout id="layout" selected="ideas" filter="{{filter}}" groupname="{{groupName}}" groupid="{{groupId}}" showlogo="true" categoryid="{{idea.Category.id}}" categories="{{categories}}" ideasfilter="true" name="{{groupName}}">
      <div class="card-container">
        <template is="dom-repeat" items="{{ideas}}" as="idea">
          <paper-material class="card" elevation="1" center-center="" layout="">
            <yrpri-idea idea="{{idea}}" showcategory="true" small="true"></yrpri-idea>
          </paper-material>
        </template>
        <a href="/add" on-click="navigate">
          <paper-fab icon="add" z="1" class="createIdea" title="{{computeTitle()}}" on-tap="newIdea"></paper-fab>
        </a>
      </div>
    </base-layout>
  </template>
  <script>
    Polymer({
      is: 'ideas-page',
      properties: {
        categories: {
          type: Array,
          value: function () {
            return [];
          }
        },
        categoriesResponse: { observer: 'categoriesResponseChanged' },
        defaultCategories: {
          type: Boolean,
          value: false
        },
        ideas: {
          type: Array,
          value: function () {
            return [];
          }
        },
        ideasResponse: { observer: 'ideasResponseChanged' }
      },
      newIdea: function () {
        window.globals.activity('Anonymous', 'open', 'newIdea');
        window.globals.openDialog('ideas.add_new');
      },
      ideasResponseChanged: function (detail, e, sender) {
        this.$.layout.setSpinner(false);
        this.ideas = detail;
      },
      categoriesResponseChanged: function (detail, e, sender) {
        if (detail && detail.length == 0 && !this.defaultCategories) {
          this.defaultCategories = true;
          this.$.categoryDefaultAjax.go();
        } else if (detail != null) {
          this.categories = detail;
          if (this.categoryId) {
            for (var i = 0; i < this.categories.length; i++) {
              if (this.categories[i].id == this.categoryId) {
                window.selectedCategoryName = this.categories[i].name;
                this.$.layout.updateFilter();
              }
            }
          } else {
            window.selectedCategoryName = 'categories.all';
            this.$.layout.updateFilter();
          }
        }
      },
      ready: function () {
        if (this.filter) {
          window.selectedFilter = this.filter;
        }
        this.$.layout.setSpinner(true);
        this.$.ideasAjax.url = '/api/groups/' + this.groupId + '/ideas/' + window.selectedFilter;
        if (this.categoryId) {
          this.$.ideasAjax.url += '/' + this.categoryId;
        }
        this.$.ideasAjax.go();
        this.$.categoryAjax.go();
      },
      extends: 'base-page',
      computeUrl: function (groupId) {
        return '/api/groups/' + groupId + '/categories';
      },
      computeTitle: function () {
        return this.t('ideas.add_new');
      }
    });
  </script>
</dom-module>
