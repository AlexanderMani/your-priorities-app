<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html">

<link rel="import" href="../yp-domain/yp-domain.html">
<link rel="import" href="../yp-community/yp-community.html">
<link rel="import" href="../yp-group/yp-group.html">
<link rel="import" href="../yp-post/yp-post.html">
<link rel="import" href="../yp-user/yp-user-info.html">
<link rel="import" href="../yp-app-globals/yp-app-globals.html">
<link rel="import" href="../yp-app-globals/yp-app-user.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/fix-dialog.html">

<link rel="import" href="yp-app-drawer.html">

<dom-module id="yp-app">

  <template>

    <style>
      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        color: #fff;
        background-color: #F2F2F2;
      }

      app-toolbar {
        height: 64px;
        color: #FFF;
      }

      [condensed-title] {
        /*        background-size: 76px; */
        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 16px;
      }

      [title] {
        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 32px;
      }

      .backIcon {
        width: 48px;
        height: 48px;
        padding-right: 16px;
      }

      .main-header {
        border-bottom: 1px solid var(--primary-color-800);
        background-color: var(--primary-color-800);
        color: #333;
        height: 64px;
      }
    </style>

    <iron-signals on-iron-signal-yp-i18n-ready="_i18nReady"></iron-signals>

    <template is="dom-if" if="[[appAndI18nReady]]" restamp>
      <!--    <material-search id="search" narrow="[[narrow]]"
                           previous-searches="{{previousSearches}}"
                           on-search-change="_onSearch" class="fit"></material-search> -->

      <app-drawer-layout drawer-width="360px" responsive-width="16000px">

        <app-drawer id="drawer" align="end" position="right" swipe-open>
          <yp-app-drawer id="ypDrawer" user="[[user]]" route="[[route]]"></yp-app-drawer>
        </app-drawer>

        <app-scrollpos-control selected="{{route}}" reset="{{__equal(route, 'detail')}}"></app-scrollpos-control>

        <app-header-layout id="mainArea">

          <app-header effects="waterfall" reveals class="main-header">
            <app-toolbar>
              <paper-icon-button id="paperToggleNavMenu" icon="menu" on-tap="_toggleNavDrawer"></paper-icon-button>
              <paper-icon-button icon="arrow-back" on-tap="goBack" class="backIcon"
                                 hidden$="[[!showBack]]"></paper-icon-button>
              <iron-icon class="headerIcon" icon$="[[headerIcon]]" hidden$="[[!headerIcon]]" hidden></iron-icon>
              <div title>[[headerTitle]]</div>

              <span class="flex"></span>

              <!-- Toolbar icons -->
              <paper-icon-button icon="search" on-tap="toggleSearch" hidden$="[[!showSearch]]"></paper-icon-button>

              <template is="dom-if" if="[[user]]">
                <paper-icon-button on-tap="_toggleUserDrawer" icon="face"></paper-icon-button>
              </template>
            </app-toolbar>
          </app-header>

          <iron-pages attr-for-selected="data-route" selected="{{route}}">

            <section data-route="home">
            </section>

            <section data-route="domain">
              <template is="dom-if" if="[[params.domainId]]" restamp>
                <yp-domain domain-id="{{params.domainId}}" tab-name="[[params.tabName]]" on-change-header="onChangeHeader"></yp-domain>
              </template>
            </section>

            <section data-route="community">
              <template is="dom-if" if="[[params.communityId]]" restamp>
                <yp-community community-id="{{params.communityId}}" tab-name="[[params.tabName]]" on-change-header="onChangeHeader"></yp-community>
              </template>
            </section>

            <section data-route="group">
              <template is="dom-if" if="[[params.groupId]]" restamp>
                <yp-group group-id="{{params.groupId}}" filter="[[params.filterValue]]"
                          searching-for="[[params.searchingFor]]" tab-name="[[params.tabName]]"
                          category-id="[[params.categoryId]]" category-name="[[params.categoryName]]"
                          on-change-header="onChangeHeader"></yp-group>
              </template>
            </section>

            <section data-route="post">
              <template is="dom-if" if="[[params.postId]]" restamp>
                <yp-post post-id="{{params.postId}}" tab-name="[[params.tabName]]" on-change-header="onChangeHeader"></yp-post>
              </template>
            </section>

          </iron-pages>

        </app-header-layout>

      </app-drawer-layout>

      <yp-dialog-container id="dialogContainer"></yp-dialog-container>
      <yp-app-user id="appUser" on-user-changed="onUserChanged"></yp-app-user>
    </template>

    <yp-app-globals id="appGlobals" setup-defaults on-change-header="onChangeHeader" on-app-ready="_appReady"></yp-app-globals>
  </template>

  <script>
    Polymer({

      is: 'yp-app',

      behaviors: [
        Polymer.appHelpers,
        Polymer.FixDialog
      ],

      properties: {

        route: {
          type: String,
          value: 'home',
          observer: 'routeChanged'
        },

        appTitle: {
          type: String,
          value: "Your Priorities"
        },

        user: {
          type: Object
        },

        previousSearches: {
          type: Array,
          value: []
        },

        showSearch: {
          type: Boolean,
          value: false
        },

        showBack: {
          type: Boolean,
          value: false
        },

        backPath: {
          type: String
        },

        headerTitle: {
          type: String
        },

        headerDescription: {
          type: String
        },

        params: {
          type: Object
        },

        narrow: {
          type: Boolean
        },

        appReady: {
          type: Boolean,
          notify: true,
          value: false
        },

        i18nReady: {
          type: Boolean,
          notify: true,
          value: false
        },

        appAndI18nReady: {
          type: Boolean,
          notify: true,
          value: false
        }
      },

      observers: [
        '_isAppAndI18nReady(appReady, i18nReady)'
      ],

      ready: function () {
        console.log("yp-app is ready");
        if (window.i18nTranslation) {
          this._i18nReady();
        }
      },

      _isAppAndI18nReady: function (appReady, i18nReady) {
        if ((appReady && i18nReady) || (appReady && window.i18nTranslation)) {
          this.set('appAndI18nReady', true);
        }
      },

      _i18nReady: function () {
        this.set('i18nReady', true);
      },

      _appReady: function () {
        this.set('appReady', true);
      },

      getDialog(idName) {
        return this.$$("#dialogContainer").getDialog(idName);
      },

      scrollPageToTop: function() {
        var mainArea = document.getElementById('#mainArea');
        if (mainArea) {
          mainArea.scroller.scrollTop = 0;
        }
      },

      _toggleUserDrawer: function () {
        this.$$("#drawer").toggle();
      },

      openEdit: function () {
        var dialog = Polymer.dom(document).querySelector('yp-dialog-container #userEdit');
        dialog.setup(this.user, false, null);
        dialog.open('edit', { userId: this.user.id});
      },

      onChangeHeader: function (event, header) {
        this.headerTitle = document.title = header.headerTitle;

        if (header.documentTitle) {
          document.title = header.documentTitle;
        }
        this.headerDescription = header.headerDescription;

        //if (header.headerIcon)
        //app.headerIcon = header.headerIcon;
        if (header.enableSearch)
          this.showSearch = true;
        else
          this.showSearch = false;
        if (header.backPath) {
          this.showBack = true;
          this.backPath = header.backPath;
        } else {
          this.showBack = false;
          this.backPath = null;
        }
      },

      goBack: function (event, detail) {
        if (this.backPath)
          page(this.backPath);
      },

      _onSearch: function (e) {
        this.toggleSearch();
        this.unshift('previousSearches', e.detail.value);
        var postsFilter = document.querySelector('#postsFilter');
        if (postsFilter) {
          postsFilter.searchFor(e.detail.value);
        }
      },

      onUserChanged: function (event, detail) {
        if (detail) {
          this.user = detail;
        } else {
          this.user = null;
        }
      },

      toggleSearch: function () {
        this.$$("#search").toggle();
      },

      __equal: function (a, b) {
        return a === b;
      },

      routeChanged: function (newValue, oldValue) {
        if (this.$$("#drawer") && (!this.$$("#drawer").persistent)) {
          this.$$("#drawer").close();
        }
      }

    });
  </script>
</dom-module>
