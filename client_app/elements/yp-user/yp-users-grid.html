<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html" >

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html" >
<link rel="import" href="../../bower_components/paper-button/paper-button.html" >
<link rel="import" href="../../bower_components/paper-input/paper-input.html" >

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="yp-user-edit.html" >
<link rel="import" href="yp-user-image.html" >

<dom-module id="yp-users-grid">
  <template>
    <style>
      paper-dialog {
        width: 90%;
        height: 90%;
        background-color: #FFF;
      }

      iron-list {
        color: #000;
        height: 500px;
        width: 100%;
      }

      .userItem {
        padding-right: 16px;
      }
    </style>

    <paper-dialog id="dialog">
      <h2>[[headerText]]</h2>
      <iron-list items="[[users]]" as="user">
        <template>
          <div class="layout horizontal">
            <div class="userItem">
              [[user.id]]
            </div>
            <div class="userItem">
              [[user.name]]
            </div>
            <div class="userItem">
              [[user.email]]
            </div>
            <div hidden$="[[!adminUsers]]">
              <paper-button data-args$="[[user.id]]" on-tap="_removeAdmin">[[t('users.removeAdmin')]]</paper-button>
            </div>
            <div hidden$="[[adminUsers]]">
              <paper-button data-args$="[[user.id]]" on-tap="_removeUser">[[t('users.removeUser')]]</paper-button>
            </div>
          </div>
        </template>
      </iron-list>
      <div hidden$="[[!adminUsers]]" class="layout horizontal">
        <paper-input label="[[t('users.email')]]" value="{{addAdminEmail}}"></paper-input>
        <paper-button on-tap="_addAdmin">[[t('users.addAdmin')]]</paper-button>
      </div>
      <div hidden$="[[adminUsers]]" class="layout horizontal">
        <paper-input label="[[t('users.email')]]" value="{{inviteUserEmail}}"></paper-input>
        <paper-button on-tap="_inviteUser">[[t('users.inviteUser')]]</paper-button>
      </div>

      <div class="buttons">
        <paper-button dialog-dismiss>OK</paper-button>
      </div>
    </paper-dialog>

    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" on-response="_usersResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="removeAdminAjax" on-response="_removeAdminResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="removeUserAjax" on-response="_removeUserResponse"></yp-ajax>
      <yp-ajax method="POST" id="inviteUserAjax" on-response="_inviteUserResponse"></yp-ajax>
      <yp-ajax method="POST" id="addAdminAjax" on-response="_addAdminResponse"></yp-ajax>
    </div>

  </template>

  <script>
    Polymer({

      is: 'yp-users-grid',

      behaviors: [
        Polymer.appHelpers
      ],

      properties: {

        addAdminEmail: {
          type: String
        },

        inviteUserEmail: {
          type: String
        },

        users: {
          type: Array,
          notify: true
        },

        headerText: {
          type: String
        },

        groupId: {
          type: Number,
          observer: '_groupIdChanged'
        },

        communityId: {
          type: Number,
          observer: '_communityIdChanged'
        },

        adminUsers: {
          type: Boolean,
          value: false
        },

        selected: {
          type: Object
        },

        modelType: {
          type: String
        },

        opened: {
          type: Boolean,
          value: false
        }
      },

      _removeAdmin: function (event) {
        var userId = event.target.getAttribute('data-args');
        this.$.removeAdminAjax.body = {};
        if (this.modelType=="groups" && this.groupId) {
          this.$.removeAdminAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + userId + "/remove_admin";
          this.$.removeAdminAjax.generateRequest();
        } else if (this.modelType=="communities" && this.communityId) {
          this.$.removeAdminAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + userId + "/remove_admin";
          this.$.removeAdminAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _removeUser: function (event) {
        var userId = event.target.getAttribute('data-args');
        this.$.removeUserAjax.body = {};
        if (this.modelType=="groups" && this.groupId) {
          this.$.removeUserAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + userId + "/remove_user";
          this.$.removeUserAjax.generateRequest();
        } else if (this.modelType=="communities" && this.communityId) {
          this.$.removeUserAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + userId + "/remove_user";
          this.$.removeUserAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _addAdmin: function (event) {
        this.$.addAdminAjax.body = {};
        if (this.modelType=="groups" && this.groupId) {
          this.$.addAdminAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + this.addAdminEmail + "/add_admin";
          this.$.addAdminAjax.generateRequest();
        } else if (this.modelType=="communities" && this.communityId) {
          this.$.addAdminAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + this.addAdminEmail + "/add_admin";
          this.$.addAdminAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _inviteUser: function (event) {
        this.$.inviteUserAjax.body = {};
        if (this.modelType=="groups" && this.groupId) {
          this.$.inviteUserAjax.url = "/api/" + this.modelType + "/" + this.groupId + "/" + this.inviteUserEmail + "/invite_user";
          this.$.inviteUserAjax.generateRequest();
        } else if (this.modelType=="communities" && this.communityId) {
          this.$.inviteUserAjax.url = "/api/" + this.modelType + "/" + this.communityId + "/" + this.inviteUserEmail + "/invite_user";
          this.$.inviteUserAjax.generateRequest();
        } else {
          console.warn("Can't find model type or ids");
        }
      },

      _removeAdminResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('users.adminRemoved'));
        this.$.ajax.generateRequest();
      },

      _removeUserResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('users.userRemoved'));
        this.$.ajax.generateRequest();
      },

      _addAdminResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('users.adminAdded')+' '+this.addAdminEmail);
        this.set('addAdminEmail', null);
        this.$.ajax.generateRequest();
      },

      _inviteUserResponse: function () {
        window.appGlobals.notifyUserViaToast(this.t('users.userInvited')+' '+this.inviteUserEmail);
        this.set('inviteUserEmail', null);
        this.$.ajax.generateRequest();
      },

      _groupIdChanged: function (newGroupId) {
        if (newGroupId) {
          this.set('modelType', 'groups');
          this._generateRequest(newGroupId);
        }
      },

      _communityIdChanged: function (newCommunityId) {
        if (newCommunityId) {
          this.set('modelType', 'communities');
          this._generateRequest(newCommunityId);
        }
      },

      _generateRequest: function (id) {
        var adminsOrUsers = this.adminUsers ? "admin_users" : "users";
        this.$.ajax.url = "/api/"+this.modelType+"/"+id+"/"+adminsOrUsers;
        this.$.ajax.generateRequest();
      },

      _usersResponse: function (event, detail) {
        this.set('users', detail.response);
      //  debugger;
      },

      setup: function (groupId, communityId, adminUsers) {
        this.set('groupId', null);
        this.set('communityId', null);
        this.set('users', null);
        this.set('adminUsers', adminUsers);

        if (groupId)
          this.set('groupId', groupId);

        if (communityId)
          this.set('communityId', communityId);

        this._setupHeaderText();
      },

      open: function () {
        this.set('opened', true);
        this.$.dialog.open();
      },

      _setupHeaderText: function () {
        if (this.groupId) {
          if (this.adminUsers) {
            this.set('headerText', this.t('group.admins'));
          } else {
            this.set('headerText', this.t('group.users'));
          }
        } else if (this.communityId) {
          if (this.adminUsers) {
            this.set('headerText', this.t('community.admins'));
          } else {
            this.set('headerText', this.t('community.users'));
          }
        }
      },

      ready2: function () {
        /*
        this.$.grid.columns[5].renderer = this._adminActionRenderer;

        var filterElement = document.createElement('input');
        filterElement.setAttribute('type', 'search');
        filterElement.setAttribute('placeholder', 'Filter...');
        filterElement.style.width = '100%';

        var timer = 0;

        function filter() {
          clearTimeout(timer);
          timer = setTimeout(grid.refreshItems.bind(grid), 500);
        }

        filterElement.addEventListener('keyup', filter);
        filterElement.addEventListener('click', filter);

        this.$.grid.items = function(params, callback) {
          var filterValue = filterElement.value.toLowerCase();
          var data = this.users.filter(function(val) {
            return (val.toString().toLowerCase()).indexOf(filterValue) != -1;
          });
          var slice = data.slice(params.index, params.index + params.count);
          callback(slice, data.length);
        };

        this.$.grid.then(function() {
          this.$.grid.header.getCell(1, 0).content = filterElement;
        }.bind(this));
        */
      },

      _adminActionRenderer: function(cell) {
        cell.element.innerHTML = '';
        var child = document.createElement('progress');
        child.setAttribute('value', cell.data);
        cell.element.appendChild(child);
      },

      _onSelect: function() {
        debugger;
        if (this.$.grid.selection.selected().length === 0) {
          this.selected = null;
        } else {
          this.selected = this.users[this.$.grid.selection.selected()];
        }
      }
    });
  </script>
</dom-module>
