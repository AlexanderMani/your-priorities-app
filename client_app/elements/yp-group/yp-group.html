<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/yp-scroll-tab-behavior.html">
<link rel="import" href="../ac-activities/ac-activities.html">
<link rel="import" href="../yp-page/yp-page.html">

<link rel="import" href="../yp-post/yp-post.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-post/yp-post-card.html">
<link rel="import" href="../yp-post/yp-post-edit.html">
<link rel="import" href="../yp-post/yp-post-card-add.html">

<link rel="import" href="../yp-posts-filter/yp-posts-filter.html">
<link rel="import" href="../yp-post/yp-post-list.html">

<link rel="import" href="yp-group-card-large.html">

<dom-module id="yp-group">
  <template>
    <style>
      .objectives {
        padding-bottom: 40px;
        max-width: 432px;
      }

      .description {
        padding: 12px;
      }

      yp-ajax {
        background-color: var(--primary-background-color);
      }

      .counterInfo {
        font-size: 11px;
      }
    </style>

    <yp-page id="page" create-fab-icon="lightbulb-outline" create-fab-title="[[t('post.add_new')]]" on-yp-create-fab-tap="_newPost">

      <yp-group-card-large id="groupCard" class="largeCard" group="[[group]]" on-update-group="_refresh"></yp-group-card-large>

      <paper-tabs id="paper_tabs" class="tabs" selected="{{selected}}" focused>
        <template is="dom-if" if="[[group]]">
          <paper-tab id="tab1">
            <div class="layout vertical center-center tabCounterContainer">
              <span>[[t('posts.open')]]</span><div class="counterInfo" id="tabCountOpen"></div>
            </div>
          </paper-tab>
          <paper-tab>[[t('news')]]</paper-tab>
          <template is="dom-if" if="[[hasNonOpenPosts]]">
            <paper-tab>
              <div class="layout vertical center-center tabCounterContainer">
                <span>[[t('posts.inProgress')]]</span><div class="counterInfo" id="tabCountInProgress"></div>
              </div>
            </paper-tab>
            <paper-tab>
              <div class="layout vertical center-center tabCounterContainer">
                <span>[[t('posts.successful')]]</span><div class="counterInfo" id="tabCountSuccessful"></div>
              </div>
            </paper-tab>
            <paper-tab>
              <div class="layout vertical center-center tabCounterContainer">
                <span>[[t('posts.failed')]]</span><div class="counterInfo" id="tabCountFailed"></div>
              </div>
            </paper-tab>
          </template>
          <paper-tab>[[t('posts.map')]]</paper-tab>
        </template>
      </paper-tabs>

      <iron-pages class="tabPages" selected="{{selected}}" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
        <section>
          <div class="layout horizontal center-center">
            <yp-post-card-add on-new-post="_newPost" elevation="3"></yp-post-card-add>
          </div>
          <div class="layout horizontal center-center">
            <yp-post-list id="openPostList" selected-tab="[[selected]]" status-filter="open" tab-counter-id="tabCountOpen" searching-for="[[searchingFor]]" group="[[group]]" group-id="[[lastValidGroupId]]"></yp-post-list>
          </div>
        </section>
        <section>
          <ac-activities id="groupActivities" selected-tab="[[selected]]" group-id="[[group.id]]"></ac-activities>
        </section>
        <template is="dom-if" if="[[hasNonOpenPosts]]">
          <section>
            <div class="layout horizontal center-center">
              <yp-post-list id="inProgressPostList" selected-tab="[[selected]]" status-filter="in_progress" tab-counter-id="tabCountInProgress" searching-for="[[searchingFor]]" group="[[group]]" group-id="[[lastValidGroupId]]"></yp-post-list>
            </div>
          </section>
          <section>
            <div class="layout horizontal center-center">
              <yp-post-list id="successfulPostList" selected-tab="[[selected]]" status-filter="successful" tab-counter-id="tabCountSuccessful" searching-for="[[searchingFor]]" group="[[group]]" group-id="[[lastValidGroupId]]"></yp-post-list>
            </div>
          </section>
          <section>
            <div class="layout horizontal center-center">
              <yp-post-list id="failedPostList" selected-tab="[[selected]]" status-filter="failed" tab-counter-id="tabCountFailed" searching-for="[[searchingFor]]" group="[[group]]" group-id="[[lastValidGroupId]]"></yp-post-list>
            </div>
          </section>
        </template>
        <section>
          <template is="dom-if" if="[[mapActive]]" restamp>
            <yp-post-map group-id="[[group.id]]"></yp-post-map>
          </template>
        </section>
      </iron-pages>
    </yp-page>

    <div class="layout horizontal center-center">
      <yp-ajax large-spinner id="ajax" on-response="_groupsResponse"></yp-ajax>
      <yp-ajax id="pagesAjax" on-response="_pagesResponse"></yp-ajax>
    </div>

  </template>

  <script>
    Polymer({

      is: 'yp-group',

      behaviors: [
        Polymer.appHelpers,
        Polymer.ypThemeBehavior
      ],

      listeners: {
        'yp-post-count': '_updateTabPostCount'
      },

      properties: {

        groupId: {
          type: Number,
          observer: "_groupIdChanged"
        },

        group: {
          type: Object,
          notify: true,
          value: null
        },

        hideAdd: {
          type: Boolean,
          value: true
        },

        searchingFor: {
          type: String,
          value: null
        },

        selected: {
          type: Number,
          value: 0,
          observer: '_selectedChanged'
        },

        hasNonOpenPosts: {
          type: Boolean,
          value: false
        },

        groupTabName: {
          type: String,
          value: null,
          observer: '_tabNameChanged'
        },

        mapActive: {
          type: Boolean,
          value: false
        },

        lastValidGroupId: {
          type: String
        }
      },

      _tabNameChanged: function (newValue) {
        if (newValue) {
          this._setSelectedFromTabName(newValue)
        }
      },

      _setSelectedFromTabName: function (newValue) {
        if (newValue) {
          if (newValue=='open') {
            this.set('selected', 0);
          } else if (newValue=='news') {
            this.set('selected', 1);
          } else if (this.hasNonOpenPosts) {
            if (newValue=='in_progress') {
              this.set('selected', 2);
            } else if (newValue=='successful') {
              this.set('selected', 3);
            } else if (newValue=='failed') {
              this.set('selected', 4);
            } else if (newValue=='map') {
              this.set('selected', 5);
            }
          } else {
            if (newValue=='map') {
              this.set('selected', 2);
            }
          }
        }
      },

      _selectedChanged: function (newValue, oldValue) {
        if (this.group && newValue != oldValue) {
          if (newValue == 0 && this.$$("#openPostList")) {
            page(this.$$("#openPostList").buildPostsUrlPath());
          } else if (newValue == 1) {
            page("#!/group/" + this.group.id + '/news');
          } else if (this.hasNonOpenPosts && this.$$("#inProgressPostList")) {
            if (newValue == 2) {
              page(this.$$("#inProgressPostList").buildPostsUrlPath());
            } else if (newValue == 3) {
              page(this.$$("#successfulPostList").buildPostsUrlPath());
            } else if (newValue == 4) {
              page(this.$$("#failedPostList").buildPostsUrlPath());
            } else if (newValue == 5) {
              page("#!/group/" + this.group.id + '/map');
            }
          } else {
            if (newValue==2) {
              page("#!/group/" + this.group.id + '/map');
            }
          }
        }

        if (newValue == this.hasNonOpenPosts ? 5 : 2) {
          this.set('mapActive', true);
        } else {
          this.set('mapActive', false);
        }
      },

      _isTab: function (tabNr, selected) {
        return (selected==tabNr)
      },

      _updateTabPostCount: function (event, tabCounterInfo) {
        var tabCounter = this.$$('#'+tabCounterInfo.tabCounterId);
        if (tabCounter) {
          tabCounter.innerHTML = this.formatNumber(tabCounterInfo.count);
        }
      },

      _searchingForChanged: function (newValue, oldValue) {
      },

      _filterChanged: function (newValue, oldValue) {
      },

      _categoryIdChanged: function (newValue, oldValue) {
      },

      _openEdit: function () {
        this.$$("#groupEdit").open('edit', { groupId: this.group.id });
      },

      _refresh: function () {
        this.$.ajax.generateRequest();
        this.$$("#groupActivities").loadNewData();
      },

      ready: function () {
      },

      _groupIdChanged: function (newValue, oldValue) {
        if (newValue && newValue!=this.lastValidGroupId) {
          this.set('lastValidGroupId', newValue);
          this.$.ajax.url = '/api/groups/' + this.groupId;
          this.$.ajax.generateRequest();
        }
       },

      _pagesResponse: function (event, detail) {
        this.fire('yp-set-pages', detail.response);
      },

      _groupsResponse: function (event, detail, sender) {
        this.set('group', detail.response.group);
        if (this.group.theme_id!=null) {
          this.setTheme(this.group.theme_id);
        } else if (this.group.Community.theme_id!=null) {
          this.setTheme(this.group.Community.theme_id);
        } else if (this.group.Community.Domain.theme_id!=null) {
          this.setTheme(this.group.Community.Domain.theme_id);
        }
        this.set('hasNonOpenPosts', detail.response.hasNonOpenPosts);
        this.$.pagesAjax.url = "/api/groups/"+this.group.id+"/pages";
        this.$.pagesAjax.generateRequest();

        if (this.group.GroupHeaderImages && this.group.GroupHeaderImages.length>0) {
          this.$.page.setupTopHeaderImage(this.group.GroupHeaderImages);
        }

        if (this.groupTabName) {
          this._setSelectedFromTabName(this.groupTabName);
        }

        this.fire("change-header", { headerTitle: this.group.Community.name,
          headerDescription: this.group.Community.description,
          headerIcon: "social:group",
          enableSearch: true,
          backPath: "#!/community/" + this.group.community_id });
      },

      _newPost: function () {
        window.appGlobals.activity('open', 'newPost');
        var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("postEdit");
        dialog.setup(null, this.group, true, null);
        dialog.open('new', { groupId: this.groupId });
      }
    });
  </script>
</dom-module>
