<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-session/yp-session.html">
<link rel="import" href="../yp-user/yp-user-login.html">

<dom-module id="yp-app-user">
    <template>
      <style>
        paper-toast {
          z-index: 9999;
        }
      </style>

      <yp-session id="session"></yp-session>
      <yp-user-login id="userLogin" register="true" on-login="_handleLogin"></yp-user-login>

      <yp-ajax id="isLoggedInAjax" method="GET" url="/api/users/isloggedin" on-response="_isLoggedInResponse"></yp-ajax>
      <yp-ajax id="logoutAjax" method="POST" url="/api/users/logout" on-response="_logoutResponse"></yp-ajax>

      <paper-toast id="loginToast" text="[[toastLoginTextCombined]]"></paper-toast>
      <paper-toast id="logoutToast" text="[[toastLogoutTextCombined]]"></paper-toast>
  </template>

  <script>
    (function () {
      Polymer({

        is: 'yp-app-user',

        behaviors: [
          Polymer.appHelpers
        ],

        properties: {
          loginForEditParams: {
            type: Object
          },

          toastLoginTextCombined: {
            type: String
          },

          toastLogoutTextCombined: {
            type: String
          },

          user: {
            type: Object,
            observer: "_onUserChanged"
          },

          endorsementIdeasIndex: {
            type: Object
          },

          pointQualitiesIndex: {
            type: Object
          }
        },

        loginForEdit: function(editDialog,newOrUpdate,params) {
          this.loginForEditParams = { editDialog: editDialog, newOrUpdate: newOrUpdate, params: params };
          this.$.userLogin.open();
        },

        getUser: function () {
          return this.$.session.get('user');
        },

        setUser: function (user) {
          this.$.session.set('user', user);
          this.user = user;
        },

        removeUserSession: function () {
          this.$.session.unset('user');
          this.user = null;
        },

        loggedIn: function () {
          return this.$.session.has('user');
        },

        logout: function () {
          this.$.logoutAjax.body = {};
          this.$.logoutAjax.generateRequest();
        },

        ready: function () {
          window.appUser = this;
          this.$.isLoggedInAjax.generateRequest();
        },

        updateEndorsementForIdea: function (ideaId, newEndorsement) {
          if (this.user.Endorsements) {
            var hasChanged = false;
            for(var i=0; i<this.user.Endorsements.length; i++) {
              if (this.user.Endorsements[i].idea_id===ideaId) {
                if (newEndorsement) {
                  this.user.Endorsements[i] = newEndorsement;
                } else {
                  this.user.Endorsements[i].splice(i, 1);
                }
                hasChanged = true;
                break;
              }
            }
            if (hasChanged)
              this._updateEndorsementIdeasIndex(this.user);
          }
        },

        _updateEndorsementIdeasIndex: function (user) {
          if (user && user.Endorsements && user.Endorsements.length>0) {
            this.endorsementIdeasIndex = {};
            for(var i=0; i<user.Endorsements.length; i++){
              this.endorsementIdeasIndex[ user.Endorsements[i].idea_id ] = user.Endorsements[i];
            }
          } else {
            this.endorsementIdeasIndex = {}
          }
        },

        updatePointQualityForIdea: function (pointId, newPointQuality) {
          if (this.user.PointQualities) {
            var hasChanged = false;
            for(var i=0; i<this.user.PointQualities.length; i++) {
              if (this.user.PointQualities[i].point_id===pointId) {
                if (newPointQuality) {
                  this.user.PointQualities[i] = newPointQuality;
                } else {
                  this.user.PointQualities[i].splice(i, 1);
                }
                hasChanged = true;
                break;
              }
            }
            if (hasChanged)
              this._updateEndorsementIdeasIndex(this.user);
          }
        },

        _updatePointQualitiesIndex: function (user) {
          if (user && user.PointQualities && user.PointQualities.length>0) {
            this.pointQualitiesIndex = {};
            for(var i=0; i<user.PointQualities.length; i++){
              this.pointQualitiesIndex[ user.PointQualities[i].point_id ] = user.PointQualities[i];
            }
          } else {
            this.pointQualitiesIndex = {}
          }
        },

        _onUserChanged: function (newValue, oldValue) {
          this.fire("user-changed", newValue);
          this._updateEndorsementIdeasIndex(newValue);
          this._updatePointQualitiesIndex(newValue);
        },

        _handleLogin: function (event, user) {
          this.$.userLogin.close();
          this.setUser(user);
          this.toastLoginTextCombined = this.t("login.complete.for")+ " " + this.user.email;
          this.$.loginToast.show();
          if (this.loginForEditParams) {
            this.loginForEditParams.editDialog.open(this.loginForEditParams.newOrUpdate,this.loginForEditParams.params);
          }
          this.fire("login")
        },

        _logoutResponse: function (event, detail) {
          this.toastLogoutTextCombined = this.t("logout.complete.for")+ " " + this.user.email;
          this.removeUserSession();
          this.$.logoutToast.show();
        },

        _isLoggedInResponse: function(event, detail) {
          if (detail.response===0) {
            this.removeUserSession();
          } else if (detail.response.email) {
            this.setUser(detail.response);
            this.fire("is-logged-in")
          }
        }
      });
    }());
  </script>
</dom-module>
