<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html" >
<link rel="import" href="../../bower_components/iron-icons/image-icons.html" >
<link rel="import" href="../../bower_components/iron-icons/social-icons.html" >
<link rel="import" href="../../bower_components/iron-image/iron-image.html" >

<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/yp-logged-in-user-behavior.html">
<link rel="import" href="../yp-user/yp-user-image.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">

<dom-module id="yp-point-comment-edit">

  <template>

    <style>
      :host {
        width: 800px;
        margin-top: 16px;
      }

      paper-material {
        background-color: #FFF;
      }

      paper-textarea {
        width: 650px;
      }

      paper-button {
        margin-top: 16px;
        background-color: var(--accent-color);
        color: #FFF;
      }

      .userImage {
        padding-top: 30px;
        padding-left: 16px;
        padding-right: 16px;
      }
    </style>

    <div class="layout vertical">
      <div class="layout horizontal start">
        <yp-user-image class="userImage" user="[[loggedInUser]]"></yp-user-image>
        <div class="layout vertical">
          <paper-textarea id="pointComment"
                          required
                          minlength="15"
                          name="pointComment"
                          value="{{comment.content}}"
                          label="[[t('point.addComment')]]"
                          char-counter
                          rows="2"
                          max-rows="3"
                          on-keydown="_keyDown"
                          maxlength="200">
          </paper-textarea>
          <div class="layout horizontal end-justified">
            <paper-button raised on-tap="_sendComment">[[t('point.postComment')]]</paper-button>
          </div>
        </div>
      </div>

      <div class="layout horizontal center-center">
        <yp-ajax large-spinner id="postCommentAjax" method="POST" on-response="_newsCommentResponse"></yp-ajax>
      </div>

    </div>
    <iron-signals on-iron-signal-logged-in="_userLoggedIn"></iron-signals>
  </template>

  <script>
    Polymer({

      is: 'yp-point-comment-edit',

      properties: {

        comment: {
          type: Object,
          notify: true
        },

        point: {
          type: Object,
          notify: true
        },

        image: {
          type: Object,
          notify: true
        }

      },

      behaviors: [
        Polymer.appHelpers,
        Polymer.ypLoggedInUserBehavior
      ],

      ready: function () {
        this._reset();
      },

      _reset: function () {
        this.set('comment', { content: '' });
      },

      _sendComment: function () {
        var body;
        if (this.point.content && this.point.content.length>15) {
          if (this.point) {
            body = { point_id: this.point.id };
            this.$.postCommentAjax.url = '/api/points/'+this.point.id+'/comment';
          } else if (this.image) {
            body = { image_id: this.image.id };
            this.$.postCommentAjax.url = '/api/images/'+this.image.id+'/comment';
          } else {
            console.error("Can't find send ids");
          }
          this.$.postCommentAjax.body = _.merge(body, { comment: this.comment } );
          this.$.postCommentAjax.generateRequest();
        } else {
          // TODO
        }
      },

      _newsCommentResponse: function () {
        this.fire('refresh');
        this._reset();
      },

      _keyDown: function (event) {
        if (event.code == 'enter') {
          this._sendComment();
        }
      }
    })
  </script>
</dom-module>
