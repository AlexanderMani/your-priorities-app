  <!--
      TODO(polyup): unable to infer path to components
      directory. This import path is probably incomplete.
   -->
  <link rel="import" href="iron-flex-layout/iron-flex-layout.html">
<dom-module id="yrpri-idea">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [layout] {
      @apply(--layout);
    }
    [layout][flex] {
      @apply(--layout-flex);
    }
    [layout][horizontal] {
      @apply(--layout-horizontal);
    }
    [layout][around-justified] {
      @apply(--layout-around-justified);
    }
    [layout][vertical] {
      @apply(--layout-vertical);
    }
  </style>
  <link rel="import" type="css" href="yrpri-idea.css">
  <template>

    <div layout="" flex="" horizontal$="{{computeHorizontal(small)}}">
      <div layout="" style="vertical-align: top;width:100%;">
        <div layout="" horizontal="" around-justified="" flex="">
          <template is="dom-if" if="{{showCategory}}">
            <div>
              <iron-image class="category" src="{{computeSrc(idea)}}">

            </iron-image></div>
          </template>
          <div flex="" class="header" on-tap="goToIdea" layout="" vertical="">
            <div>
              <b>{{computeExpression1(idea, small)}}</b>
            </div>
            <template is="dom-if" if="{{showName}}">
              <div class="userScreenname">
                <span>{{idea.User.login}}</span>
              </div>
            </template>
            <template is="dom-if" if="{{computeIf(showCategory, small)}}">
              <div class="categoryName">
                <span>{{idea.Category.name}}</span>
              </div>
            </template>

          </div>
          <template is="dom-if" if="{{computeIf2(small)}}">
            <div flex="" style="">
              <idea-action-bar idea="{{idea}}" small="{{small}}" flex="" style="float:right; clear:right;"></idea-action-bar>
            </div>
            <paper-icon-button icon="report" on-tap="report" style="color:#eee;"></paper-icon-button>
            <paper-icon-button class="share" on-tap="notify" style="color:#b0b0b0;" icon="image:remove-red-eye"></paper-icon-button>
            <paper-icon-button class="share" on-tap="share" icon="social:share"></paper-icon-button>
            <template is="dom-if" if="{{computeIf6()}}">
              <paper-menu-button class="selected-items" layout="" horizontal="">
                <paper-icon-button icon="more-vert"></paper-icon-button>
                <iron-dropdown class="dropdown" horizontal-align="right">
                  <div class="separator">Admin</div>
                  <paper-item>Breyta</paper-item>
                  <paper-item>Staða</paper-item>
                  <paper-item>Eyða</paper-item>
                </iron-dropdown>
              </paper-menu-button>
            </template>
          </template>
        </div>

        <div layout="" class="description">
          <template is="dom-if" if="{{idea.IdeaRevision[0]}}">
            <span>{{computeExpression2(idea, small)}}</span>
          </template>
          <template is="dom-if" if="{{idea.description}}">
            <span>{{computeExpression3(idea, small)}}</span>
          </template>
          <template is="dom-if" if="{{computeIf3(idea)}}">
            <span>{{computeExpression4(idea, small)}}</span>
          </template>
        </div>
        <template is="dom-if" if="{{small}}">
          <idea-action-bar idea="{{idea}}" small="{{small}}" style=""></idea-action-bar>
        </template>
        <template is="dom-if" if="{{computeIf4(small)}}">
          <paper-spinner id="spinner" style="padding-top:4px;display:block;" active=""></paper-spinner>
          <template is="dom-if" if="{{endorsements}}">
            <div style="padding-top: 16px; opacity: 0.80;">
              <template is="dom-repeat" items="{{limitTo(endorsements, userImagesLimit)}}" as="endorsement" index-as="endorsementIndex">
                <user-image user="{{endorsement.User}}" small=""></user-image>
              </template>
              <div id="moreImages" style="display:none;">
                <paper-icon-button class="more" id="moreImagesButton" icon="add" on-tap="moreUserImages"></paper-icon-button>
                <span id="numberOfMoreUserImages" style="display:none;margin-bottom:16px;padding-left:0px;margin-left:0px;">{{computeExpression5()}}</span>
              <span id="restOfUserImages" style="display: none;">
                <template is="dom-repeat" items="{{limitFrom(endorsements, userImagesLimit, endorsements.length)}}" as="endorsement" index-as="endorsementIndex">
                  <user-image user="{{endorsement.User}}" small=""></user-image>
                </template>
              </span>
                </div>
            </div>
          </template>
        </template>
      </div>
    </div>

    <template is="dom-if" if="{{computeIf5(small)}}">
      <iron-ajax auto="true" id="endorsementAjax" url="{{computeUrl(idea)}}" last-response="{{response}}" handle-as="json">
      </iron-ajax>
    </template>
  </template>
  <script>
    Polymer({
      is: 'yrpri-idea',
      properties: {
        endorsements: {
          type: Array,
          value: function () {
            return [];
          }
        },
        idea: { notify: true },
        response: { observer: 'responseChanged' },
        showCategory: { notify: true },
        showName: { notify: true },
        small: { notify: true },
        userImagesLimit: {
          type: Number,
          value: 42,
          notify: true
        }
      },
      share: function () {
        window.globals.activity('Anonymous', 'open', 'ideaShare');
        window.globals.openDialog('ideas.share');
      },
      report: function () {
        window.globals.activity('Anonymous', 'open', 'ideaReport');
        window.globals.openDialog('ideas.report');
      },
      notify: function () {
        window.globals.activity('Anonymous', 'open', 'ideaNotify');
        window.globals.openDialog('ideas.notify');
      },
      allEndorsementsLength: function (idea) {
        return this.endorsements.length;
      },
      countUserImagesLeft: function (e) {
        return this.allEndorsementsLength(this.idea) - this.userImagesLimit;
      },
      responseChanged: function (detail, e, sender) {
        this.$.spinner.active = false;
        this.$.spinner.style.display = 'none';
        this.endorsements = detail;
        if (this.endorsements.length > this.userImagesLimit) {
          this.$.moreImages.style.display = 'inline';
        }
      },
      moreUserImages: function () {
        this.$.moreImagesButton.style.display = 'none';
        this.$.numberOfMoreUserImages.style.display = 'none';
        this.$.restOfUserImages.style.display = 'inline';
      },
      goToIdea: function (e) {
        var ideaUrl = '/#/ideas/' + this.idea.id;
        window.globals.activity('Anonymous', 'open', 'idea', ideaUrl);
        window.location = ideaUrl;
      },
      computeHorizontal: function (small) {
        return !small;
      },
      computeIf: function (showCategory, small) {
        return showCategory && !small;
      },
      computeIf2: function (small) {
        return !small;
      },
      computeIf3: function (idea) {
        return !idea.description;
      },
      computeIf4: function (small) {
        return !small;
      },
      computeIf5: function (small) {
        return !small;
      },
      computeSrc: function (idea) {
        return 'https://s3.amazonaws.com/' + this.s3bucketName('') + '/categories/icons/000/000/' + this.padNumber(idea.Category.id) + '/icon_50/' + idea.Category.icon_file_name;
      },
      computeIf6: function () {
        return false;
      },
      computeUrl: function (idea) {
        return '/api/ideas/' + idea.id + '/endorsements';
      },
      computeExpression1: function (idea, small) {
        return this.truncate(this.trim(idea.name), small ? 60 : 200);
      },
      computeExpression2: function (idea, small) {
        return this.truncate(this.trim(idea.IdeaRevision[0].description), small ? 200 : 10000, '...');
      },
      computeExpression3: function (idea, small) {
        return this.truncate(this.trim(idea.description), small ? 200 : 10000, '...');
      },
      computeExpression4: function (idea, small) {
        return this.truncate(this.trim(idea.Points[0].content), small ? 200 : 10000, '...');
      },
      computeExpression5: function () {
        return this.countUserImagesLeft(0);
      }
    });
  </script>
</dom-module>
