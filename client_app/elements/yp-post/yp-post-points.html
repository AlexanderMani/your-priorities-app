<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-char-counter.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-point/yp-point.html">

<dom-module id="yp-post-points">
  <template>
    <style>

      .main-container {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }

      .point {
        padding: 32px;
        @apply(--layout-vertical);
      }

      .pointText {
        margin-bottom: 16px;
        padding: 16px;
        width: 420px;
      }

      yp-point {
        width: 440px;
      }

      @media (max-width: 1024px) {
        .pointText {
          width: 420px;
          font-size: 30px;
        }
      }

      @media (max-width: 600px) {
        .pointText {
          width: 140px;
          font-size: 30px;
        }

        yp-point {
          width: 140px;
        }

        .main-container {
          width: 140px;
        }
      }

      @media (max-width: 360px) {
        .pointText {
          width: 110px;
          font-size: 9px;
        }

        yp-point {
          width: 140px;
        }

        .main-container {
          width: 110px;
        }
      }

      paper-toast {
         z-index: 9999;
      }

      paper-material {
        background-color: #fff;
      }

      yp-point {
        padding-top: 16px;
      }

      .pointMaterial {
        margin-bottom: 18px;
        padding-top: 8px;
      }

      .thumbIcon {
        height: 64px;
        width: 64px;
        padding-bottom: 16px;
        color: var(--primary-color);
      }

      paper-fab::shadow #icon {
        background-color: var(--accent-color);
        color: var(--icon-general-color, #FFF);
      }

      paper-fab {
        background-color: var(--accent-color);
      }

      .addPointFab {
        width: 100%;
      }
    </style>

    <iron-media-query query="(min-width: 1024px)" query-matches="{{largeMode}}"></iron-media-query>

    <template is="dom-if" if="[[points]]">
      <template is="dom-if" if="[[largeMode]]">
        <div class="main-container">

          <div class="point">

            <paper-material id="pointUpMaterial" elevation="0" class="pointText" animated>
              <div class="layout horizontal start-justified">
                <iron-icon icon="thumb-up" class="thumbIcon"></iron-icon>
              </div>
              <paper-textarea id="up_point" on-tap="focusUpPoint" on-focus="focusTextArea" on-blur="blurTextArea"
                              bind-value="{{textValueUp}}" value=[[textValueUp]] label="[[t('point.for')]]" char-counter rows="2"
                              max-rows="5" maxlength="500"></paper-textarea>

              <template is="dom-if" if="[[ifLengthIsRight(textValueUp)]]">
                <div class="addPointFab layout horizontal center-center">
                  <paper-fab icon="add" mini="" elevation="3" on-tap="addPointUp" title="[[t('point.add_up')]]"></paper-fab>
                </div>
              </template>
            </paper-material>

            <div id="allUpPoints">
              <template is="dom-repeat" items="[[upPoints]]" as="point">
                <paper-material elevation="1" class="pointMaterial">
                  <yp-point point="[[point]]"></yp-point>
                </paper-material>
              </template>
            </div>
          </div>

          <div class="point">

            <paper-material id="pointDownMaterial" elevation="0" class="pointText" animated>
              <div class="layout horizontal start">
                <iron-icon icon="thumb-down" class="thumbIcon"></iron-icon>
              </div>

              <paper-textarea id="down_point" on-tap="focusDownPoint" on-focus="focusTextArea" on-blur="blurTextArea"
                              bind-value="{{textValueDown}}" value=[[textValueDown]] label="[[t('point.against')]]" char-counter rows="2"
                              max-rows="5" maxlength="500"></paper-textarea>

              <template is="dom-if" if="[[ifLengthIsRight(textValueDown)]]">
                <div class="addPointFab layout horizontal center-center">
                  <paper-fab icon="add" mini="" z="3" on-tap="addPointDown" title="[[t('point.add_down')]]"></paper-fab>
                </div>
              </template>
            </paper-material>

            <div id="allDownPoints">
              <template is="dom-repeat" items="[[downPoints]]" as="point">
                <paper-material elevation="1" class="pointMaterial">
                  <yp-point point="[[point]]"></yp-point>
                </paper-material>
              </template>
            </div>
          </div>
        </div>
      </template>
      <template is="dom-if" if="[[!largeMode]]">
        <template is="dom-repeat" items="[[points]]" as="point">
          <paper-material elevation="1" class="pointMaterial">
            <yp-point point="[[point]]"></yp-point>
          </paper-material>
        </template>
      </template>
    </template>

    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" on-response="_response"></yp-ajax>
      <yp-ajax id="newPointAjax" method="POST" url="/api/points" on-response="_newPointResponse"></yp-ajax>
    </div>

    <paper-toast id="newPointToast" text="[[newPointTextCombined]]"></paper-toast>
  </template>

  <script>
    (function () {
      Polymer({

        is: 'yp-post-points',

        behaviors: [
          Polymer.appHelpers
        ],

        properties: {

          downPoints: {
            type: Array,
            value: function () {
              return [];
            }
          },

          upPoints: {
            type: Array,
            value: function () {
              return [];
            }
          },

          textValueUp: {
            type: String
          },

          textValueDown: {
            type: String
          },

          newPointTextCombined: {
            type: String
          },

          post: {
            type: Object,
            observer: "_postChanged"
          },

          points: {
            type: Array,
            value: null
          },

          largeMode: {
            type: Boolean,
            value: false
          }
        },

        _postChanged: function (newPost) {
          // Remove any manually inserted points when the list is updated
          if (newPost) {
            this.$.ajax.url = '/api/posts/' + newPost.id + '/points';
            this.$.ajax.generateRequest();
          }
        },

        _response: function (event, detail) {
          this.set('points', detail.response);

          this.removeElementsByClass(this, 'inserted-outside-list');

          if (this.points.length>0) {
            this.set('upPoints', this.points.filter(function (x) {
              return x.value > 0;
            }));
            this.set('downPoints', this.points.filter(function (x) {
              return x.value < 0;
            }));
          } else {
            this.set('upPoints', []);
            this.set('downPoints', []);
          }

          if (!this.largeMode) {
            this.set('points', this.interleaveArrays(this.upPoints, this.downPoints));
          }
        },

        _insertNewPoint: function (point) {
          var materialElement = document.createElement('paper-material');
          materialElement.elevation = '1';
          var pointElement = document.createElement('yp-point');
          pointElement.point = point;
          pointElement.className += "inserted-outside-list";
          materialElement.addChild(pointElement);
          if (point.value>0) {
            this.$$('#allUpPoints').insertBefore(materialElement, this.$$('#allUpPoints').firstChild);
          }
          else if (point.value<0) {
            this.$$('#allDownPoints').insertBefore(materialElement, this.$$('#allDownPoints').firstChild);
          }
        },

        _newPointResponse: function (event, detail) {
          var point = detail.response;
          if (point.value>0) {
            this.newPointTextCombined = this.t("new.point.for.added")+ " " + this.truncate(point.content,21);
            this.set("textValueUp","");
          } else {
            this.newPointTextCombined = this.t("new.point.against.added")+ " " +  this.truncate(point.content,21);
            this.set("textValueDown","");
          }
          this._insertNewPoint(point);
          this.set('post.counter_points',this.post.counter_points+1);
          this.$.newPointToast.show();
        },

        addPointUp: function () {
          this.addPoint(this.textValueUp, 1);
          window.appGlobals.activity('add', 'pointUp');
        },

        addPointDown: function () {
          this.addPoint(this.textValueDown, -1);
          window.appGlobals.activity('add', 'pointDown');
        },

        addPoint: function (content, value) {
          if (window.appUser.loggedIn()===true) {
            this.$.newPointAjax.url = "/api/points/"+this.post.group_id;
            this.$.newPointAjax.body = {
              postId: this.post.id,
              content: content,
              value: value
            };
            this.$.newPointAjax.generateRequest();
          } else {
            window.appUser.loginForNewPoint(this, { content: content, value: value });
          }
        },

        focusUpPoint: function () {
          window.appGlobals.activity('focus', 'pointUp');
        },

        focusDownPoint: function () {
          window.appGlobals.activity('focus', 'pointDown');
        },

        focusTextArea: function (event) {
          event.currentTarget.parentElement.elevation=4;
        },

        blurTextArea: function (e) {
          event.currentTarget.parentElement.elevation=0;
        },

        ifLengthIsRight: function (textValue) {
          return textValue.length > 20;
        }

      });
    }());
  </script>
</dom-module>
