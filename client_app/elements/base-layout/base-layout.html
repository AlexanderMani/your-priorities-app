<polymer-element name="base-layout" attributes="selected needLogin user filter pageTitle spinner idea groupId groupName showLogo categories ideasFilter name subTitle category" extends="logged-in-page">
  <template>

    <link rel="stylesheet" href="base-layout.css">

    <template if="{{groupId=='474' || groupId=='368'}}">
      <style>
        #drawerPanel core-scroll-header-panel::shadow #headerBg {
          background: url(nhs-citizen.jpg) center center no-repeat;
          background-size: 100%;
        }
      </style>
    </template>
    <app-globals id="globals"></app-globals>

    <core-media-query query="max-width: 550px" queryMatches="{{smallScreen}}"></core-media-query>

    <material-search id="search" narrow="{{narrow}}" groupId="{{groupId}}"
                     previousSearches="{{previousSearches}}"></material-search>

    <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsiveWidth="2000px">

      <core-header-panel mode="scroll" drawer>
        <base-nav-left user="{{user}}" idea="{{idea}}"></base-nav-left>
      </core-header-panel>

      <core-scroll-header-panel id="scrollheader" main condenses keepCondensedHeader on-trackstart="{{onRefreshStart}}"
                                on-tracky="{{onMainAreaTrack}}" on-trackend="{{onRefreshUp}}">
        <core-toolbar id="mainheader" class="tall">

          <template if="{{selected!='groups'}}">
              <paper-icon-button icon="arrow-back" style="color:#fff;margin-left:48px;" on-tap="{{goBack}}"></paper-icon-button>
          </template>
          <template if="{{false && !idea && selected!='ideas-search'}}">
            <paper-icon-button id="navicon" icon="menu" core-drawer-toggle></paper-icon-button>
          </template>

          <div flex></div>
          <paper-shadow z="2" class="bottom indent title titleBottom">
            <div layout horizontal>

              <template if="{{showLogo}}">
                <div class="baseImageContainer">
                  <image sizing="cover" height="100" class="baseImage" src="/images/{{'' | instanceLogoFilename}}"></image>
                </div>
              </template>

              <template if="{{!showLogo && category}}">
                <div class="baseImageContainer">
                  <core-image sizing="contain"
                              preload
                              class="baseImage"
                              src="https://s3.amazonaws.com/{{'' | s3bucketName}}/categories/icons/000/000/{{category.id | padNumber}}/icon_100/{{category.icon_file_name}}">
                  </core-image>
                </div>
              </template>

              <div layout vertical>
                <div layout horizontal>
                  <div style="padding-right: 4px;padding-top:8px;margin-top:16px;vertical-align: top;text-align: start;">
                    {{name}}
                  </div>
                </div>

                <div style="font-size:16px;margin-bottom: 8px;padding-bottom:8px;padding-top:4px;padding-left:4px;">
                  <div layout horizontal>
                    <template if="{{ideasFilter}}">
                      <ideas-filter id="filter" categories="{{categories}}" filter="{{filter}}" groupId="{{groupId}}" groupName="{{groupName}}"></ideas-filter>
                    </template>

                    <template if="{{!ideasFilter}}">
                      <div>
                        {{subTitle}}
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </paper-shadow>
          <paper-icon-button icon="search" class="fade-on-drawer-open" on-tap="{{toggleSearch}}"></paper-icon-button>

          <paper-icon-button icon="social:group-add" class="selected-items" on-tap="{{archiveAll}}"></paper-icon-button>

          <paper-menu-button class="selected-items" layout horizontal>
            <paper-icon-button icon="more-vert"></paper-icon-button>
            <paper-dropdown class="dropdown" halign="right">
              <paper-item>Mín síða</paper-item>
              <paper-item>Um þessa síðu</paper-item>
              <paper-item>Hjálp</paper-item>
              <paper-item>Stillingar</paper-item>
            </paper-dropdown>
          </paper-menu-button>
        </core-toolbar>

        <template if="{{needLogin && !user}}">
          <shadow></shadow>
        </template>

        <template bind if="{{!needLogin || user}}">
          <div layout horizontal center-justified>
            <paper-spinner id="spinner" style="padding-top:72px;"></paper-spinner>
          </div>
          <div class="content" style="margin-top:24px;">
            <content></content>
          </div>
        </template>
      </core-scroll-header-panel>

    </core-drawer-panel>
  </template>
  <script>
    Polymer({
      previousSearches: ["Blah", "Hello"],
      smallScreen: false,
      selectedThreads: [],
      group: null,

      goBack: function () {
        if (this.selected=="ideas") {
          window.location = "/";
        } else {
          window.history.back();
        }
      },

      setSpinner: function(value) {
        this.$.spinner.active = value;
        if (value===true) {
          this.$.spinner.style.paddingTop="72px";
        } else {
          this.$.spinner.style.paddingTop="16px";
        }
      },

      toggleSearch: function (e) {
        this.$.search.toggle();
      },

      domReady: function () {
        this.titleStyle = this.shadowRoot.querySelector('.title').style;
        this.checkForSmallScreen();

        window.onresize = function (event) {
          this.checkForSmallScreen();
        }.bind(this);

        var localTitleStyle = this.titleStyle;

        addEventListener('core-header-transform', function (e) {
          var d = e.detail;
          var m = 250 - d.condensedHeight;
          var scale = Math.max(0.15, (m - d.y) / (m / 0.25) + 0.75);
          localTitleStyle.transform = localTitleStyle.webkitTransform =
                  'scale(' + scale + ') translateZ(0)';
        });
      },

      updateFilter: function() {
        this.$.filter.updateFilter();
      },

      checkForSmallScreen: function () {
        if (this.smallScreen === true) {
          this.titleStyle.fontSize = "24px";
        } else {
          this.titleStyle.fontSize = "40px";
        }
      }
    });
  </script>
</polymer-element>
