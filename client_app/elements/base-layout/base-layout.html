  <!--
      TODO(polyup): unable to infer path to components
      directory. This import path is probably incomplete.
   -->
  <link rel="import" href="iron-flex-layout/iron-flex-layout.html">
<!--
    TODO(polyup): Inheriting from other custom elements is not yet supported.
    See: https://www.polymer-project.org/1.0/docs/migration.html#inheritance
 -->
<dom-module id="base-layout">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [layout] {
      @apply(--layout);
    }
    [layout][horizontal] {
      @apply(--layout-horizontal);
    }
    [layout][vertical] {
      @apply(--layout-vertical);
    }
    [layout][center-justified] {
      @apply(--layout-center-justified);
    }
  </style>
  <link rel="import" type="css" href="base-layout.css">
  <template>

    <app-globals id="globals"></app-globals>

    <!-- Temporary hardcoding of those images until they get added to the database -->

    <template is="dom-if" if="{{computeIf(groupId)}}">
      <style>
        #drawerPanel core-scroll-header-panel::shadow #headerBg {
          background: url(nhs-citizen.jpg) center center no-repeat;
          background-size: 100%;
        }
      </style>
    </template>

    <template is="dom-if" if="{{computeIf2(groupId)}}">
      <style>
        #drawerPanel core-scroll-header-panel::shadow #headerBg {
          background: url(bulgaria_by_Stella.png) center center no-repeat;
          background-size: 100%;
        }
      </style>
    </template>

    <iron-media-query query="max-width: 550px" query-matches="{{smallScreen}}"></iron-media-query>

    <material-search id="search" narrow="{{narrow}}" groupid="{{groupId}}" previoussearches="{{previousSearches}}"></material-search>

    <paper-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsive-width="2000px">

      <paper-header-panel mode="scroll" drawer="">
        <base-nav-left user="{{user}}" idea="{{idea}}"></base-nav-left>
      </paper-header-panel>

      <paper-scroll-header-panel id="scrollheader" main="" condenses="" keep-condensed-header="" on-trackstart="onRefreshStart" on-tracky="onMainAreaTrack" on-trackend="onRefreshUp">
        <paper-toolbar id="mainheader" class="tall">

          <template is="dom-if" if="{{computeIf3(selected)}}">
              <paper-icon-button icon="arrow-back" style="color:#fff;margin-left:48px;" on-tap="goBack"></paper-icon-button>
          </template>
          <template is="dom-if" if="{{computeIf4(idea, selected)}}">
            <paper-icon-button id="navicon" icon="menu" core-drawer-toggle=""></paper-icon-button>
          </template>

          <div flex=""></div>
          <paper-material elevation="2" class="bottom indent title titleBottom">
            <div layout="" horizontal="">

              <template is="dom-if" if="{{showLogo}}">
                <div class="baseImageContainer">
                  <img sizing="cover" height="100" class="baseImage" src="{{computeSrc()}}">
                </div>
              </template>

              <template is="dom-if" if="{{computeIf5(category, showLogo)}}">
                <div class="baseImageContainer">
                  <iron-image sizing="contain" preload="" class="baseImage" src="{{computeSrc2(category)}}">
                  </iron-image>
                </div>
              </template>

              <div layout="" vertical="">
                <div layout="" horizontal="">
                  <div style="padding-right: 4px;padding-top:8px;margin-top:16px;vertical-align: top;text-align: start;">
                    <span>{{name}}</span>
                  </div>
                </div>

                <div style="font-size:16px;margin-bottom: 8px;padding-bottom:8px;padding-top:4px;padding-left:4px;">
                  <div layout="" horizontal="">
                    <template is="dom-if" if="{{ideasFilter}}">
                      <ideas-filter id="filter" categories="{{categories}}" filter="{{filter}}" groupid="{{groupId}}" groupname="{{groupName}}"></ideas-filter>
                    </template>

                    <template is="dom-if" if="{{computeIf6(ideasFilter)}}">
                      <div>
                        <span>{{subTitle}}</span>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </paper-material>
          <paper-icon-button icon="search" class="fade-on-drawer-open" on-tap="toggleSearch"></paper-icon-button>

          <paper-icon-button icon="social:group-add" class="selected-items" on-tap="inviteUser"></paper-icon-button>

          <paper-menu-button class="selected-items" layout="" horizontal="">
            <paper-icon-button icon="more-vert" on-tap="openMenu"></paper-icon-button>
            <iron-dropdown class="dropdown" horizontal-align="right">
              <paper-item on-tap="openMenuItem">{{computeExpression1()}}</paper-item>
              <paper-item on-tap="openMenuItem">{{computeExpression2()}}</paper-item>
              <paper-item on-tap="openMenuItem">{{computeExpression3()}}</paper-item>
              <paper-item on-tap="openMenuItem">{{computeExpression4()}}</paper-item>
            </iron-dropdown>
          </paper-menu-button>
        </paper-toolbar>

        <template is="dom-if" if="{{computeIf7(needLogin, user)}}">
          <shadow></shadow>
        </template>

        <template is="dom-if" bind="" if="{{computeIf8(needLogin, user)}}">
          <div layout="" horizontal="" center-justified="">
            <paper-spinner id="spinner" style="padding-top:72px;"></paper-spinner>
          </div>
          <div class="content" style="margin-top:24px;">
            <content></content>
          </div>
        </template>
      </paper-scroll-header-panel>

    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
      is: 'base-layout',
      properties: {
        categories: { notify: true },
        category: { notify: true },
        filter: { notify: true },
        group: { value: null },
        groupId: { notify: true },
        groupName: { notify: true },
        idea: { notify: true },
        ideasFilter: { notify: true },
        name: { notify: true },
        needLogin: { notify: true },
        pageTitle: { notify: true },
        previousSearches: {
          type: Array,
          value: function () {
            return [
              'Blah',
              'Hello'
            ];
          }
        },
        selected: { notify: true },
        selectedThreads: {
          type: Array,
          value: function () {
            return [];
          }
        },
        showLogo: { notify: true },
        smallScreen: {
          type: Boolean,
          value: false
        },
        spinner: { notify: true },
        subTitle: { notify: true },
        user: { notify: true }
      },
      openMenu: function () {
        this.$.globals.activity('Anonymous', 'open', 'menu');
      },
      openMenuItem: function (item) {
        this.$.globals.activity('Anonymous', 'menu_open', item.srcElement.innerHTML);
        this.$.globals.openDialog(item.srcElement.innerHTML);
      },
      inviteUser: function () {
        this.$.globals.activity('Anonymous', 'invite', 'user');
        this.$.globals.openDialog('groups.invite');
      },
      goBack: function () {
        this.$.globals.activity('Anonymous', 'open', 'back', this.selected);
        if (this.selected == 'ideas') {
          window.location = '/';
        } else if (this.selected == 'ideas-search') {
          window.history.back();
        } else {
          window.location = '/#/groups/' + this.groupId + '/ideas/top/' + this.groupName;
        }
      },
      setSpinner: function (value) {
        this.$.spinner.active = value;
        if (value === true) {
          this.$.spinner.style.paddingTop = '72px';
        } else {
          this.$.spinner.style.paddingTop = '16px';
        }
      },
      toggleSearch: function (e) {
        this.$.search.toggle();
      },
      updateFilter: function () {
        this.$.filter.updateFilter();
      },
      checkForSmallScreen: function () {
        if (this.smallScreen === true) {
          this.titleStyle.fontSize = '24px';
        } else {
          this.titleStyle.fontSize = '40px';
        }
      },
      ready: function () {
        this.titleStyle = this.shadowRoot.querySelector('.title').style;
        this.checkForSmallScreen();
        window.onresize = function (event) {
          this.checkForSmallScreen();
        }.bind(this);
        var localTitleStyle = this.titleStyle;
        addEventListener('core-header-transform', function (e) {
          var d = e.detail;
          var m = 250 - d.condensedHeight;
          var scale = Math.max(0.15, (m - d.y) / (m / 0.25) + 0.75);
          localTitleStyle.transform = localTitleStyle.webkitTransform = 'scale(' + scale + ') translateZ(0)';
        });
      },
      extends: 'logged-in-page',
      computeIf: function (groupId) {
        return groupId == '474' || groupId == '368';
      },
      computeIf2: function (groupId) {
        return groupId == '28';
      },
      computeIf3: function (selected) {
        return selected != 'groups';
      },
      computeIf4: function (idea, selected) {
        return false && !idea && selected != 'ideas-search';
      },
      computeIf5: function (category, showLogo) {
        return !showLogo && category;
      },
      computeIf6: function (ideasFilter) {
        return !ideasFilter;
      },
      computeIf7: function (needLogin, user) {
        return needLogin && !user;
      },
      computeIf8: function (needLogin, user) {
        return !needLogin || user;
      },
      computeSrc: function () {
        return '/images/' + this.instanceLogoFilename('');
      },
      computeSrc2: function (category) {
        return 'https://s3.amazonaws.com/' + this.s3bucketName('') + '/categories/icons/000/000/' + this.padNumber(category.id) + '/icon_100/' + category.icon_file_name;
      },
      computeExpression1: function () {
        return this.t('menu.my_pages');
      },
      computeExpression2: function () {
        return this.t('menu.about');
      },
      computeExpression3: function () {
        return this.t('menu.help');
      },
      computeExpression4: function () {
        return this.t('menu.settings');
      }
    });
  </script>
</dom-module>
