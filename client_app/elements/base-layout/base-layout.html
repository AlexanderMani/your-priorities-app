<polymer-element name="base-layout" attributes="selected needLogin user pageTitle spinner idea groupId groupName showLogo categories showFilter name subTitle category" extends="logged-in-page">
  <template>

    <link rel="stylesheet" href="base-layout.css">
    <app-globals id="globals"></app-globals>

    <core-media-query query="max-width: 550px" queryMatches="{{smallScreen}}"></core-media-query>

    <material-search id="search" narrow="{{narrow}}"
                     previousSearches="{{previousSearches}}"></material-search>

    <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsiveWidth="2000px">

      <core-header-panel mode="scroll" drawer>
        <core-toolbar id="navheader" class="tall">
          <img class="middle profile" src="{{user.profile}}" hidden?="{{!user.profile}}">

          <div class="bottom" layout vertical>
            <span>Róbert Bjarnason</span>
            <span>50 samfélagsstig</span>
          </div>
        </core-toolbar>
        <core-menu selected="0" excludedLocalNames="div" on-core-select="{{menuSelect}}">
          <div class="separator" style="color:#F57C00">Betri Laugardalur 2015</div>
          <paper-item>
            <core-icon icon="av:news" style="padding-right:16px;"></core-icon>
            <template if="{{idea}}">
              <a href="/#/groups/{{idea.Group.id}}/ideas/{{idea.Group.name}}">
                Heim
              </a>
            </template>
            <template if="{{!idea}}">
              Heim
            </template>
          </paper-item>
          <paper-item>
            <core-icon icon="image:wb-sunny" style="padding-right:16px;"></core-icon>
            <template if="{{idea}}">
              <a href="/#/groups/{{idea.Group.id}}/ideas/{{idea.Group.name}}">
                Hugmyndir
              </a>
            </template>
            <template if="{{!idea}}">
              Hugmyndir
            </template>

          </paper-item>
          <paper-item>
            <core-icon icon="social:people" style="padding-right:16px;"></core-icon>
            Fólk
          </paper-item>
          <div class="separator" style="color:#FFB74D">{{'' | instanceName}}</div>
          <paper-item>
            <core-icon icon="group-work" style="padding-right:16px;"></core-icon>
            <a href="/">
              Hópar
            </a>
          </paper-item>

          <div class="separator">Þínar hugmyndir</div>
          <paper-item>1. Hugmynd</paper-item>
          <paper-item>2. Hugmynd</paper-item>
          <paper-item>3. Hugmynd</paper-item>
          <template repeat="{{l in labels}}">
            <paper-item label="{{l.name}}" icon="label" class="{{l.color}}"></paper-item>
          </template>
        </core-menu>
      </core-header-panel>

      <core-scroll-header-panel id="scrollheader" main condenses keepCondensedHeader on-trackstart="{{onRefreshStart}}"
                                on-tracky="{{onMainAreaTrack}}" on-trackend="{{onRefreshUp}}">
        <core-toolbar id="mainheader" class="tall">

          <template if="{{idea}}">
            <a href="/#/groups/{{idea.Group.id}}/ideas/{{idea.Group.name}}">
              <paper-icon-button icon="arrow-back" style="color:#fff;" on-tap="{{goBack}}"></paper-icon-button>
            </a>
          </template>
          <template if="{{!idea}}">
            <paper-icon-button id="navicon" icon="menu" core-drawer-toggle></paper-icon-button>
          </template>

          <div flex></div>
          <paper-shadow z="2" class="bottom indent title titleBottom">
            <div layout horizontal>

              <template if="{{showLogo}}">
                <div class="baseImageContainer">
                  <image sizing="cover" height="100" class="baseImage" src="/images/{{'' | instanceLogoFilename}}"></image>
                </div>
              </template>

              <template if="{{!showLogo && category}}">
                <div class="baseImageContainer">
                  <core-image sizing="contain"
                              preload
                              class="baseImage"
                              src="https://s3.amazonaws.com/{{'' | s3bucketName}}/categories/icons/000/000/{{category.id | padNumber}}/icon_100/{{category.icon_file_name}}">
                  </core-image>
                </div>
              </template>

              <div layout vertical>
                <div layout horizontal>
                  <div style="padding-right: 4px;padding-top:8px;margin-top:16px;vertical-align: top;text-align: start;">
                    {{name}}
                  </div>
                </div>

                <div style="font-size:16px;margin-bottom: 8px;padding-bottom:8px;padding-top:4px;padding-left:4px;">
                  <div layout horizontal>
                    <div>
                      {{subTitle}}
                    </div>
                    <div>
                      <template if="{{showFilter}}">
                        <paper-menu-button class="selected-items" layout horizontal style="padding-left:0px;padding-top: 0px;margin-top: -8px;">
                          <paper-icon-button class="filterIcon" icon="editor:merge-type"></paper-icon-button>
                          <paper-dropdown id="filterDropdown" class="dropdown" halign="left">
                            <div layout horizontal>
                              <div>
                                <core-selector on-core-select="{{ changeFilter }}">
                                  <paper-item data-filter="top">{{'ideas.top' | t}}</paper-item>
                                  <paper-item data-filter="newest">{{'ideas.newest' | t}}</paper-item>
                                  <paper-item data-filter="random">{{'ideas.random' | t}}</paper-item>
                                  <paper-item data-filter="inProgress">{{'ideas.inProgress' | t}}</paper-item>
                                </core-selector>
                              </div>
                              <template if="{{categories}}">
                                <div>
                                  <core-selector on-core-select="{{ changeCategory }}">
                                    <template repeat="{{category in categories}}">
                                      <paper-item data-category-id="{{category.id}}">{{category.name}}</paper-item>
                                    </template>
                                  </core-selector>
                                </div>
                              </template>
                            </div>
                          </paper-dropdown>
                        </paper-menu-button>
                      </template>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </paper-shadow>
          <paper-icon-button icon="search" class="fade-on-drawer-open" on-tap="{{toggleSearch}}"></paper-icon-button>

          <paper-icon-button icon="social:group-add" class="selected-items" on-tap="{{archiveAll}}"></paper-icon-button>

          <paper-menu-button class="selected-items" layout horizontal>
            <paper-icon-button icon="more-vert"></paper-icon-button>
            <paper-dropdown class="dropdown" halign="right">
              <paper-item>Mín síða</paper-item>
              <paper-item>Um þessa síðu</paper-item>
              <paper-item>Hjálp</paper-item>
              <paper-item>Stillingar</paper-item>
            </paper-dropdown>
          </paper-menu-button>
        </core-toolbar>

        <template if="{{needLogin && !user}}">
          <shadow></shadow>
        </template>

        <template bind if="{{!needLogin || user}}">
          <div layout horizontal center-justified>
            <paper-spinner id="spinner" style="padding-top:72px;"></paper-spinner>
          </div>
          <div class="content" style="margin-top:24px;">
            <content></content>
          </div>
        </template>
      </core-scroll-header-panel>

    </core-drawer-panel>
  </template>
  <script>
    Polymer({
      previousSearches: ["Blah", "Hello"],
      smallScreen: false,
      selectedThreads: [],
      group: null,

      changeFilter: function(e, detail) {
        window.selectedFilter = detail.item.dataset.filter;
        this.updateAfterFiltering();
      },

      changeCategory: function(e, detail) {
        var categoryId = detail.item.dataset.categoryId;
        if (categoryId!=-1) {
          window.categoryId = categoryId;
        } else {
          window.categoryId = null;
        }
        this.updateAfterFiltering();
      },

      updateAfterFiltering: function () {
        var newLocation = "/#/groups/"+this.groupId+"/ideas/"+window.selectedFilter+"/"+this.groupName;
        if (window.categoryId) {
          newLocation+="?categoryId="+window.categoryId;
        }
        window.location = newLocation;
      },

      setSpinner: function(value) {
        this.$.spinner.active = value;
        if (value===true) {
          this.$.spinner.style.paddingTop="72px";
        } else {
          this.$.spinner.style.paddingTop="16px";
        }
      },

      toggleSearch: function (e) {
        this.$.search.toggle();
      },

      domReady: function () {
        this.titleStyle = this.shadowRoot.querySelector('.title').style;
        this.checkForSmallScreen();

        window.onresize = function (event) {
          this.checkForSmallScreen();
        }.bind(this);

        var localTitleStyle = this.titleStyle;

        addEventListener('core-header-transform', function (e) {
          var d = e.detail;
          var m = 250 - d.condensedHeight;
          var scale = Math.max(0.15, (m - d.y) / (m / 0.25) + 0.75);
          localTitleStyle.transform = localTitleStyle.webkitTransform =
                  'scale(' + scale + ') translateZ(0)';
        });
      },

      checkForSmallScreen: function () {
        if (this.smallScreen === true) {
          this.titleStyle.fontSize = "24px";
        } else {
          this.titleStyle.fontSize = "40px";
        }
      }
    });
  </script>
</polymer-element>
