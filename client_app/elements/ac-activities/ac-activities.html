<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../with-in-viewport/with-in-viewport.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/yp-scroll-tab-behavior.html">
<link rel="import" href="../yp-behaviors/yp-logged-in-user-behavior.html">

<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-point/yp-point-news-story-edit.html">

<link rel="import" href="./ac-activity-header.html">
<link rel="import" href="./ac-activity-post.html">
<link rel="import" href="./ac-activity-point.html">
<link rel="import" href="./ac-activity-point-news-story.html">
<link rel="import" href="./ac-activity-post-status-update.html">
<link rel="import" href="./ac-activity-group.html">

<dom-module id="ac-activities">
  <template>
    <style>
      iron-list {
        padding-bottom: 4px;
        --iron-list-items-container: {
          max-width: 800px;
          margin: auto;
          margin-top: 16px;
          margin-bottom: 54px;
        };
      }

      .activity {
        margin-bottom: 24px;
        background-color: #FFF;
        width: 100%;
        height: 100%;
      }

      .container {
        position: relative;
      }

      #scrollableRegion {
        height: 100%;
        overflow: visible;
        padding-top: 24px;
        @apply(--layout-vertical);
      }

      .topHeader {
        background-color: var(--primary-color);
        color: #fff;
        padding-left: 16px;
      }

      ac-activity-header {
        padding-left: 16px;
      }

      .headerUserImage {
        padding-top: 16px;
        padding-bottom: 16px;
        padding-right: 8px;
      }

      h1 {
        font-size: 24px;
      }

      .userInfo {
        padding-right: 18px;
        text-align: right;
      }

      paper-button {
        color: var(--accent-color);
      }

      iron-icon {
        width: 48px;
        height: 48px;
        padding-top: 14px;
      }

      .headerText {
        padding-left: 8px;
      }

      .typeName {
        font-size: 30px;
        padding-top: 12px;
        padding-left: 4px;
      }

      .postName {
        font-size: 18px;
      }

      .bulb {
        width: 54px;
        height: 54px;
        padding-top: 10px;
        padding-left: 0;
        padding-right: 0;
      }

      .grayLine {
        background-color: #f0f0f0;
      }

      .thumbIconNewsFeed {
        height: 28px;
        width: 28px;
        padding-top: 2px;
        padding-left: 12px;
      }

      .participateButton {
        padding-top: 46px;
        padding-right: 4px;
      }

      .postPadding {
        padding-top: 28px;
      }

      .createdAt {
        color: #eee;
        font-size: 14px;
      }

      yp-ajax {
        background-color: #FFF !important;
      }
    </style>

    <template is="dom-if" if="[[loggedInUser]]">
      <div class="layout vertical center-center">
        <yp-point-news-story-edit domain-id="[[domainId]]"
                                  community-id="[[communityId]]"
                                  group-id="[[groupId]]"
                                  post-group-id="[[postGroupId]]"
                                  post-id="[[postId]]"
                                  on-refresh="loadNewData">
        </yp-point-news-story-edit>
      </div>
    </template>
    <div id="scrollableRegion">
      <iron-list id="list" items="[[activities]]" as="activity">
        <template>
          <div>
            <paper-material elevation="2" class="layout vertical activity" tabindex$="[[tabIndex]]">
              <div class="layout horizontal topHeader">
                <template is="dom-if" if="[[_isActivityType(activity,'activity.post.new')]]">
                  <iron-icon icon="icons:lightbulb-outline" class="stats-icon bulb"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isActivityType(activity,'activity.point.new')]]">
                  <iron-icon icon="communication:forum" class="stats-icon"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isActivityType(activity,'activity.point.newsStory.new')]]">
                  <iron-icon icon="face" class="stats-icon"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isActivityType(activity,'activity.post.status.change')]]">
                  <iron-icon icon="icons:language" class="stats-icon"></iron-icon>
                </template>
                <div class="layout vertical flex headerText">
                  <div class="layout horizontal typeName">
                    <div class="layout vertical">
                      <div>[[t(activity.type)]]</div>
                      <div class="createdAt" title="[[fromLongTime(activity.created_at)]]">
                        [[fromTime(activity.created_at)]]
                      </div>
                    </div>
                    <template is="dom-if" if="[[_isActivityType(activity,'activity.point.new')]]">
                      <iron-icon icon="thumb-down" class="thumbIconNewsFeed" hidden$="[[_upVote(activity.Point)]]"></iron-icon>
                      <iron-icon icon="thumb-up" class="thumbIconNewsFeed" hidden$="[[_downVote(activity.Point)]]"></iron-icon>
                    </template>
                  </div>
                </div>
                <ac-activity-header class="layout end-justified headerUserImage" activity="[[activity]]"></ac-activity-header>
              </div>
              <template is="dom-if" if="[[_isActivityType(activity,'activity.post.new')]]">
                <ac-activity-post activity="[[activity]]"></ac-activity-post>
              </template>

              <template is="dom-if" if="[[_isActivityType(activity,'activity.point.new')]]">
                <ac-activity-point activity="[[activity]]"></ac-activity-point>
              </template>

              <template is="dom-if" if="[[_isActivityType(activity,'activity.point.newsStory.new')]]">
                <ac-activity-point-news-story activity="[[activity]]"></ac-activity-point-news-story>
              </template>

              <template is="dom-if" if="[[_isActivityType(activity,'activity.post.status.change')]]">
                <ac-activity-post-status-update activity="[[activity]]"></ac-activity-post-status-update>
              </template>

              <div class="postPadding" hidden$="[[!postId]]">
              </div>
              <div class="layout horizontal" hidden$="[[postId]]">
                <template is="dom-if" if="[[activity.Group]]">
                  <ac-activity-group group="[[activity.Group]]"></ac-activity-group>
                </template>

                <template is="dom-if" if="[[activity.Post]]">
                  <div class="layout horizontal flex end-justified participateButton">
                    <paper-button data-args$="[[activity]]" on-tap="_joinPost">[[t('participate')]]</paper-button>
                  </div>
                </template>
              </div>
            </paper-material>
          </div>
        </template>
      </iron-list>

      <div class="layout horizontal center-center">
        <yp-ajax id="ajax" large-spinner on-response="_activitiesResponse"></yp-ajax>
        <template is="dom-if" if="[[moreToLoad]]" restamp>
          <paper-button data-args$="[[activity]]" on-tap="_loadMoreData" id="loadMoreButton">[[t('more')]]</paper-button>
        </template>
      </div>
    </div>
    <iron-signals on-iron-signal-logged-in="_userLoggedIn"></iron-signals>
  </template>

  <script>
    Polymer({

      defaultKeyActivities: ['activity.post.status.change', 'activity.post.officialStatus.successful',
        'activity.post.officialStatus.failed', 'activity.post.officialStatus.inProgress'],

      is: 'ac-activities',

      behaviors: [
        Polymer.appHelpers,
        Polymer.YpScrollTabBehavior,
        Polymer.ypLoggedInUserBehavior
      ],

      properties: {

        activities: {
          type: Array,
          notify: true
        },

        domainId: {
          type: Number,
          observer: "_domainIdChanged"
        },

        communityId: {
          type: Number,
          observer: "_communityIdChanged"
        },

        groupId: {
          type: Number,
          observer: "_groupIdChanged"
        },

        postId: {
          type: Number,
          observer: "_postIdChanged"
        },

        postGroupId: {
          type: Number
        },

        // 'activities' and 'news_feed'
        mode: {
          type: String,
          value: "activities"
        },

        url: {
          type: String
        },

        oldestProcessedActivityAt: {
          type: Date
        },

        latestProcessedActivityAt: {
          type: Date
        }
      },

      _upVote: function (point) {
        if (point && point.value == 0) {
          return true;
        } else if (!point) {
          return false;
        } else {
          return point.value > 0;
        }
      },

      _downVote: function (point) {
        if (point && point.value == 0) {
          return true;
        } else if (!point) {
          return false;
        } else {
          return point.value < 0;
        }
      },

      _joinPost: function (event) {
        if (event.model.activity.Post) {
          this.goToPost(event.model.activity.Post.id);
        } else if (event.model.activity.PostStatusChange) {
          this.goToPost(event.model.activity.PostStatusChange.post_id);
        }
      },

      _getActivityWithPostTitle: function (activity) {
        return this.t(activity.type) + ' ' + activity.Post.name;
      },

      _isNotActivityType(activity, type) {
        return activity.type!=type
      },

      _isActivityType(activity, type) {
        return activity.type==type
      },

      _generateRequest: function (typeId, type) {
        if (typeId) {
          this.set('activities', []);
          this.set('oldestProcessedActivityAt', null);

          //TODO: Test personalized news feeds better
          if (false && window.appUser && window.appUser.user) {
            this.mode = 'news_feeds';
          }
          this.set('url', '/api/'+this.mode+'/' + type + '/'+typeId);
          this.$.ajax.url = this.url;
          this.$.ajax.generateRequest();
        }
      },

      _loadMoreData: function () {
        if (this.url!='' && this.oldestProcessedActivityAt) {
          this.set('moreToLoad', false);
          this.$.ajax.url = this.url + '?beforeDate='+this.oldestProcessedActivityAt;
          this.$.ajax.generateRequest();
        }
      },

      loadNewData: function () {
        if (this.url!='' && this.latestProcessedActivityAt) {
          this.$.ajax.url = this.url + '?afterDate='+this.latestProcessedActivityAt;
          this.$.ajax.generateRequest();
        } else if (!this.latestProcessedActivityAt) {
          this.$.ajax.url = this.url;
          this.$.ajax.generateRequest();
        }
      },

      _domainIdChanged: function (newValue) {
        this._generateRequest(newValue, 'domains');
      },

      _communityIdChanged: function (newValue) {
        this._generateRequest(newValue, 'communities');
      },

      _groupIdChanged: function (newValue) {
        this._generateRequest(newValue, 'groups');
      },

      _postIdChanged: function (newValue) {
        this._generateRequest(newValue, 'posts');
      },

      _activitiesResponse: function (event, detail) {
        var activities = detail.response.activities;

        if (detail.response.oldestProcessedActivityAt) {
          this.set('oldestProcessedActivityAt', detail.response.oldestProcessedActivityAt);
        }

        activities.forEach(function(activity) {
          if (this.$.ajax.url.indexOf('afterDate') > -1) {
            this.unshift('activities', activity);
          } else {
            this.push('activities', activity);
          }
        }.bind(this));

        if (activities.length>0) {
          if (!this.latestProcessedActivityAt || this.latestProcessedActivityAt < activities[0].created_at) {
            this.set('latestProcessedActivityAt', activities[0].created_at);
          }
          this.setMoreToLoad();
        }

        this.$.list.fire('iron-resize');
        this.async(function () {
          this.$.list.fire('iron-resize');
        }, 750);
      }
    });
  </script>
</dom-module>
