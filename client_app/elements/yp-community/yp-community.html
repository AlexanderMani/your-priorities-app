<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-behaviors/collection-helpers.html">
<link rel="import" href="../yp-behaviors/yp-scroll-tab-behavior.html">
<link rel="import" href="../ac-activities/ac-activities.html">
<link rel="import" href="../yp-theme/yp-theme-behavior.html">

<link rel="import" href="../yp-post/yp-post.html">
<link rel="import" href="../yp-post/yp-post-map.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-group/yp-group-card.html">
<link rel="import" href="../yp-group/yp-group-edit.html">
<link rel="import" href="../yp-group/yp-group-card-add.html">
<link rel="import" href="../yp-page/yp-page.html">

<link rel="import" href="yp-community-edit.html">
<link rel="import" href="yp-community-large-card.html">

<dom-module id="yp-community">
  <template>
    <style>
      .card-container {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        width: 100%;
      }

      .card {
        padding: 16px;
      }

      yp-ajax {
        background-color: var(--primary-background-color);
      }

      .archivedText {
        font-size: 26px;
        color: #333;
      }
    </style>

    <yp-page id="page" create-fab-icon="social:group" create-fab-title="[[t('group.add')]]" on-yp-create-fab-tap="_newGroup">

      <yp-community-large-card id="communityCard" class="largeCard card" community="[[community]]" on-update-community="_refresh"></yp-community-large-card>

      <paper-tabs  id="paper_tabs" class="tabs" selected="{{selected}}" focused>
        <paper-tab class="tab"><span>[[t('groups')]]</span> &nbsp; (<span>[[groupsLength]]</span>)</paper-tab>
        <paper-tab class="tab">[[t('news')]]</paper-tab>
        <paper-tab class="tab">[[t('posts.map')]]</paper-tab>
      </paper-tabs>

      <iron-pages class="tabPages" selected="{{selected}}" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
        <section>
          <div class="layout horizontal center-center wrap">
            <div class="layout vertical wrap">
              <div class="layout horizontal center-center wrap">
                <template is="dom-repeat" class="list" items="[[featuredGroups]]" as="group">
                  <yp-group-card class="card" group="[[group]]" on-mouseover="cardMouseOver" on-mouseout="cardMouseOut"></yp-group-card>
                </template>
                <template is="dom-repeat" class="list" items="[[activeGroups]]" as="group">
                  <yp-group-card class="card" group="[[group]]" on-mouseover="cardMouseOver" on-mouseout="cardMouseOut"></yp-group-card>
                </template>
              </div>
              <div class="layout horizontal center-center">
                <h1 class="archivedText" hidden$="[[!archivedGroups]]">
                  [[t('archived')]]
                </h1>
              </div>
              <div class="layout horizontal center-center wrap">
                <template is="dom-repeat" class="list" items="[[archivedGroups]]" as="group">
                  <yp-group-card class="card" group="[[group]]" on-mouseover="cardMouseOver" on-mouseout="cardMouseOut"></yp-group-card>
                </template>
              </div>
            </div>
            <yp-group-card-add hidden$="[[hideAdd]]" class="card" on-tap="_newGroup" on-mouseover="cardMouseOver" on-mouseout="cardMouseOut"></yp-group-card-add>
          </div>
        </section>
        <section>
          <ac-activities community-id="[[community.id]]"></ac-activities>
        </section>
        <section>
          <template is="dom-if" if="[[mapActive]]" restamp>
            <yp-post-map community-id="[[community.id]]"></yp-post-map>
          </template>
        </section>
      </iron-pages>
    </yp-page>

    <yp-ajax id="ajax" url="/api/communities" on-response="_response"></yp-ajax>
    <yp-ajax id="pagesAjax" on-response="_pagesResponse"></yp-ajax>
  </template>

  <script>
    Polymer({

      is: 'yp-community',

      behaviors: [
        Polymer.appHelpers,
        Polymer.ypThemeBehavior,
        Polymer.CollectionHelpers
      ],

      properties: {
        activeGroups: {
          type: Array,
          notify: true
        },

        featuredGroups: {
          type: Array
        },

        archivedGroups: {
          type: Array
        },

        groupsLength: {
          type: Number
        },

        communityId: {
          type: Number,
          value: null,
          observer: "_communityIdChanged"
        },

        community: {
          type: Object
        },

        communityEmpty: {
          type: Boolean,
          value: false
        },

        hideAdd: {
          type: Boolean,
          value: true
        },

        selected: {
          type: Number,
          value: 0,
          observer: '_selectedChanged'
        },

        tabName: {
          type: String,
          value: null,
          observer: '_tabNameChanged'
        },

        mapActive: {
          type: Boolean,
          value: false
        }
      },

      _tabNameChanged: function (newValue) {
        if (newValue) {
          if (newValue=='groups') {
            this.set('selected', 0);
          } else if (newValue=='news') {
            this.set('selected', 1);
          } else if (newValue=='map') {
            this.set('selected', 2);
          }
        }
      },

      _selectedChanged: function (newValue) {
        if (this.community) {
          if (newValue == 0) {
            page("#!/community/" + this.community.id + '/groups');
          } else if (newValue == 1) {
            page("#!/community/" + this.community.id + '/news');
          } else if (newValue == 2) {
            page("#!/community/" + this.community.id + '/map');
          }
        }

        if (newValue == 2) {
          this.set('mapActive', true);
        } else {
          this.set('mapActive', false);
        }
      },

      _hideEdit: function () {
        if (!this.community)
          return true;

        if (!window.appUser.loggedIn())
          return true;

        return (window.appUser.user.id!=this.community.user_id);
      },

      _communityHeaderUrl: function (community) {
        return this.getImageFormatUrl(community.CommunityHeaderImages, 2);
      },

      _communityIdChanged: function (newValue, oldValue) {
        if (newValue) {
          this.set("community", null);
          this.set("featuredGroups",null);
          this.set("activeGroups",null);
          this.set("archivedGroups",null);
          this.$$('#ajax').url = '/api/communities/' + this.communityId;
          this.$$('#ajax').generateRequest();
          this.hideAdd = true;
        }
      },

      _newGroup: function () {
        window.appGlobals.activity('open', 'newGroup');
        var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("groupEdit");
        dialog.setup(null, true, null);
        dialog.open('new', { communityId: this.communityId });
      },

      _pagesResponse: function (event, detail) {
        this.fire('yp-set-pages', detail.response);
      },

      _response: function (event, detail, sender) {
        this.set('community', detail.response);
        this.$.pagesAjax.url = "/api/communities/"+this.community.id+"/pages";
        this.$.pagesAjax.generateRequest();
        if (this.community.CommunityHeaderImages && this.community.CommunityHeaderImages.length>0) {
          this.$.page.setupTopHeaderImage(this.community.CommunityHeaderImages);
        }

        var randomTheme = Math.floor(Math.random() * 3) + 1;
        //this.setTheme(randomTheme-1);

        var headerPanel = app.$.mainScrollHeaderPanel;
        var url = this._communityHeaderUrl(this.community);
        //headerPanel.style.background = "#f5f5f5 url('"+url+"') no-repeat center top";

        this.set('groupsLength', this.community.Groups.length);
        var splitGroups = this.splitByStatus(this.community.Groups);
        if (splitGroups.archived.length>0) {
          this.set('archivedGroups', splitGroups.archived);
        }
        this.set('featuredGroups', splitGroups.featured);
        this.set('activeGroups', splitGroups.active);

        Polymer.Base.async(function() {
          var communityCard = this.$$('#communityCard');
          if (communityCard) {
            communityCard.setElevation(5);
            communityCard.lowerCardLater();
          }
        },20);

        if (detail.response.Groups.length===0)
          this.communityEmpty = true;
        else
          this.communityEmpty = false;
        this.fire("change-header", { headerTitle: this.community.Domain.name,
                                     headerDescription: this.community.Domain.description,
                                     headerIcon: "group-work",
                                     backPath: "#!/domain/" + this.community.domain_id });
        if (this.activeGroups.length>0) {
          this.hideAdd = true;
        } else {
          this.hideAdd = false;
        }
      },

      defaultGroupFirst: function (items) {
        var filtered = [];
        var defaultGroup = null;
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (item.short_name != 'default') {
            filtered.push(item);
          } else {
            defaultGroup = item;
          }
        }
        filtered.unshift(defaultGroup);
        return filtered;
      },

      noTestGroup: function (items) {
        var filtered = [];
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (item.short_name != 'test' && item.short_name != 'ac-posts' && item.short_name != 'development' && item.short_name.indexOf('2012') == -1 && item.short_name.indexOf('2013') == -1) {
            filtered.push(item);
          }
        }
        return filtered;
      },

      _refresh: function () {
        this.$$('#ajax').generateRequest();
      },

      ready: function () {
      }

    });
  </script>
</dom-module>
