<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-idea/yp-idea.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-group/yp-group-card.html">
<link rel="import" href="../yp-group/yp-group-edit.html">

<link rel="import" href="yp-community-edit.html">

<dom-module id="yp-community">
  <template>
    <style>

      :host {
        @apply(--layout-horizontal);
      }

      .createGroup {
        background-color: --var(accent-color-darker,#f57c00);
        position: fixed;
        bottom:24px;
        right: 28px;
      }

      .card-container {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      yp-group-card {
        padding: 16px;
      }

    </style>

    <yp-ajax id="ajax" url="/api/communities" on-response="_response"></yp-ajax>

    <yp-group-edit new id="groupEdit" on-iron-form-response="_refresh"></yp-group-edit>

    <yp-community-edit new="false" id="communityEdit" community="{{community}}" on-iron-form-response="_refresh"></yp-community-edit>

    <div class="card-container">
      <div class="layout vertical">
        <div class="layout horizontal wrap">
          <template is="dom-if" if="[[groups]]">
            <h2 hidden$="[[communityNotEmpty]]">[[t('community.is.empty')]]</h2>
            <template is="dom-repeat" class="list" items="[[groups]]" as="group">
              <yp-group-card group="[[group]]" on-mouseover="_groupCardMouseOver" on-mouseout="_groupCardMouseOut"></yp-group-card>
            </template>
          </template>
        </div>
        <paper-fab mini icon="create" on-tap="_openEdit"></paper-fab>
      </div>
      <paper-fab icon="social:group" z="1" class="createGroup" title="[[t('group.add')]" on-tap="_newGroup"></paper-fab>
    </div>
  </template>

  <script>
    Polymer({

      is: 'yp-community',

      behaviors: [
        Polymer.appHelpers
      ],

      properties: {
        groups: {
          type: Array,
          value: []
        },

        communityId: {
          type: Number,
          value: null,
          observer: "_communityIdChanged"
        },

        community: {
          type: Object
        },

        communityNotEmpty: {
          type: Boolean,
          value: false
        }
      },

      _hideEdit: function () {
        debugger;
        if (!this.community)
          return true;

        if (!window.appUser.loggedIn())
          return true;

        return (window.appUser.user.id!=this.community.user_id);
      },

      _openEdit: function () {
        this.$.communityEdit.open('edit', {communityId: this.community.id });
      },

      _communityHeaderUrl: function (community) {
        if (community.CommunityHeaderImages && community.CommunityHeaderImages.length>0) {
          var formats = JSON.parse(community.CommunityHeaderImages[0].formats);
          if (formats && formats.length>0)
            return formats[2];
        } else {
          return "";
        }
      },

      _communityIdChanged: function (newValue, oldValue) {
        if (newValue) {
          this.set("groups",[]);
          this.$.ajax.url = '/api/communities/' + this.communityId;
          this.$.ajax.generateRequest();
        } else {
          this.communityNotEmpty = false;
        }
      },

      _newGroup: function () {
        window.appGlobals.activity('open', 'newGroup');
        this.$.groupEdit.open('new', {communityId: this.communityId});
      },

      _response: function (event, detail, sender) {
        this.set('community', detail.response);
        var headerPanel = app.$.mainScrollHeaderPanel;
        var url = this._communityHeaderUrl(this.community);
        headerPanel.style.background = "#f5f5f5 url('"+url+"') no-repeat center top";
        this.set("groups", this.community.Groups);
        if (this.community.Groups.length>0)
          this.communityNotEmpty = true;
        this.fire("change-header", { headerTitle: this.community.name,
                                     headerDescription: this.community.description });
      },

      defaultGroupFirst: function (items) {
        var filtered = [];
        var defaultGroup = null;
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (item.short_name != 'default') {
            filtered.push(item);
          } else {
            defaultGroup = item;
          }
        }
        filtered.unshift(defaultGroup);
        return filtered;
      },

      noTestGroup: function (items) {
        var filtered = [];
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (item.short_name != 'test' && item.short_name != 'ac-ideas' && item.short_name != 'development' && item.short_name.indexOf('2012') == -1 && item.short_name.indexOf('2013') == -1) {
            filtered.push(item);
          }
        }
        return filtered;
      },

      _groupCardMouseOver: function (event) {
        event.currentTarget.elevation = 5;
      },

      _groupCardMouseOut: function (event) {
        event.currentTarget.elevation = 1;
      },

      _refresh: function () {
        this.$.ajax.generateRequest();
      },

      ready: function () {
      }

    });
  </script>
</dom-module>
