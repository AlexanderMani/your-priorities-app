<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="../../bower_components/google-map/google-map.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="yp-idea-header.html">
<link rel="import" href="yp-idea-points.html">
<link rel="import" href="yp-idea-edit.html">

<dom-module id="yp-idea">
  <template>
    <style>
      :host {
      }

      .container {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        width: 961px;
        margin: auto;
        margin-top: -62px;
        padding-top: 0px;
      }

      @media (max-width: 961px) {
        .container {
          width: 600px;
        }
      }

      @media (max-width: 600px) {
        .container {
          width: 300px;
        }
      }

      .flex {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      yp-idea-points {
      }

      .ideaHeader {
        padding: 16px;
        padding-bottom: 0;
        margin-top: 32px;
        background-color: #fefefe;
      }

      .tabsMaterial {
        margin-top: 16px;
        min-height: 500px;
        background-color: #fefefe;
      }
    </style>

    <div class="container">

      <yp-ajax id="ajax" on-response="_response"></yp-ajax>

      <yp-idea-edit new="false" id="ideaEdit" method="[[method]]" idea="{{idea}}" on-iron-form-response="_refresh"></yp-idea-edit>

      <template is="dom-if" if="[[idea]]">

        <paper-material elevation="3" class="ideaHeader" animated>
          <yp-idea-header id="ideaHeader" idea="[[idea]]" showcategory="true"></yp-idea-header>
          <paper-fab mini icon="create" on-tap="_openEdit"></paper-fab>
        </paper-material>

        <paper-material elevation="2" class="ideaHeader tabsMaterial" animated>
          <paper-tabs selected="{{selected}}" id="paper_tabs" focused>
            <paper-tab><span>[[t('idea.tabs.debate')]]</span> &nbsp; (<span>[[idea.Points.length]]</span>)</paper-tab>
            <paper-tab>[[t('idea.tabs.news')]]</paper-tab>
            <paper-tab>[[t('idea.tabs.location')]]</paper-tab>
            <paper-tab>[[t('idea.tabs.photos')]]</paper-tab>
          </paper-tabs>

          <neon-animated-pages id="pages" class="flex" selected="[[selected]]" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">

            <yp-idea-points id="pointsSection" idea="[[idea]]"></yp-idea-points>

            <section></section>
            <section></section>
            <section></section>
          </neon-animated-pages>
        </paper-material>


      </template>
    </div>
  </template>

  <script>
    (function () {
      Polymer({

        is: 'yp-idea',

        behaviors: [
          Polymer.appHelpers
        ],

        properties: {

          ideaId: {
            type: Number,
            value: null,
            observer: "_ideaIdChanged"
          },

          idea: {
            type: Object,
            notify: true,
            observer: "_ideaChanged"
          },

          contactId: { notify: true },
          contacts: { notify: true },
          ideaName: { notify: true },

          selected: {
            type: Number,
            value: 0,
            observer: 'selectedChanged'
          }
        },

        listeners: {
          'new-user-endorsement': 'addEndorsement'
        },

        _refresh: function () {
          this.$.ajax.generateRequest();
        },

        _openEdit: function () {
          this.$.ideaEdit.open('edit', { ideaId: this.idea.id });
        },

        addEndorsement: function (event, detail) {
          this.$$("#ideaHeader").addEndorsement(detail);
        },

        _ideaChanged: function (newValue, oldValue) {
        },

        _ideaIdChanged: function (newValue, oldValue) {
          if (newValue) {
            this.set("idea.Points",null);
            this.set("idea",null);
            this.$.ajax.url = '/api/ideas/' + this.ideaId;
            this.$.ajax.generateRequest();
          } else {
            this.set("idea",null);
          }
        },

        _response: function (event, detail, sender) {
          this.set("idea", detail.response);
          if (this.idea.description === null) {
            this.idea.description = this.idea.Points[0].content;
            this.idea.Points.shift();
          }
          this.fire("change-header", { headerTitle: this.truncate(this.idea.name,45),
                                       headerDescription: this.truncate(this.idea.description,45) });
        },

        selectedChanged: function (selected, previous) {
          if (selected == 0)
            window.appGlobals.activity('open', 'pointsTab');
          else if (selected == 1)
            window.appGlobals.activity('open', 'newsfeedTab');
          else if (selected == 2)
            window.appGlobals.activity('open', 'photosTab');
          else if (selected == 3)
            window.appGlobals.activity('open', 'solutionsTab');
        },

        ready: function () {
        },

        computeUrl: function (idea_id) {
          return '/api/ideas/' + idea_id;
        },

        computeExpression8: function () {
          return this.t('idea.tabs.not_implemented');
        }
      });
    }());
  </script>
</dom-module>
