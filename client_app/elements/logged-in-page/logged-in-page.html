<dom-module id="logged-in-page">
  <template>

    <template is="dom-if" if="needLogin">
      <paper-button raised="" class="colored hover" on-tap="goAjax">Login</paper-button>

      <div id="spinner" style="display: none;">
        <paper-spinner active=""></paper-spinner>
      </div>

      <div class="container">
        <content select="[outro]"></content>
      </div>

      <br>

      <div id="results" class="resultsText"></div>
    </template>

    <iron-ajax auto="false" id="ajax" url="{{url}}" params="{{params}}" last-response="{{response}}" on-core-error="handleError" handle-as="json">
    </iron-ajax>

  </template>
  <script>
    Polymer({
      is: 'logged-in-page',
      properties: {
        needLogin: { notify: true },
        needlogin: {
          type: Boolean,
          value: false
        },
        response: { observer: 'responseChanged' },
        user: { notify: true }
      },
      ready: function () {
        this.url = '/api/user/:login_status';
        this.$.ajax.go();
        try {
          this.user = JSON.parse(localStorage.getItem('yrpri-user'));
        } catch (e) {
          this.user = null;
        }
        this.$.spinner.style.display = 'none';
        this.user = JSON.parse('{"name":"Example user", "id": "1", "isAdmin": true, "bearerToken": "0343dddsds4343"}');
        localStorage.setItem('osk-user', JSON.stringify(this.user));
      },
      handleError: function (e, detail) {
        console.log('Error for login_status');
      },
      goAjax: function (e, detail, sender) {
        this.$.spinner.style.display = 'block';
        this.$.ajax.go();
      },
      responseChanged: function (detail, e) {
        this.$.spinner.style.display = 'none';
        console.log('Response from login_status', detail);
        this.user = {
          name: detail.name,
          nationalId: detail.nationalId,
          role: detail.role,
          isAdmin: true
        };
        localStorage.setItem('yrpri-user', JSON.stringify(this.user));
      },
      logout: function () {
        localStorage.removeItem('yrpri-user');
        window.location.reload();
      }
    });
  </script>
</dom-module>
